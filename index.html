<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UBIQUE Admin App</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f8fafc; }
        
        /* ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; border-radius: 20px 20px 0 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #64748b; font-weight: 600; }
        .nav-active { color: #4f46e5; }
        
        /* ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .stu-card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #f1f5f9; }
        .input-style { width: 100%; border: 1px solid #e2e8f0; padding: 12px; border-radius: 12px; outline: none; transition: 0.3s; background: #fdfdfd; }
        .input-style:focus { border-color: #6366f1; background: white; }

        .btn-p { width: 45px; height: 45px; border-radius: 12px; border: 2px solid #22c55e; color: #22c55e; font-weight: 800; transition: 0.2s; }
        .btn-a { width: 45px; height: 45px; border-radius: 12px; border: 2px solid #ef4444; color: #ef4444; font-weight: 800; transition: 0.2s; }
        .active-p { background: #22c55e !important; color: white !important; transform: scale(0.9); }
        .active-a { background: #ef4444 !important; color: white !important; transform: scale(0.9); }
    </style>
</head>
<body class="pb-24">

    <div class="bg-indigo-700 text-white p-5 rounded-b-[30px] shadow-lg mb-6">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-black italic">UBIQUE</h1>
            <span class="bg-indigo-500 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">Admin Panel</span>
        </div>
    </div>

    <main class="px-4">
        
        <div id="dailySection">
            <div class="space-y-3 mb-6">
                <div class="flex gap-2">
                    <input type="text" id="searchName" oninput="loadStudents()" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="input-style flex-grow">
                    <input type="number" id="searchRoll" oninput="loadStudents()" placeholder="‡¶∞‡ßã‡¶≤" class="input-style w-24">
                </div>
                <select id="classFilter" onchange="loadStudents()" class="input-style font-bold text-indigo-700 dynamic-class-list"></select>
            </div>

            <div id="stuListBody">
                </div>
            
            <button onclick="submitFinalAttendance()" class="fixed bottom-24 right-4 bg-indigo-600 text-white p-4 rounded-2xl shadow-2xl font-bold flex items-center gap-2 z-50">
                <span>‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</span> ‚úÖ
            </button>
        </div>

        <div id="absentSection" class="hidden">
            <div class="bg-red-50 p-4 rounded-2xl border border-red-100 mb-4 text-center">
                <h2 class="font-bold text-red-600">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
                <select id="absentClassFilter" onchange="loadAbsentStudents()" class="mt-2 input-style text-sm dynamic-class-list"></select>
            </div>
            <div id="absentListGrid" class="space-y-3"></div>
        </div>

        <div id="settingsSection" class="hidden space-y-6">
            <div class="bg-white p-5 rounded-[25px] shadow-sm border">
                <h3 class="font-bold text-indigo-900 mb-4">‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <input type="hidden" id="editStuId">
                <div class="space-y-3">
                    <input type="text" id="stuName" placeholder="‡¶®‡¶æ‡¶Æ" class="input-style">
                    <input type="number" id="stuRoll" placeholder="‡¶∞‡ßã‡¶≤" class="input-style">
                    <select id="stuClass" class="input-style dynamic-class-list"></select>
                    <select id="stuBatch" class="input-style dynamic-batch-list"></select>
                    <input type="text" id="stuPhone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" class="input-style">
                    <button onclick="saveSingleStudent()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>
            <div class="p-4 bg-slate-100 rounded-2xl">
                <p class="text-[10px] text-center text-slate-500 font-bold uppercase tracking-widest">Database Settings & Batch Control</p>
            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <button onclick="switchTab('daily')" id="tabDaily" class="nav-item nav-active">
            <span class="text-xl">üìã</span>
            <span>‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ</span>
        </button>
        <button onclick="switchTab('absent')" id="tabAbsent" class="nav-item">
            <span class="text-xl">üìû</span>
            <span>‡¶ï‡¶≤</span>
        </button>
        <button onclick="switchTab('settings')" id="tabSettings" class="nav-item">
            <span class="text-xl">‚öôÔ∏è</span>
            <span>‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</span>
        </button>
    </nav>

    <script>
        const SUPABASE_URL = 'https://sfsrtozgfethgdfrmskk.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ds6DYMap76uRiquvQ9a0fQ_rctZqM61';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let attendanceData = {};

        async function init() {
            const { data } = await _supabase.from('academy_settings').select('*');
            if (data) {
                const classes = data.filter(i => i.type === 'class');
                const batches = data.filter(i => i.type === 'batch');
                const cOpts = '<option value="All">‡¶∏‡¶ï‡¶≤ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</option>' + classes.map(x => `<option value="${x.value}">${x.value}</option>`).join('');
                const bOpts = batches.map(x => `<option value="${x.value}">${x.value}</option>`).join('');
                document.querySelectorAll('.dynamic-class-list').forEach(el => el.innerHTML = cOpts);
                document.querySelectorAll('.dynamic-batch-list').forEach(el => el.innerHTML = bOpts);
            }
            loadStudents();
        }

        async function loadStudents() {
            const cls = document.getElementById('classFilter').value;
            const sName = document.getElementById('searchName').value.trim().toLowerCase();
            const sRoll = document.getElementById('searchRoll').value.trim();
            const container = document.getElementById('stuListBody');
            
            let query = _supabase.from('students').select('*');
            if (cls !== "All") query = query.eq('class', cls);
            const { data } = await query.order('roll_no', { ascending: true });
            
            if (data) {
                const filtered = data.filter(s => (sName==="" || s.name.toLowerCase().includes(sName)) && (sRoll==="" || s.roll_no.toString()===sRoll));
                container.innerHTML = filtered.map(s => `
                    <div class="stu-card flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-slate-800 text-[15px]">${s.name}</h4>
                            <p class="text-[10px] font-bold text-slate-400 uppercase mt-0.5">‡¶∞‡ßã‡¶≤: <span class="text-indigo-600">${s.roll_no}</span> | ${s.class}</p>
                            <div class="flex gap-4 mt-2">
                                <button onclick='startEdit(${JSON.stringify(s)})' class="text-indigo-400 text-[10px] font-bold">‚úé ‡¶è‡¶°‡¶ø‡¶ü</button>
                                <button onclick="deleteStudent('${s.id}')" class="text-red-300 text-[10px] font-bold">üóëÔ∏è ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="p-${s.id}" onclick="mark('${s.id}', 'Present')" class="btn-p">P</button>
                            <button id="a-${s.id}" onclick="mark('${s.id}', 'Absent')" class="btn-a">A</button>
                        </div>
                    </div>`).join('');
            }
        }

        function mark(id, status) {
            document.getElementById(`p-${id}`).className = status === 'Present' ? "btn-p active-p" : "btn-p";
            document.getElementById(`a-${id}`).className = status === 'Absent' ? "btn-a active-a" : "btn-a";
            attendanceData[id] = status;
        }

        async function submitFinalAttendance() {
            const records = Object.keys(attendanceData).map(id => ({ 
                student_id: parseInt(id), 
                status: attendanceData[id], 
                attendance_date: new Date().toISOString().split('T')[0] 
            }));
            if(records.length === 0) return alert("‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
            await _supabase.from('attendance').upsert(records);
            alert("‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ ‡¶∏‡¶´‡¶≤! ‚úÖ");
        }

        async function loadAbsentStudents() {
            const cls = document.getElementById('absentClassFilter').value;
            const date = new Date().toISOString().split('T')[0];
            const { data } = await _supabase.from('attendance').select('student_id, students!inner(*)').eq('attendance_date', date).eq('status', 'Absent');
            const grid = document.getElementById('absentListGrid');

            if (data) {
                const filtered = data.filter(r => cls === "All" || r.students.class === cls);
                grid.innerHTML = filtered.map(r => `
                    <div class="stu-card flex justify-between items-center border-l-4 border-l-red-500">
                        <div>
                            <h4 class="font-bold text-slate-800">${r.students.name}</h4>
                            <p class="text-[10px] text-slate-400 font-bold">‡¶∞‡ßã‡¶≤: ${r.students.roll_no} | ${r.students.class}</p>
                        </div>
                        <a href="tel:${r.students.phone}" class="bg-red-500 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-lg">üìû</a>
                    </div>`).join('');
            }
        }

        function switchTab(t) {
            ['daily', 'absent', 'settings'].forEach(id => {
                document.getElementById(id+'Section').classList.add('hidden');
                document.getElementById('tab'+id.charAt(0).toUpperCase()+id.slice(1)).classList.remove('nav-active');
            });
            document.getElementById(t+'Section').classList.remove('hidden');
            document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('nav-active');
            if(t === 'absent') loadAbsentStudents();
        }

        function startEdit(s) {
            switchTab('settings');
            document.getElementById('editStuId').value = s.id;
            document.getElementById('stuName').value = s.name;
            document.getElementById('stuRoll').value = s.roll_no;
            document.getElementById('stuClass').value = s.class;
            document.getElementById('stuBatch').value = s.batch;
            document.getElementById('stuPhone').value = s.phone;
        }

        async function deleteStudent(id) {
            if(confirm("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) {
                await _supabase.from('students').delete().eq('id', id);
                loadStudents();
            }
        }

        async function saveSingleStudent() {
            const id = document.getElementById('editStuId').value;
            const payload = { 
                name: document.getElementById('stuName').value, 
                roll_no: parseInt(document.getElementById('stuRoll').value), 
                class: document.getElementById('stuClass').value, 
                batch: document.getElementById('stuBatch').value, 
                phone: document.getElementById('stuPhone').value 
            };
            if(id) await _supabase.from('students').update(payload).eq('id', id);
            else await _supabase.from('students').insert([payload]);
            alert("‡¶∏‡¶´‡¶≤!"); switchTab('daily'); init();
        }

        window.onload = init;
    </script>
</body>
</html>
