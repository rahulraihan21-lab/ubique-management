<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>UBIQUE</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&family=Sora:wght@700;800&display=swap" rel="stylesheet">
<style>
:root{--g1:#6366f1;--g2:#8b5cf6;--teal:#14b8a6;--green:#10b981;--red:#f43f5e;--orange:#f97316;--amber:#f59e0b;--ink:#0f172a;--ink2:#1e293b;--muted:#64748b;--border:#e2e8f0;--bg:#f0f4ff;--gs:#d1fae5;--rs:#ffe4e6}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Hind Siliguri',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;padding-bottom:76px;-webkit-tap-highlight-color:transparent}
.hidden{display:none!important}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-thumb{background:#c7d2fe;border-radius:9px}
.card{background:#fff;border-radius:20px;box-shadow:0 2px 16px rgba(99,102,241,.08);border:1px solid #e8ecf8}
.inp{width:100%;padding:11px 14px;border-radius:13px;border:1.5px solid var(--border);background:#f8faff;font-family:'Hind Siliguri',sans-serif;font-size:.875rem;font-weight:500;color:var(--ink);outline:none;transition:.18s}
.inp:focus{border-color:var(--g1);background:#fff;box-shadow:0 0 0 3px rgba(99,102,241,.1)}
.inp::placeholder{color:#94a3b8}
textarea.inp{resize:none}
.btn{display:flex;align-items:center;justify-content:center;gap:7px;width:100%;padding:12px 18px;border-radius:13px;border:none;font-family:'Hind Siliguri',sans-serif;font-weight:700;font-size:.875rem;cursor:pointer;transition:transform .12s}
.btn:active{transform:scale(.96)}
.btn-p{background:linear-gradient(135deg,var(--g1),var(--g2));color:#fff;box-shadow:0 4px 14px rgba(99,102,241,.28)}
.btn-t{background:linear-gradient(135deg,var(--teal),#0891b2);color:#fff;box-shadow:0 4px 14px rgba(20,184,166,.28)}
.btn-g{background:linear-gradient(135deg,var(--green),#059669);color:#fff;box-shadow:0 4px 14px rgba(16,185,129,.28)}
.btn-o{background:linear-gradient(135deg,var(--orange),#ea580c);color:#fff}
.btn-ghost{background:#f1f5f9;color:var(--muted)}
.btn-red{background:var(--rs);color:var(--red)}
.btn-sm{width:auto;padding:9px 16px;font-size:.82rem}
.stitle{font-family:'Sora',sans-serif;font-size:.9rem;font-weight:700;color:var(--ink2);padding-bottom:11px;border-bottom:2px solid #e0e7ff;margin-bottom:15px}
.paid-b{background:var(--gs);color:#065f46;padding:3px 10px;border-radius:99px;font-size:.7rem;font-weight:700;display:inline-flex;align-items:center}
.due-b{background:var(--rs);color:#9f1239;padding:3px 10px;border-radius:99px;font-size:.7rem;font-weight:700;display:inline-flex;align-items:center}
.fee-due-tag{background:linear-gradient(135deg,#fff1f2,#ffe4e6);color:#be123c;padding:2px 7px;border-radius:6px;font-size:.58rem;font-weight:700;display:inline-flex;align-items:center;gap:2px;border:1px solid #fecdd3}
.fee-ok-tag{background:linear-gradient(135deg,#f0fdf4,#dcfce7);color:#065f46;padding:2px 7px;border-radius:6px;font-size:.58rem;font-weight:700;display:inline-flex;align-items:center;gap:2px;border:1px solid #bbf7d0}
.sc{border-radius:18px;padding:14px 12px;text-align:center}
.sc-b{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1.5px solid #bfdbfe}
.sc-g{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1.5px solid #bbf7d0}
.sc-r{background:linear-gradient(135deg,#fff1f2,#ffe4e6);border:1.5px solid #fecdd3}
.sr{background:#fff;border-radius:13px;padding:11px 13px;border:1.5px solid var(--border);display:flex;flex-direction:column;gap:7px;transition:border-color .15s}
.sr:hover{border-color:#c7d2fe}
.sr.hn{border-left:3px solid var(--orange)}
.sr-top{display:flex;align-items:center;justify-content:space-between;gap:9px}
.sr-bot{display:flex;align-items:center;justify-content:space-between;padding-top:5px;border-top:1px solid #f1f5f9}
.ab{width:33px;height:33px;border-radius:9px;border:1.5px solid;font-weight:700;font-size:.8rem;cursor:pointer;background:transparent;transition:all .12s;flex-shrink:0}
.ab:active{transform:scale(.87)}
.pb{border-color:var(--green);color:var(--green)}.pb.on{background:var(--green);color:#fff}
.xb{border-color:var(--red);color:var(--red)}.xb.on{background:var(--red);color:#fff}
.yb{border-color:var(--g2);color:var(--g2)}.yb.on{background:var(--g2);color:#fff}
.nb{border-color:var(--orange);color:var(--orange)}.nb.on{background:var(--orange);color:#fff}
.sk{background:linear-gradient(90deg,#e8ecf8 0%,#f5f7ff 50%,#e8ecf8 100%);background-size:200% 100%;animation:sk 1.4s infinite;border-radius:9px}
@keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
@keyframes fu{from{opacity:0;transform:translateY(9px)}to{opacity:1;transform:translateY(0)}}
.fi{animation:fu .24s ease both}
.rt{border-collapse:separate;border-spacing:0;width:100%}
.rt th,.rt td{padding:6px 8px;font-size:.72rem;white-space:nowrap;border-bottom:1px solid #e8ecf8}
.rt thead th{background:linear-gradient(90deg,var(--g1),var(--g2));color:#fff;font-weight:700}
.rt thead th:first-child{border-radius:10px 0 0 0}.rt thead th:last-child{border-radius:0 10px 0 0}
.pc{background:var(--gs);color:#065f46;font-weight:700;text-align:center}
.ac{background:var(--rs);color:#9f1239;font-weight:700;text-align:center}
.tc{background:#ede9fe;color:#5b21b6;font-weight:700;text-align:center}
/* LOGIN */
#lo{position:fixed;inset:0;z-index:9000;display:flex;align-items:center;justify-content:center;padding:16px;overflow-y:auto;background:linear-gradient(135deg,#0f172a,#1e1b4b,#0c1461)}
#lo::before{content:'';position:absolute;width:360px;height:360px;top:-80px;right:-60px;border-radius:50%;background:radial-gradient(circle,rgba(99,102,241,.4),transparent 70%);filter:blur(55px);animation:o1 8s ease-in-out infinite}
#lo::after{content:'';position:absolute;width:300px;height:300px;bottom:-50px;left:-40px;border-radius:50%;background:radial-gradient(circle,rgba(6,182,212,.35),transparent 70%);filter:blur(55px);animation:o2 10s ease-in-out infinite}
@keyframes o1{0%,100%{transform:translate(0,0)}50%{transform:translate(-25px,18px)}}
@keyframes o2{0%,100%{transform:translate(0,0)}50%{transform:translate(18px,-12px)}}
.lb{position:relative;z-index:1;width:100%;max-width:400px;background:rgba(255,255,255,.07);backdrop-filter:blur(24px);border:1px solid rgba(255,255,255,.14);border-radius:26px;padding:32px 26px 28px;box-shadow:0 28px 70px rgba(0,0,0,.4)}
.ll{font-family:'Sora',sans-serif;font-size:2.4rem;font-weight:800;letter-spacing:-2px;background:linear-gradient(135deg,#a5b4fc,#67e8f9,#c4b5fd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.rts{display:flex;gap:3px;background:rgba(255,255,255,.08);border-radius:11px;padding:3px}
.rtab{flex:1;padding:8px 5px;border-radius:9px;font-family:'Hind Siliguri',sans-serif;font-weight:700;font-size:.76rem;cursor:pointer;border:none;background:transparent;color:rgba(255,255,255,.5);transition:all .2s;text-align:center}
.rtab.sel{background:rgba(255,255,255,.17);color:#fff}
.li{width:100%;padding:11px 14px;border-radius:12px;border:1.5px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);font-family:'Hind Siliguri',sans-serif;font-size:.875rem;font-weight:500;color:#fff;outline:none;transition:.2s}
.li:focus{border-color:rgba(165,180,252,.5);background:rgba(255,255,255,.12)}
.li::placeholder{color:rgba(255,255,255,.28)}
.li option{background:#1e1b4b;color:#fff}
.pin{width:100%;padding:14px;border-radius:12px;border:1.5px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);text-align:center;font-size:1.7rem;font-weight:700;letter-spacing:9px;color:#c7d2fe;font-family:monospace;outline:none;transition:.2s}
.pin:focus{border-color:rgba(165,180,252,.5);background:rgba(255,255,255,.12)}
.lbtn{width:100%;padding:12px;border-radius:12px;border:none;cursor:pointer;font-family:'Hind Siliguri',sans-serif;font-weight:700;font-size:.88rem;color:#fff;transition:transform .12s}
.lbtn:active{transform:scale(.97)}
.la{background:linear-gradient(135deg,var(--g1),var(--g2));box-shadow:0 5px 16px rgba(99,102,241,.38)}
.lt{background:linear-gradient(135deg,var(--teal),#0891b2);box-shadow:0 5px 16px rgba(20,184,166,.38)}
.ls{background:linear-gradient(135deg,var(--green),#059669);box-shadow:0 5px 16px rgba(16,185,129,.38)}
/* Student/Teacher dashboards */
#sd{display:none;position:fixed;inset:0;z-index:10000;background:var(--bg);overflow-y:auto;padding-bottom:28px}
.sh{background:linear-gradient(135deg,var(--g1),var(--g2),#06b6d4);padding:28px 18px 22px;text-align:center;color:#fff;position:relative;overflow:hidden}
.sh::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='30' height='30' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='15' cy='15' r='1.5' fill='%23fff' fill-opacity='.05'/%3E%3C/svg%3E")}
.sav{width:64px;height:64px;border-radius:50%;background:rgba(255,255,255,.2);border:3px solid rgba(255,255,255,.35);display:flex;align-items:center;justify-content:center;font-size:1.7rem;margin:0 auto 9px;position:relative}
#td{display:none;position:fixed;inset:0;z-index:100;background:var(--bg);overflow-y:auto;padding-bottom:22px}
.thd{background:linear-gradient(135deg,var(--teal),#0891b2);padding:0 18px;position:sticky;top:0;z-index:50;box-shadow:0 4px 18px rgba(20,184,166,.28)}
.tt{flex:1;padding:8px 5px;border-radius:10px;font-family:'Hind Siliguri',sans-serif;font-weight:700;font-size:.72rem;cursor:pointer;border:none;background:rgba(255,255,255,.14);color:rgba(255,255,255,.82);transition:.18s;white-space:nowrap}
.tt.on{background:#fff;color:var(--teal)}
/* Admin header */
.ah{background:rgba(255,255,255,.9);backdrop-filter:blur(14px);border-bottom:1px solid rgba(99,102,241,.1);height:58px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;position:sticky;top:0;z-index:50;box-shadow:0 2px 10px rgba(99,102,241,.06)}
.al{font-family:'Sora',sans-serif;font-size:1.15rem;font-weight:800;background:linear-gradient(135deg,var(--g1),var(--g2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.dt{padding:6px 11px;border-radius:10px;font-weight:600;font-size:.7rem;color:var(--muted);cursor:pointer;border:none;background:transparent;font-family:'Hind Siliguri',sans-serif;white-space:nowrap;transition:.15s}
.dt:hover{background:#eff6ff;color:var(--g1)}
.dt.on{background:linear-gradient(135deg,var(--g1),var(--g2));color:#fff;box-shadow:0 3px 9px rgba(99,102,241,.28)}
/* Mobile nav - 5 main + More button */
.mn{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.95);backdrop-filter:blur(18px);border-top:1px solid rgba(99,102,241,.1);border-radius:20px 20px 0 0;padding:5px 2px env(safe-area-inset-bottom,8px);z-index:100;box-shadow:0 -5px 20px rgba(99,102,241,.08);display:none}
.mm-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 6px;border-radius:12px;background:#f8fafc;border:none;cursor:pointer;font-family:'Hind Siliguri',sans-serif;font-size:.68rem;font-weight:700;color:var(--ink2)}
.mm-btn span:first-child{font-size:1.3rem}
.mm-btn:active{background:#e0e7ff}
.mn-in{display:flex;justify-content:space-around}
.mt{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 8px;border-radius:12px;cursor:pointer;border:none;background:transparent;color:var(--muted);font-family:'Hind Siliguri',sans-serif;transition:.14s;position:relative}
.mt .i{font-size:1.15rem;line-height:1}.mt .l{font-size:.58rem;font-weight:700;white-space:nowrap}
.mt.on{color:var(--g1);background:#eff6ff}
@media(max-width:768px){.ah{display:none!important}.mn{display:block}body{padding-bottom:72px}}
/* More menu popup */
.more-menu{position:absolute;bottom:calc(100% + 8px);right:-10px;background:#fff;border-radius:16px;box-shadow:0 -8px 30px rgba(0,0,0,.15);border:1px solid #e0e7ff;padding:8px;min-width:180px;display:none;z-index:200}
.more-menu.show{display:block;animation:fu .2s ease}
.more-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:11px;cursor:pointer;border:none;background:transparent;width:100%;font-family:'Hind Siliguri',sans-serif;font-weight:600;font-size:.82rem;color:var(--ink2);transition:.12s;text-align:left}
.more-item:hover,.more-item:active{background:#eff6ff;color:var(--g1)}
.more-item.on{background:linear-gradient(135deg,var(--g1),var(--g2));color:#fff}
.more-item .mi{font-size:1rem;width:24px;text-align:center}
/* Modal */
.mb{position:fixed;inset:0;z-index:99999;background:rgba(15,23,42,.55);backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .22s}
.mb.open{opacity:1;pointer-events:all}.mb.open .ms{transform:translateY(0)}
.ms{background:#fff;border-radius:16px 16px 0 0;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;padding-bottom:env(safe-area-inset-bottom,14px);transform:translateY(32px);transition:transform .25s cubic-bezier(.22,1,.36,1);box-shadow:0 -8px 36px rgba(0,0,0,.14)}
.mb.open .ms{transform:translateY(0)}
.ni{background:linear-gradient(135deg,#eff6ff,#f0f9ff);border-left:4px solid var(--g1);border-radius:12px;padding:12px 14px;border:1px solid #bfdbfe}
.dg{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:900px){.dg{grid-template-columns:1fr 350px}#ec{position:sticky;top:78px;align-self:start}}
.marks-inp{width:58px;padding:7px 4px;border-radius:8px;border:1.5px solid var(--border);background:#f8faff;font-family:'Hind Siliguri',sans-serif;font-size:.8rem;font-weight:700;color:var(--ink);text-align:center;outline:none;transition:.18s}
.marks-inp:focus{border-color:var(--g1);box-shadow:0 0 0 3px rgba(99,102,241,.12)}
.exam-card{background:#fff;border-radius:14px;padding:14px;border:1.5px solid var(--border);transition:all .15s;cursor:pointer}
.exam-card:hover{border-color:#c7d2fe;box-shadow:0 4px 14px rgba(99,102,241,.1)}
.due-months-bar{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px}
.due-month-chip{background:#fff1f2;color:#be123c;padding:1px 6px;border-radius:5px;font-size:.55rem;font-weight:700;border:1px solid #fecdd3}
.paid-month-chip{background:#f0fdf4;color:#065f46;padding:1px 6px;border-radius:5px;font-size:.55rem;font-weight:700;border:1px solid #bbf7d0}
.sub-chip{display:inline-flex;align-items:center;gap:3px;background:#eff6ff;color:var(--g1);padding:4px 10px;border-radius:8px;font-size:.72rem;font-weight:700;border:1px solid #bfdbfe}
.sub-chip button{background:none;border:none;color:var(--red);cursor:pointer;font-weight:700;font-size:.8rem;padding:0 2px}
/* Print */
@media print{body,body *{visibility:hidden}#printArea,#printArea *{visibility:visible}#printArea{position:fixed;left:0;top:0;width:100%;height:auto;background:#fff;z-index:99999;padding:0;margin:0}@page{size:A4;margin:12mm 10mm}}
.print-sheet{font-family:'Hind Siliguri',sans-serif;max-width:210mm;margin:0 auto;padding:8mm;background:#fff;color:#000}
.print-sheet h1{font-family:'Sora',sans-serif;font-size:18pt;text-align:center;margin-bottom:2mm;color:#1e293b}
.print-sheet .subtitle{text-align:center;font-size:9pt;color:#64748b;margin-bottom:5mm;border-bottom:2px solid #6366f1;padding-bottom:3mm}
.print-sheet table{width:100%;border-collapse:collapse;margin-top:3mm;font-size:8pt}
.print-sheet table th{background:#6366f1;color:#fff;padding:5px 6px;text-align:center;font-weight:700;border:1px solid #4f46e5}
.print-sheet table td{padding:4px 6px;border:1px solid #e2e8f0;text-align:center}
.print-sheet table tr:nth-child(even) td{background:#f8fafc}
.print-sheet table .name-cell{text-align:left;font-weight:600;min-width:100px}
.print-sheet table .merit-1{background:#fef9c3!important;font-weight:700}
.print-sheet table .merit-2{background:#e0f2fe!important;font-weight:700}
.print-sheet table .merit-3{background:#fce7f3!important;font-weight:700}
.print-sheet .footer{margin-top:8mm;display:flex;justify-content:space-between;font-size:8pt;color:#64748b;border-top:1px solid #e2e8f0;padding-top:3mm}
.print-sheet .grade-box{margin-top:5mm;border:1px solid #e2e8f0;border-radius:4mm;padding:3mm;font-size:7.5pt;display:flex;gap:8mm;justify-content:center;flex-wrap:wrap}
.print-sheet .stamp-area{margin-top:10mm;display:flex;justify-content:space-around;font-size:8pt;color:#64748b}
.print-sheet .stamp-area div{text-align:center;min-width:35mm}
.print-sheet .stamp-area div span{display:block;margin-top:15mm;border-top:1px solid #000;padding-top:2mm}
.print-card{page-break-after:always;font-family:'Hind Siliguri',sans-serif;max-width:210mm;margin:0 auto;padding:10mm;background:#fff;color:#000}
.print-card:last-child{page-break-after:auto}
.print-card .header{text-align:center;border-bottom:3px double #6366f1;padding-bottom:4mm;margin-bottom:5mm}
.print-card .header h1{font-family:'Sora',sans-serif;font-size:16pt;color:#1e293b;margin-bottom:1mm}
.print-card .header p{font-size:9pt;color:#64748b}
.print-card .student-info{display:grid;grid-template-columns:1fr 1fr;gap:2mm 8mm;font-size:10pt;margin-bottom:5mm;padding:3mm;background:#f8faff;border-radius:3mm;border:1px solid #e0e7ff}
.print-card .student-info div{display:flex;gap:2mm}
.print-card .student-info .label{color:#64748b;font-weight:600;min-width:20mm}
.print-card .student-info .value{color:#1e293b;font-weight:700}
.print-card table{width:100%;border-collapse:collapse;font-size:9pt;margin-bottom:5mm}
.print-card table th{background:#6366f1;color:#fff;padding:6px 8px;font-weight:700;border:1px solid #4f46e5}
.print-card table td{padding:5px 8px;border:1px solid #e2e8f0}
.print-card .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:3mm;margin-bottom:5mm}
.print-card .summary div{text-align:center;padding:3mm;border-radius:3mm;border:1px solid #e2e8f0}
.print-card .summary .s-label{font-size:7pt;color:#64748b;text-transform:uppercase;font-weight:700}
.print-card .summary .s-value{font-size:14pt;font-weight:700;font-family:'Sora',sans-serif}
.print-card .stamp-area{margin-top:8mm;display:flex;justify-content:space-around;font-size:8pt;color:#64748b}
.print-card .stamp-area div{text-align:center;min-width:30mm}
.print-card .stamp-area div span{display:block;margin-top:15mm;border-top:1px solid #000;padding-top:2mm}
</style>
</head>
<body>
<div id="offlineBar" style="display:none;align-items:center;gap:8px;padding:9px 16px;font-size:.78rem;border-bottom:1.5px solid;position:sticky;top:0;z-index:999;font-family:inherit"></div>

<div id="printArea" class="hidden"></div>

<!-- LOGIN -->
<div id="lo">
  <div class="lb">
    <div style="text-align:center;margin-bottom:22px"><div class="ll">UBIQUE</div><p style="color:rgba(255,255,255,.35);font-size:.58rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;margin-top:3px">School Management System</p></div>
    <div id="ln" class="hidden" style="background:rgba(255,255,255,.07);border-left:3px solid #a5b4fc;border-radius:10px;padding:10px 12px;margin-bottom:16px"><p style="font-size:.57rem;font-weight:700;color:rgba(165,180,252,.75);text-transform:uppercase;letter-spacing:2px;margin-bottom:2px">ğŸ“¢ à¦¨à§‹à¦Ÿà¦¿à¦¸</p><div id="lnt" style="font-size:.83rem;font-weight:600;color:rgba(255,255,255,.82)"></div></div>
    <div class="rts" style="margin-bottom:16px"><button class="rtab sel" id="rA" onclick="selRole('a')">ğŸ” à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨</button><button class="rtab" id="rT" onclick="selRole('t')">ğŸ§‘â€ğŸ« à¦Ÿà¦¿à¦šà¦¾à¦°</button><button class="rtab" id="rS" onclick="selRole('s')">ğŸ‘¤ à¦¸à§à¦Ÿà§à¦¡à§‡à¦¨à§à¦Ÿ</button></div>
    <div id="pa" style="display:flex;flex-direction:column;gap:10px"><input type="password" id="aPass" class="pin" placeholder="â€¢ â€¢ â€¢ â€¢" onkeydown="if(event.key==='Enter')aLogin()"><button onclick="aLogin()" class="lbtn la">ğŸ” à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨ à¦ªà§à¦°à¦¬à§‡à¦¶</button></div>
    <div id="pt" class="hidden" style="display:flex;flex-direction:column;gap:10px"><input type="password" id="tPass" class="pin" placeholder="â€¢ â€¢ â€¢ â€¢" onkeydown="if(event.key==='Enter')tLogin()"><button onclick="tLogin()" class="lbtn lt">ğŸ§‘â€ğŸ« à¦Ÿà¦¿à¦šà¦¾à¦° à¦ªà§à¦°à¦¬à§‡à¦¶</button></div>
    <div id="ps" class="hidden" style="display:flex;flex-direction:column;gap:10px"><select id="sClass" class="li dynC"></select><div style="display:grid;grid-template-columns:1fr 1fr;gap:9px"><input type="number" id="sRoll" class="li" placeholder="à¦°à§‹à¦² à¦¨à¦®à§à¦¬à¦°"><input type="text" id="sPhone" class="li" placeholder="à¦«à§‹à¦¨ à¦¨à¦®à§à¦¬à¦°"></div><button onclick="sLogin()" class="lbtn ls">ğŸ‘¤ à¦²à¦—à¦‡à¦¨ à¦•à¦°à§à¦¨</button></div>
    <p id="lerr" class="hidden" style="color:#fca5a5;font-size:.82rem;font-weight:700;text-align:center;margin-top:11px"></p>
  </div>
</div>

<!-- STUDENT DASHBOARD -->
<div id="sd">
  <div class="sh"><div class="sav">ğŸ‘¤</div><h2 id="sdn" style="font-family:'Sora',sans-serif;font-size:1.2rem;font-weight:700;color:#fff;position:relative">...</h2><p id="sdi" style="color:rgba(255,255,255,.62);font-size:.72rem;font-weight:600;margin-top:3px;position:relative"></p><button onclick="logout()" style="margin-top:11px;background:rgba(255,255,255,.17);color:#fff;border:none;padding:6px 18px;border-radius:99px;font-family:'Hind Siliguri',sans-serif;font-weight:700;font-size:.76rem;cursor:pointer;position:relative">à¦²à¦—à¦†à¦‰à¦Ÿ ğŸšª</button></div>
  <div style="max-width:460px;margin:0 auto;padding:16px 15px;display:flex;flex-direction:column;gap:12px">
    <div id="spb" class="hidden card fi" style="padding:14px;border-left:4px solid var(--orange)"><p style="font-weight:700;color:var(--orange);font-size:.82rem;margin-bottom:4px">âš ï¸ à¦¶à¦¿à¦•à§à¦·à¦•à§‡à¦° à¦¨à§‹à¦Ÿ</p><p id="spt" style="font-size:.875rem;color:#92400e;font-weight:500;line-height:1.5"></p></div>
    <div id="shw" class="hidden card fi" style="padding:14px"></div>
    <div id="sFeeCard" class="hidden card fi" style="padding:14px"></div>
    <div class="card" style="padding:14px">
  <h3 class="stitle" style="margin-bottom:10px">ğŸ“… à¦¹à¦¾à¦œà¦¿à¦°à¦¾ à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ</h3>
  <div style="display:flex;gap:7px;margin-bottom:10px">
    <input type="month" id="sAttMo" class="inp" style="flex:1">
    <button onclick="loadStuAtt()" class="btn btn-p btn-sm">ğŸ”„</button>
  </div>
  <div id="sAttStat" class="hidden" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px"></div>
  <div id="sAttList" style="display:flex;flex-direction:column;gap:5px">
    <p style="text-align:center;color:var(--muted);font-size:.8rem;padding:12px">à¦®à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦²à§‹à¦¡ à¦•à¦°à§à¦¨</p>
  </div>
</div>
<div class="card" style="padding:17px"><h3 class="stitle">ğŸ† à¦ªà¦°à§€à¦•à§à¦·à¦¾à¦° à¦«à¦²à¦¾à¦«à¦²</h3><div id="stuExamList" style="display:flex;flex-direction:column;gap:9px"><div class="sk" style="height:50px;width:100%"></div></div></div>
    <div class="card" style="padding:17px">
      <h3 class="stitle">ğŸ¥ à¦…à¦¨à¦²à¦¾à¦‡à¦¨ à¦•à§à¦²à¦¾à¦¸</h3>
      <div id="sOcList" style="display:flex;flex-direction:column;gap:14px">
        <div class="sk" style="height:50px;width:100%"></div>
      </div>
    </div>
    <div class="card" style="padding:17px"><h3 class="stitle">ğŸ“¢ à¦¨à§‹à¦Ÿà¦¿à¦¸ à¦¬à§‹à¦°à§à¦¡</h3><div id="sntc" style="display:flex;flex-direction:column;gap:9px"><div class="sk" style="height:50px;width:100%"></div></div></div>
  </div>
</div>

<!-- TEACHER DASHBOARD -->
<div id="td">
  <div class="thd">
    <div style="display:flex;align-items:center;justify-content:space-between;height:56px"><div style="display:flex;align-items:center;gap:10px"><div style="width:30px;height:30px;border-radius:9px;background:rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;font-size:.95rem">ğŸ§‘â€ğŸ«</div><div><span style="font-family:'Sora',sans-serif;font-weight:700;font-size:.92rem;color:#fff">UBIQUE</span><p style="font-size:.56rem;font-weight:700;color:rgba(255,255,255,.48);text-transform:uppercase;letter-spacing:2px">à¦Ÿà¦¿à¦šà¦¾à¦°</p></div></div><button onclick="logout()" style="background:rgba(255,255,255,.17);color:#fff;border:none;padding:6px 13px;border-radius:10px;font-family:'Hind Siliguri',sans-serif;font-weight:700;font-size:.76rem;cursor:pointer">à¦²à¦—à¦†à¦‰à¦Ÿ</button></div>
    <div style="display:flex;gap:4px;padding:9px 0;border-top:1px solid rgba(255,255,255,.13);overflow-x:auto"><button onclick="tTab('ta')" id="tb-ta" class="tt on">ğŸ“‹ à¦¹à¦¾à¦œà¦¿à¦°à¦¾</button><button onclick="tTab('tp')" id="tb-tp" class="tt">âš ï¸ à¦¨à§‹à¦Ÿ</button><button onclick="tTab('te')" id="tb-te" class="tt">ğŸ† à¦ªà¦°à§€à¦•à§à¦·à¦¾</button><button onclick="tTab('tr')" id="tb-tr" class="tt">ğŸ“Š à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ</button></div>
  </div>
  <div style="max-width:640px;margin:0 auto;padding:16px 15px;display:flex;flex-direction:column;gap:14px">
    <div id="ta"><div class="card" style="padding:18px"><h2 class="stitle">ğŸ“‹ à¦¹à¦¾à¦œà¦¿à¦°à¦¾</h2><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:9px"><select id="tCl" onchange="loadTS()" class="inp dynC"></select><select id="tBt" onchange="loadTS()" class="inp dynB"></select></div><input type="text" id="tSr" oninput="loadTS()" placeholder="ğŸ” à¦¨à¦¾à¦®..." class="inp" style="margin-bottom:13px"><div id="tSL" style="display:flex;flex-direction:column;gap:7px;min-height:90px"></div><button onclick="subTAtt()" class="btn btn-t" style="margin-top:16px">âœ… à¦œà¦®à¦¾ à¦¦à¦¿à¦¨</button></div></div>
    <div id="tp" class="hidden"><div class="card" style="padding:18px"><h2 class="stitle">âš ï¸ à¦ªà§à¦°à¦¬à§à¦²à§‡à¦® à¦¨à§‹à¦Ÿ</h2><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:9px"><select id="tPCl" onchange="loadTP()" class="inp dynC"></select><select id="tPBt" onchange="loadTP()" class="inp dynB"></select></div><input type="text" id="tPSr" oninput="loadTP()" placeholder="ğŸ” à¦¨à¦¾à¦®..." class="inp" style="margin-bottom:13px"><div id="tPL" style="display:flex;flex-direction:column;gap:7px"></div></div></div>
    <div id="te" class="hidden"><div class="card" style="padding:18px"><h2 class="stitle">ğŸ† à¦¨à¦®à§à¦¬à¦° à¦¦à¦¿à¦¨</h2><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:9px"><select id="tExCl" onchange="loadTExams()" class="inp dynC"></select><select id="tExBt" onchange="loadTExams()" class="inp dynB"></select></div><div id="tExList" style="display:flex;flex-direction:column;gap:7px;margin-bottom:13px"></div><div id="tExEntry" class="hidden"><div style="background:#eff6ff;border-radius:13px;padding:13px;margin-bottom:13px;border:1.5px solid #bfdbfe"><h3 id="tExName" style="font-size:.92rem;font-weight:700;color:var(--g1)"></h3><p id="tExInfo" style="font-size:.68rem;color:var(--muted);margin-top:1px"></p></div><div id="tExStudents" style="display:flex;flex-direction:column;gap:6px"></div><button onclick="saveTExMarks()" class="btn btn-t" style="margin-top:14px">ğŸ’¾ à¦¸à§‡à¦­</button></div></div></div>
    <div id="tr" class="hidden"><div class="card" style="padding:18px"><h2 class="stitle">ğŸ“Š à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ</h2><div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:13px"><input type="month" id="tRMo" class="inp" style="width:auto;min-width:148px"><select id="tRCl" class="inp dynC" style="width:auto;min-width:108px"></select><select id="tRBt" class="inp dynB" style="width:auto;min-width:108px"></select><button onclick="loadTR()" class="btn btn-t btn-sm">ğŸ”„</button></div><div id="tRL" class="hidden"><div class="sk" style="height:28px;width:100%"></div></div><div style="overflow-x:auto;border-radius:11px;border:1px solid #e0e7ff"><table class="rt"><thead id="tRH"></thead><tbody id="tRB"></tbody></table></div><div id="tRS" class="hidden" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px"></div></div></div>
  </div>
</div>

<!-- ADMIN HEADER (Desktop) -->
<header class="ah">
  <div style="display:flex;align-items:center;gap:8px"><span class="al">UBIQUE</span><span style="background:#eff6ff;color:var(--g1);padding:2px 8px;border-radius:99px;font-size:.6rem;font-weight:700">Admin</span></div>
  <nav style="display:flex;gap:2px;overflow-x:auto">
    <button onclick="gTab('daily')" class="dt on" id="d-daily">ğŸ“‹ à¦¹à¦¾à¦œà¦¿à¦°à¦¾</button>
    <button onclick="gTab('fee')" class="dt" id="d-fee">ğŸ’° à¦«à¦¿</button>
    <button onclick="gTab('absent')" class="dt" id="d-absent">ğŸ“ à¦•à¦²</button>
    <button onclick="gTab('homework')" class="dt" id="d-homework">ğŸ“ HW</button>
    <button onclick="gTab('exam')" class="dt" id="d-exam">ğŸ† à¦ªà¦°à§€à¦•à§à¦·à¦¾</button>
    <button onclick="gTab('modeltest')" class="dt" id="d-modeltest">ğŸ“„ à¦®à¦¡à§‡à¦²</button>
    <button onclick="gTab('notice')" class="dt" id="d-notice">ğŸ“¢ à¦¨à§‹à¦Ÿà¦¿à¦¸</button>
    <button onclick="gTab('report')" class="dt" id="d-report">ğŸ“Š à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ</button>
    <button onclick="gTab('routine')" class="dt" id="d-routine">ğŸ—“ï¸ à¦°à§à¦Ÿà¦¿à¦¨</button>
    <button onclick="gTab('lectureplan')" class="dt" id="d-lectureplan">ğŸ“š à¦²à§‡à¦•à¦šà¦¾à¦°</button>
    <button onclick="gTab('enroll')" class="dt" id="d-enroll">ğŸ“¤ à¦¬à¦¾à¦²à§à¦• à¦­à¦°à§à¦¤à¦¿</button>
    <button onclick="gTab('expense');initExpenseTab()" class="dt" id="d-expense">ğŸ’¸ à¦–à¦°à¦š</button>
    
    <button onclick="gTab('dailytest')" class="dt" id="d-dailytest">ğŸ“ à¦¡à§‡à¦‡à¦²à¦¿ à¦Ÿà§‡à¦¸à§à¦Ÿ</button>
    <button onclick="gTab('online')" class="dt" id="d-online">ğŸ¥ à¦…à¦¨à¦²à¦¾à¦‡à¦¨ à¦•à§à¦²à¦¾à¦¸</button>
    <button onclick="gTab('settings')" class="dt" id="d-settings">âš™ï¸</button>
    <button onclick="logout()" class="dt" style="color:#ef4444">ğŸšª à¦²à¦—à¦†à¦‰à¦Ÿ</button>
  </nav>
</header>

<!-- ADMIN MAIN -->
<main id="am" style="display:none;max-width:1160px;margin:0 auto;padding:16px 15px">
  <div id="sb" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px">
    <div class="sc sc-b"><p style="font-size:.58rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:2px">à¦®à§‹à¦Ÿ</p><p id="cT" style="font-family:'Sora',sans-serif;font-size:1.9rem;font-weight:700;color:var(--g1)">0</p></div>
    <div class="sc sc-g"><p style="font-size:.58rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:2px">à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤</p><p id="cP" style="font-family:'Sora',sans-serif;font-size:1.9rem;font-weight:700;color:var(--green)">0</p></div>
    <div class="sc sc-r"><p style="font-size:.58rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:2px">à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤</p><p id="cA" style="font-family:'Sora',sans-serif;font-size:1.9rem;font-weight:700;color:var(--red)">0</p></div>
  </div>

  <!-- DAILY -->
  <section id="sec-daily"><div class="dg"><div class="card" style="padding:18px"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px"><div style="display:flex;align-items:center;gap:8px"><h2 style="font-family:'Sora',sans-serif;font-size:.9rem;font-weight:700;color:var(--ink2)">ğŸ“‹ à¦†à¦œà¦•à§‡à¦° à¦¹à¦¾à¦œà¦¿à¦°à¦¾</h2><button id="slToggle" onclick="toggleSL()" style="background:#f1f5f9;border:none;padding:3px 9px;border-radius:8px;font-size:.7rem;font-weight:700;color:var(--muted);cursor:pointer">â–² à¦²à§à¦•à¦¾à¦¨</button></div><button onclick="openEF()" style="background:linear-gradient(135deg,var(--g1),var(--g2));color:#fff;border:none;padding:7px 13px;border-radius:10px;font-family:'Hind Siliguri',sans-serif;font-weight:700;font-size:.76rem;cursor:pointer;box-shadow:0 3px 10px rgba(99,102,241,.28)">â• à¦¨à¦¤à§à¦¨ à¦­à¦°à§à¦¤à¦¿</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><select id="aCl" onchange="onAClChange()" class="inp dynC"></select><select id="aBt" onchange="loadS()" class="inp dynB"></select></div><div style="margin-bottom:13px"><input type="text" id="aSN" oninput="loadS()" placeholder="ğŸ” à¦¨à¦¾à¦® à¦¬à¦¾ à¦°à§‹à¦² à¦¨à¦®à§à¦¬à¦°..." class="inp" style="width:100%;box-sizing:border-box"></div><div id="slBody"><div id="SL" style="display:flex;flex-direction:column;gap:7px;min-height:80px"></div><div style="display:flex;gap:8px;margin-top:16px">
  <button onclick="subAtt()" class="btn btn-p" style="flex:1">âœ… à¦œà¦®à¦¾ à¦¦à¦¿à¦¨</button>
  <button onclick="openAttEdit()" class="btn btn-ghost" style="font-size:.75rem;padding:8px 12px">âœï¸ à¦¸à¦‚à¦¶à§‹à¦§à¦¨</button>
</div></div></div></div></section>

  <!-- FEE -->
  <section id="sec-fee" class="hidden"><div class="card" style="padding:18px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
  <h2 class="stitle" style="margin:0">ğŸ’° à¦«à¦¿ à¦•à¦¾à¦²à§‡à¦•à¦¶à¦¨</h2>
  <button onclick="printDueCards()" class="btn btn-ghost btn-sm">ğŸ–¨ï¸ à¦¬à¦•à§‡à¦¯à¦¼à¦¾ à¦•à¦¾à¦°à§à¦¡</button>
</div><div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px"><input id="fSearch" class="inp" placeholder="ğŸ” à¦¨à¦¾à¦® à¦¬à¦¾ à¦°à§‹à¦² à¦¨à¦®à§à¦¬à¦°..." oninput="loadFee()" style="flex:1;min-width:150px"><select id="fCl" onchange="loadFee()" class="inp dynC" style="width:auto;min-width:110px"></select><select id="fBt" onchange="loadFee()" class="inp dynB" style="width:auto;min-width:110px"></select><select id="fMo" onchange="loadFee()" class="inp"><option value="January">à¦œà¦¾à¦¨à§à¦¯à¦¼à¦¾à¦°à¦¿</option><option value="February">à¦«à§‡à¦¬à§à¦°à§à¦¯à¦¼à¦¾à¦°à¦¿</option><option value="March">à¦®à¦¾à¦°à§à¦š</option><option value="April">à¦à¦ªà§à¦°à¦¿à¦²</option><option value="May">à¦®à§‡</option><option value="June">à¦œà§à¦¨</option><option value="July">à¦œà§à¦²à¦¾à¦‡</option><option value="August">à¦†à¦—à¦¸à§à¦Ÿ</option><option value="September">à¦¸à§‡à¦ªà§à¦Ÿà§‡à¦®à§à¦¬à¦°</option><option value="October">à¦…à¦•à§à¦Ÿà§‹à¦¬à¦°</option><option value="November">à¦¨à¦­à§‡à¦®à§à¦¬à¦°</option><option value="December">à¦¡à¦¿à¦¸à§‡à¦®à§à¦¬à¦°</option></select></div><div id="fL"></div></div><div id="fF" class="hidden card" style="padding:17px;border:2px solid #c7d2fe;position:sticky;bottom:74px;z-index:50;margin-top:13px"><div style="display:flex;justify-content:space-between;margin-bottom:11px"><div><p style="font-size:.58rem;font-weight:700;color:var(--muted);text-transform:uppercase">à¦«à¦¿ à¦¨à§‡à¦“à¦¯à¦¼à¦¾ à¦¹à¦šà§à¦›à§‡</p><h3 id="fNm" style="font-size:.9rem;font-weight:700;color:var(--g1);margin-top:2px"></h3></div><button onclick="hide('fF')" style="width:27px;height:27px;border-radius:99px;background:#f1f5f9;border:none;cursor:pointer;color:var(--muted);font-weight:700">âœ•</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><input type="number" id="fAm" placeholder="à¦Ÿà¦¾à¦•à¦¾" class="inp" onkeydown="if(event.key==='Enter')subFee()"><input type="text" id="fMe" placeholder="à¦®à§‡à¦®à§‹" class="inp" onkeydown="if(event.key==='Enter')subFee()"></div><input type="text" id="fNo" placeholder="à¦¨à§‹à¦Ÿ" class="inp" style="margin-bottom:10px"><button onclick="subFee()" class="btn btn-p">âœ… à¦œà¦®à¦¾</button></div></section>

  <!-- ABSENT CALL -->
  <section id="sec-absent" class="hidden"><div class="card" style="padding:18px"><div style="display:flex;align-items:center;gap:10px;margin-bottom:13px"><div style="width:38px;height:38px;border-radius:11px;background:var(--rs);display:flex;align-items:center;justify-content:center;font-size:1rem">ğŸš¨</div><div><h2 style="font-family:'Sora',sans-serif;font-size:.92rem;font-weight:700;color:var(--red)">à¦†à¦œà¦•à§‡à¦° à¦•à¦² à¦²à¦¿à¦¸à§à¦Ÿ</h2><p style="font-size:.68rem;color:var(--muted)">à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤ à¦¶à¦¿à¦•à§à¦·à¦¾à¦°à§à¦¥à§€à¦¦à§‡à¦° à¦•à¦² à¦•à¦°à§à¦¨</p></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:13px"><select id="abCl" onchange="loadAb()" class="inp dynC"></select><select id="abBt" onchange="loadAb()" class="inp dynB"></select></div><div id="abL" style="display:grid;gap:8px;grid-template-columns:repeat(auto-fill,minmax(210px,1fr))"></div></div></section>

  <!-- HOMEWORK -->
  <section id="sec-homework" class="hidden"><div class="card" style="padding:18px"><h2 class="stitle">ğŸ“ à¦†à¦œà¦•à§‡à¦° HW à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ</h2><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:13px"><select id="hwCl" onchange="loadHW()" class="inp dynC"></select><select id="hwBt" onchange="loadHW()" class="inp dynB"></select></div><div id="hwL" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:8px"></div></div></section>

  <!-- EXAM -->
  <section id="sec-exam" class="hidden"><div style="display:flex;flex-direction:column;gap:16px"><div class="card" style="padding:18px"><h2 class="stitle">ğŸ† à¦ªà¦°à§€à¦•à§à¦·à¦¾ à¦¤à§ˆà¦°à¦¿ (à¦à¦•à¦• à¦¬à¦¿à¦·à¦¯à¦¼)</h2><div style="display:flex;flex-direction:column;gap:10px;max-width:520px"><input type="text" id="exName" placeholder="à¦ªà¦°à§€à¦•à§à¦·à¦¾à¦° à¦¨à¦¾à¦®" class="inp"><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px"><input type="date" id="exDate" class="inp"><select id="exCl" class="inp dynC"></select><select id="exBt" class="inp dynB"></select></div><input type="number" id="exTotal" class="inp" value="100" placeholder="à¦¸à¦°à§à¦¬à§‹à¦šà§à¦š à¦¨à¦®à§à¦¬à¦°"><button onclick="createExam()" class="btn btn-p">ğŸ“ à¦¤à§ˆà¦°à¦¿</button></div></div><div class="card" style="padding:18px"><h2 class="stitle">ğŸ“‹ à¦¨à¦®à§à¦¬à¦° à¦¦à¦¿à¦¨</h2><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:13px"><select id="exLCl" onchange="loadExams()" class="inp dynC"></select><select id="exLBt" onchange="loadExams()" class="inp dynB"></select></div><div id="examList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:16px"></div><div id="marksEntry" class="hidden"><div style="background:#f5f3ff;border-radius:15px;padding:15px;margin-bottom:14px;border:1.5px solid #ddd6fe"><h3 id="selExName" style="font-size:1rem;font-weight:700;color:var(--g2)"></h3><p id="selExInfo" style="font-size:.68rem;color:var(--muted);margin-top:1px"></p></div><div id="marksList" style="display:flex;flex-direction:column;gap:6px"></div><div style="display:flex;gap:8px;margin-top:14px"><button onclick="saveMarks()" class="btn btn-p" style="flex:1">ğŸ’¾ à¦¸à§‡à¦­</button><button onclick="printExamResult()" class="btn btn-g btn-sm">ğŸ–¨ï¸ à¦ªà§à¦°à¦¿à¦¨à§à¦Ÿ</button><button onclick="exportExamXls()" class="btn btn-o btn-sm">ğŸ“¥ Excel</button></div></div></div></div></section>

  <!-- MODEL TEST -->
  <section id="sec-modeltest" class="hidden"><div style="display:flex;flex-direction:column;gap:16px"><div class="card" style="padding:18px"><h2 class="stitle">ğŸ“„ à¦®à¦¡à§‡à¦² à¦Ÿà§‡à¦¸à§à¦Ÿ à¦¤à§ˆà¦°à¦¿ (à¦à¦•à¦¾à¦§à¦¿à¦• à¦¬à¦¿à¦·à¦¯à¦¼)</h2><div style="display:flex;flex-direction:column;gap:10px;max-width:580px"><input type="text" id="mtName" placeholder="à¦®à¦¡à§‡à¦² à¦Ÿà§‡à¦¸à§à¦Ÿà§‡à¦° à¦¨à¦¾à¦®" class="inp"><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px"><input type="date" id="mtDate" class="inp"><select id="mtCl" class="inp dynC"></select><select id="mtBt" class="inp dynB"></select></div><div style="border:1.5px solid #e0e7ff;border-radius:13px;padding:13px"><p style="font-size:.72rem;font-weight:700;color:var(--ink2);margin-bottom:8px">ğŸ“š à¦¬à¦¿à¦·à¦¯à¦¼ à¦¯à§‹à¦— à¦•à¦°à§à¦¨</p><div style="display:grid;grid-template-columns:1fr 80px auto;gap:6px;margin-bottom:10px"><input type="text" id="mtSubName" placeholder="à¦¬à¦¿à¦·à¦¯à¦¼à§‡à¦° à¦¨à¦¾à¦®" class="inp" style="padding:9px 12px"><input type="number" id="mtSubMax" placeholder="à¦¨à¦®à§à¦¬à¦°" class="inp" style="padding:9px 8px;text-align:center" value="100"><button onclick="addMTSubject()" style="background:linear-gradient(135deg,var(--g1),var(--g2));color:#fff;border:none;padding:0 14px;border-radius:11px;font-size:1.1rem;cursor:pointer;font-weight:700">+</button></div><div id="mtSubjects" style="display:flex;flex-wrap:wrap;gap:6px"></div></div><button onclick="createModelTest()" class="btn btn-p">ğŸ“„ à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨</button></div></div><div class="card" style="padding:18px"><h2 class="stitle">ğŸ“‹ à¦®à¦¡à§‡à¦² à¦Ÿà§‡à¦¸à§à¦Ÿ à¦¤à¦¾à¦²à¦¿à¦•à¦¾</h2><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:13px"><select id="mtLCl" onchange="loadModelTests()" class="inp dynC"></select><select id="mtLBt" onchange="loadModelTests()" class="inp dynB"></select></div><div id="mtList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-bottom:16px"></div><div id="mtEntry" class="hidden"><div style="background:linear-gradient(135deg,#fef3c7,#fef9c3);border-radius:15px;padding:15px;margin-bottom:14px;border:1.5px solid #fde68a"><h3 id="mtSelName" style="font-size:1rem;font-weight:700;color:#92400e"></h3><p id="mtSelInfo" style="font-size:.68rem;color:var(--muted);margin-top:1px"></p><div id="mtSelSubs" style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px"></div></div><div style="overflow-x:auto;border-radius:12px;border:1px solid #e0e7ff;margin-bottom:14px"><table class="rt" id="mtMarksTable"><thead id="mtMarksHead"></thead><tbody id="mtMarksBody"></tbody></table></div><div style="display:flex;gap:8px"><button onclick="saveMTMarks()" class="btn btn-p" style="flex:1">ğŸ’¾ à¦¸à§‡à¦­</button><button onclick="printMTResult()" class="btn btn-g btn-sm">ğŸ–¨ï¸ à¦ªà§à¦°à¦¿à¦¨à§à¦Ÿ</button><button onclick="printMTCards()" class="btn btn-o btn-sm">ğŸ´ à¦•à¦¾à¦°à§à¦¡</button></div></div></div><div class="card" style="padding:18px"><h2 class="stitle">ğŸ“Š à¦®à¦¡à§‡à¦² à¦Ÿà§‡à¦¸à§à¦Ÿ à¦«à¦²à¦¾à¦«à¦²</h2><select id="mtResSelect" onchange="loadMTResults()" class="inp" style="max-width:320px;margin-bottom:13px"><option value="">-- à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨ --</option></select><div id="mtResultStats" class="hidden" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px"></div><div style="overflow-x:auto;border-radius:12px;border:1px solid #e0e7ff"><table class="rt"><thead id="mtResHead"></thead><tbody id="mtResBody"></tbody></table></div></div></div></section>

  <!-- NOTICE -->
  <section id="sec-notice" class="hidden" style="padding:15px;display:flex;flex-direction:column;gap:14px">

    <!-- à¦¨à§‹à¦Ÿà¦¿à¦¸ à¦ªà§‹à¦¸à§à¦Ÿ -->
    <div class="card" style="padding:18px">
      <h2 class="stitle" style="margin-bottom:12px">ğŸ“¢ à¦¨à§‹à¦Ÿà¦¿à¦¸</h2>
      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px">
        <input type="text" id="nTi" placeholder="à¦¶à¦¿à¦°à§‹à¦¨à¦¾à¦®" class="inp">
        <textarea id="nBo" placeholder="à¦¬à¦¿à¦¸à§à¦¤à¦¾à¦°à¦¿à¦¤..." class="inp" style="height:96px"></textarea>
        <button onclick="postNotice()" class="btn btn-p">ğŸš€ à¦ªà¦¾à¦¬à¦²à¦¿à¦¶</button>
      </div>
      <div id="nL" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>

    <!-- Push à¦¨à§‹à¦Ÿà¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨ -->
    <div class="card" style="padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h2 class="stitle" style="margin:0">ğŸ”” Push à¦¨à§‹à¦Ÿà¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨</h2>
        <button onclick="testOneSignal()" class="btn btn-ghost btn-sm" style="font-size:.65rem">ğŸ” Test</button>
      </div>

      <div style="margin-bottom:12px">
        <p style="font-size:.75rem;font-weight:700;color:#4f46e5;margin-bottom:6px">ğŸ“Œ à¦•à¦¾à¦¦à§‡à¦° à¦ªà¦¾à¦ à¦¾à¦¬à§‡à¦¨?</p>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <button onclick="setNotifTarget('all')" id="ntAll" class="btn btn-p btn-sm">ğŸŒ à¦¸à¦¬à¦¾à¦‡à¦•à§‡</button>
          <button onclick="setNotifTarget('due')" id="ntDue" class="btn btn-ghost btn-sm">ğŸ’° à¦¬à¦•à§‡à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¦à§‡à¦°</button>
          <button onclick="setNotifTarget('class')" id="ntCls" class="btn btn-ghost btn-sm">ğŸ« à¦•à§à¦²à¦¾à¦¸/à¦¬à§à¦¯à¦¾à¦š</button>
        </div>
        <div id="ntClsFilter" class="hidden" style="display:flex;gap:7px;margin-top:8px;flex-wrap:wrap">
          <select id="ntCl" class="inp dynC" onchange="onNtClChange()" style="flex:1"></select>
          <select id="ntBt" class="inp dynB" style="flex:1"></select>
        </div>
      </div>

      <div style="margin-bottom:12px">
        <p style="font-size:.75rem;font-weight:700;color:#4f46e5;margin-bottom:6px">ğŸ“ à¦Ÿà§‡à¦®à¦ªà§à¦²à§‡à¦Ÿ</p>
        <div style="display:flex;flex-wrap:wrap;gap:5px">
          <button onclick="setNotifTemplate('fee')" class="btn btn-ghost btn-sm">ğŸ’° à¦«à¦¿ à¦¬à¦•à§‡à¦¯à¦¼à¦¾</button>
          <button onclick="setNotifTemplate('exam')" class="btn btn-ghost btn-sm">ğŸ“ à¦ªà¦°à§€à¦•à§à¦·à¦¾</button>
          <button onclick="setNotifTemplate('result')" class="btn btn-ghost btn-sm">ğŸ“Š à¦°à§‡à¦œà¦¾à¦²à§à¦Ÿ</button>
          <button onclick="setNotifTemplate('notice')" class="btn btn-ghost btn-sm">ğŸ“¢ à¦¨à§‹à¦Ÿà¦¿à¦¸</button>
          <button onclick="setNotifTemplate('holiday')" class="btn btn-ghost btn-sm">ğŸ–ï¸ à¦›à§à¦Ÿà¦¿</button>
          <button onclick="setNotifTemplate('absent')" class="btn btn-ghost btn-sm">âŒ à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤</button>
        </div>
      </div>

      <input id="ntTitle" class="inp" placeholder="à¦¨à§‹à¦Ÿà¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨à§‡à¦° à¦¶à¦¿à¦°à§‹à¦¨à¦¾à¦®" style="margin-bottom:8px;width:100%;box-sizing:border-box">

      <!-- Dynamic fee area -->
      <div id="ntDynArea" style="display:none;background:#fef9f0;border:1.5px solid #fed7aa;border-radius:10px;padding:10px;margin-bottom:8px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <input type="checkbox" id="ntDynChk" style="accent-color:#6366f1;width:16px;height:16px">
          <label for="ntDynChk" style="font-size:.72rem;font-weight:700;color:#9a3412">Dynamic â€” à¦ªà§à¦°à¦¤à§à¦¯à§‡à¦•à¦•à§‡ à¦†à¦²à¦¾à¦¦à¦¾ à¦¬à¦¾à¦°à§à¦¤à¦¾ (à¦¨à¦¾à¦®, à¦®à¦¾à¦¸ à¦‰à¦²à§à¦²à§‡à¦– à¦¸à¦¹)</label>
        </div>
        <button onclick="buildDueNotifications()" class="btn btn-ghost btn-sm" style="width:100%;margin-bottom:6px">ğŸ‘ï¸ à¦ªà§à¦°à¦¿à¦­à¦¿à¦‰ à¦¦à§‡à¦–à§à¦¨</button>
        <div id="ntDynamicPreview"></div>
      </div>

      <textarea id="ntMsg" class="inp" placeholder="à¦¬à¦¾à¦°à§à¦¤à¦¾ à¦²à¦¿à¦–à§à¦¨..." rows="3" style="width:100%;box-sizing:border-box;resize:vertical;margin-bottom:10px"></textarea>
      <button onclick="sendNotification()" class="btn btn-p" style="width:100%;padding:12px">ğŸš€ à¦ªà¦¾à¦ à¦¾à¦¨</button>
      <div id="ntStatus" style="margin-top:8px;font-size:.78rem;text-align:center"></div>
    </div>

    <!-- à¦‡à¦¤à¦¿à¦¹à¦¾à¦¸ -->
    <div class="card" style="padding:16px">
      <h2 class="stitle" style="margin-bottom:10px">ğŸ“‹ à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦¨à§‹à¦Ÿà¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨</h2>
      <div id="ntHistory"><p style="text-align:center;color:var(--muted);font-size:.78rem;padding:16px">à¦•à§‹à¦¨à§‹ à¦‡à¦¤à¦¿à¦¹à¦¾à¦¸ à¦¨à§‡à¦‡</p></div>
    </div>

  <!-- REPORT -->
  <section id="sec-report" class="hidden"><div><div class="card" style="padding:18px;margin-bottom:16px">
  <h2 class="stitle">ğŸ“… à¦¦à§ˆà¦¨à¦¿à¦• à¦¹à¦¾à¦œà¦¿à¦°à¦¾ à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ</h2>
  <div style="display:flex;flex-wrap:wrap;gap:7px;margin:12px 0">
    <input type="date" id="drDate" class="inp" style="width:auto;min-width:148px">
    <select id="drCl" class="inp dynC" style="width:auto;min-width:118px"></select>
    <select id="drBt" class="inp dynB" style="width:auto;min-width:118px"></select>
    <button onclick="loadDailyRep()" class="btn btn-p btn-sm">ğŸ”„ à¦²à§‹à¦¡</button>
    <button onclick="printDailyRep()" id="drPrint" class="btn btn-ghost btn-sm hidden">ğŸ–¨ï¸ à¦ªà§à¦°à¦¿à¦¨à§à¦Ÿ</button>
    <button onclick="exportDailyXls()" id="drXls" class="btn btn-g btn-sm hidden">ğŸ“¥ Excel</button>
  </div>
  <div id="drLd" class="hidden"><div class="sk" style="height:28px;width:100%"></div></div>
  <div style="overflow-x:auto;border-radius:12px;border:1px solid #e0e7ff">
    <table class="rt"><thead id="drH"></thead><tbody id="drB"></tbody></table>
  </div>
  <div id="drS" class="hidden" style="margin-top:14px;display:flex;flex-wrap:wrap;gap:8px"></div>
</div>
</div><div class="card" style="padding:18px"><h2 class="stitle">ğŸ“Š à¦®à¦¾à¦¸à¦¿à¦• à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ</h2><div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:16px"><input type="month" id="rMo" class="inp" style="width:auto;min-width:148px"><select id="rCl" class="inp dynC" style="width:auto;min-width:118px"></select><select id="rBt" class="inp dynB" style="width:auto;min-width:118px"></select><button onclick="loadRep()" class="btn btn-p btn-sm">ğŸ”„ à¦²à§‹à¦¡</button><button onclick="exportXls()" id="xBtn" class="btn btn-g btn-sm hidden">ğŸ“¥ Excel</button></div><div id="rLd" class="hidden"><div class="sk" style="height:28px;width:100%"></div></div><div style="overflow-x:auto;border-radius:12px;border:1px solid #e0e7ff"><table class="rt"><thead id="rH"></thead><tbody id="rB"></tbody></table></div><div id="rS" class="hidden" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:13px"></div></div></section>

  
  <!-- ROUTINE -->
  <section id="sec-routine" class="hidden" style="padding:15px;display:flex;flex-direction:column;gap:14px">

    <!-- Teacher Management -->
    <div class="card" style="padding:16px">
      <h2 class="stitle" style="margin-bottom:12px">ğŸ‘¨â€ğŸ« à¦¶à¦¿à¦•à§à¦·à¦• à¦¬à§à¦¯à¦¬à¦¸à§à¦¥à¦¾à¦ªà¦¨à¦¾</h2>
      <div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:7px">
        <input id="tchName" class="inp" placeholder="à¦¶à¦¿à¦•à§à¦·à¦•à§‡à¦° à¦¨à¦¾à¦®" style="flex:1;min-width:130px">
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:10px">
        <button onclick="saveTeacher()" class="btn btn-p btn-sm">â• à¦¯à§‹à¦— à¦•à¦°à§à¦¨</button>
      </div>
      <div id="tchList" style="display:flex;flex-direction:column;gap:6px;max-height:220px;overflow-y:auto"></div>
    </div>


    <!-- Routine Builder -->
    <div class="card" style="padding:16px">
      <h2 class="stitle" style="margin-bottom:12px">ğŸ“‹ à¦°à§à¦Ÿà¦¿à¦¨ à¦¬à¦¾à¦¨à¦¾à¦¨</h2>
      <div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:12px">
        <select id="rtCl" class="inp dynC" style="flex:1;min-width:100px" onchange="onRtClChange()"></select>
        <select id="rtBt" class="inp dynB" style="flex:1;min-width:100px" onchange="loadRoutineNew()"></select>
        <input id="rtRoom" class="inp" placeholder="à¦°à§à¦® à¦¨à¦‚ (à¦¯à§‡à¦®à¦¨: 104)" style="flex:1;min-width:90px">
      </div>
      <div id="rtGroups" style="display:flex;flex-direction:column;gap:10px;margin-bottom:10px">
        <p style="color:var(--muted);font-size:.75rem;text-align:center;padding:8px">â• à¦¨à¦¤à§à¦¨ Day Group à¦¯à§‹à¦— à¦•à¦°à§à¦¨</p>
      </div>
      <div style="display:flex;gap:7px;flex-wrap:wrap">
        <button onclick="addRtGroup()" class="btn btn-ghost btn-sm">â• à¦¨à¦¤à§à¦¨ Day Group</button>
        <button onclick="buildRtPreview()" class="btn btn-p btn-sm">ğŸ—ï¸ à¦ªà§à¦°à¦¿à¦­à¦¿à¦‰</button>
        <button onclick="saveRoutineNew()" class="btn btn-g btn-sm">ğŸ’¾ à¦¸à§‡à¦­</button>
        <button onclick="printRoutineNew()" id="rtPrint" class="btn btn-ghost btn-sm hidden">ğŸ–¨ï¸ à¦ªà§à¦°à¦¿à¦¨à§à¦Ÿ</button>
      </div>
      <div id="rtConflictBar" class="hidden" style="background:#fef2f2;border:1.5px solid #fecaca;border-radius:10px;padding:10px 14px;margin-top:10px;font-size:.78rem;color:#dc2626;font-weight:600"></div>
    </div>

    <!-- Routine Preview/Grid -->
    <div class="card" style="padding:16px">
      <div id="rtPreview" style="overflow-x:auto">
        <p style="text-align:center;color:var(--muted);padding:24px">à¦‰à¦ªà¦°à§‡ à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ Day Group à¦¯à§‹à¦— à¦•à¦°à§à¦¨</p>
      </div>
    </div>

  </section>

  <!-- LECTURE PLAN -->
  <section id="sec-lectureplan" class="hidden" style="padding:15px;display:flex;flex-direction:column;gap:16px">
    <div class="card" style="padding:18px">
      <h2 class="stitle">ğŸ“š à¦®à¦¾à¦¨à§à¦¥à¦²à¦¿ à¦²à§‡à¦•à¦šà¦¾à¦° à¦ªà§à¦²à§à¦¯à¦¾à¦¨</h2>
      <div style="display:flex;flex-wrap:wrap;gap:7px;margin:12px 0">
        <select id="lpCl" class="inp" style="width:auto;min-width:130px"></select>
        <input type="month" id="lpMo" class="inp" style="width:auto;min-width:148px">
        <button onclick="loadLP()" class="btn btn-p btn-sm">ğŸ”„ à¦²à§‹à¦¡</button>
        <button onclick="saveLP()" class="btn btn-g btn-sm">ğŸ’¾ à¦¸à§‡à¦­</button>
        <button onclick="printLP()" id="lpPrint" class="btn btn-ghost btn-sm hidden">ğŸ–¨ï¸ à¦ªà§à¦°à¦¿à¦¨à§à¦Ÿ</button>
      </div>
      <div id="lpContent" style="margin-top:6px">
        <p style="text-align:center;color:var(--muted);padding:20px">à¦•à§à¦²à¦¾à¦¸ à¦“ à¦®à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦²à§‹à¦¡ à¦•à¦°à§à¦¨</p>
      </div>
      <div id="lpAddArea" class="hidden" style="margin-top:14px;background:#f8faff;border-radius:14px;padding:14px;border:1px solid #e0e7ff">
        <p style="font-weight:700;font-size:.82rem;margin-bottom:10px">â• à¦¬à¦¿à¦·à¦¯à¦¼ à¦¯à§‹à¦— à¦•à¦°à§à¦¨</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="lpSubName" class="inp" placeholder="à¦¬à¦¿à¦·à¦¯à¦¼à§‡à¦° à¦¨à¦¾à¦® (à¦¯à§‡à¦®à¦¨: à¦—à¦£à¦¿à¦¤)" style="flex:1;min-width:140px">
          <input id="lpTeacher" class="inp" placeholder="à¦¶à¦¿à¦•à§à¦·à¦•à§‡à¦° à¦¨à¦¾à¦®" style="flex:1;min-width:140px">
          <button onclick="addLPSubject()" class="btn btn-p btn-sm">à¦¯à§‹à¦— à¦•à¦°à§à¦¨</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  

<section id="sec-dailytest" class="hidden">
  <div style="display:flex;flex-direction:column;gap:16px">

    <!-- Create Test -->
    <div class="card" style="padding:18px">
      <h2 class="stitle">ğŸ“ à¦¨à¦¤à§à¦¨ à¦¡à§‡à¦‡à¦²à¦¿ à¦Ÿà§‡à¦¸à§à¦Ÿ</h2>
      <div style="display:flex;flex-direction:column;gap:9px">
        <input type="text" id="dtName" class="inp" placeholder="à¦Ÿà§‡à¦¸à§à¦Ÿà§‡à¦° à¦¨à¦¾à¦® (à¦¯à§‡à¦®à¦¨: à¦…à¦§à§à¦¯à¦¾à¦¯à¦¼ à§§)">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input type="date" id="dtDate" class="inp">
          <input type="number" id="dtTotal" class="inp" placeholder="à¦¸à¦°à§à¦¬à§‹à¦šà§à¦š à¦¨à¦®à§à¦¬à¦°" value="100">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <select id="dtCl" class="inp dynC"></select>
          <select id="dtBt" class="inp dynB"></select>
        </div>
        <button onclick="createDailyTest()" class="btn btn-p">ğŸ“ à¦Ÿà§‡à¦¸à§à¦Ÿ à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨</button>
      </div>
    </div>

    <!-- Test List & Marks -->
    <div class="card" style="padding:18px">
      <h2 class="stitle" style="margin-bottom:12px">ğŸ“‹ à¦¨à¦®à§à¦¬à¦° à¦¦à¦¿à¦¨</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
        <select id="dtLCl" onchange="loadDailyTests()" class="inp dynC"></select>
        <select id="dtLBt" onchange="loadDailyTests()" class="inp dynB"></select>
      </div>
      <div id="dtList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:16px"></div>
      <div id="dtEntry" class="hidden">
        <div style="background:#f0fdf4;border-radius:13px;padding:13px;margin-bottom:13px;border:1.5px solid #bbf7d0">
          <h3 id="dtSelName" style="font-size:.92rem;font-weight:700;color:#065f46"></h3>
          <p id="dtSelInfo" style="font-size:.68rem;color:var(--muted);margin-top:1px"></p>
        </div>
        <div id="dtMarksList" style="display:flex;flex-direction:column;gap:6px"></div>
        <div style="display:flex;gap:8px;margin-top:14px">
          <button onclick="saveDTMarks()" class="btn btn-p" style="flex:1">ğŸ’¾ à¦¸à§‡à¦­</button>
          <button onclick="printDTResult()" class="btn btn-g btn-sm">ğŸ–¨ï¸ à¦ªà§à¦°à¦¿à¦¨à§à¦Ÿ</button>
        </div>
      </div>
    </div>

    <!-- Monthly Summary -->
    <div class="card" style="padding:18px">
      <h2 class="stitle" style="margin-bottom:12px">ğŸ“Š à¦®à¦¾à¦¸à¦¿à¦• à¦®à§‡à¦°à¦¿à¦Ÿ</h2>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px">
        <input type="month" id="dtMo" class="inp" style="flex:1;min-width:148px">
        <select id="dtSCl" class="inp dynC" style="flex:1;min-width:110px"></select>
        <select id="dtSBt" class="inp dynB" style="flex:1;min-width:110px"></select>
        <button onclick="loadDTSummary()" class="btn btn-p btn-sm">ğŸ”„ à¦²à§‹à¦¡</button>
        <button onclick="printDTSummary()" id="dtPrint" class="btn btn-ghost btn-sm hidden">ğŸ–¨ï¸ à¦ªà§à¦°à¦¿à¦¨à§à¦Ÿ</button>
      </div>
      <div id="dtSummary"></div>
    </div>

  </div>
</section>

<section id="sec-online" class="hidden">
  <div style="display:flex;flex-direction:column;gap:16px">

    <!-- Admin: Add Video -->
    <div id="ocAdmin" class="card" style="padding:18px">
      <h2 class="stitle">ğŸ¥ à¦¨à¦¤à§à¦¨ à¦•à§à¦²à¦¾à¦¸ à¦­à¦¿à¦¡à¦¿à¦“ à¦¯à§‹à¦— à¦•à¦°à§à¦¨</h2>
      <div style="display:flex;flex-direction:column;gap:9px">
        <input type="text" id="ocTitle" class="inp" placeholder="à¦­à¦¿à¦¡à¦¿à¦“à¦° à¦¶à¦¿à¦°à§‹à¦¨à¦¾à¦® (à¦¯à§‡à¦®à¦¨: à¦…à¦§à§à¦¯à¦¾à¦¯à¦¼ à§© - à¦¬à§€à¦œà¦—à¦£à¦¿à¦¤)">
        <textarea id="ocDesc" class="inp" rows="2" style="resize:none" placeholder="à¦¬à¦¿à¦¬à¦°à¦£ (à¦à¦šà§à¦›à¦¿à¦•)"></textarea>
        <input type="text" id="ocUrl" class="inp" placeholder="YouTube à¦¬à¦¾ Google Drive à¦²à¦¿à¦‚à¦•">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <select id="ocCl" class="inp dynC"></select>
          <select id="ocBt" class="inp dynB"></select>
        </div>
        <button onclick="saveOnlineClass()" class="btn btn-p">ğŸ’¾ à¦¸à§‡à¦­ à¦•à¦°à§à¦¨</button>
      </div>
    </div>

    <!-- Filter -->
    <div class="card" style="padding:18px">
      <h2 class="stitle" style="margin-bottom:12px">ğŸ“š à¦•à§à¦²à¦¾à¦¸ à¦­à¦¿à¦¡à¦¿à¦“</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">
        <select id="ocFCl" onchange="loadOnlineClasses()" class="inp dynC"></select>
        <select id="ocFBt" onchange="loadOnlineClasses()" class="inp dynB"></select>
      </div>
      <div id="ocList" style="display:flex;flex-direction:column;gap:16px"></div>
    </div>

  </div>
</section>

<section id="sec-settings" class="hidden"><div style="display:flex;flex-direction:column;gap:16px"><div class="card" style="padding:17px">
  <h3 class="stitle" style="margin-bottom:12px">ğŸ” à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨ PIN</h3>
  <p style="font-size:.72rem;color:var(--muted);margin-bottom:10px">à¦à¦¡à¦¿à¦Ÿ à¦“ à¦¡à¦¿à¦²à¦¿à¦Ÿ à¦¸à§à¦°à¦•à§à¦·à¦¾à¦¯à¦¼ PIN à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦¹à¦¯à¦¼</p>
  <p style="font-size:.75rem;color:var(--muted);background:#f8faff;padding:10px 12px;border-radius:10px;border:1px solid #e0e7ff">ğŸ”‘ PIN à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦•à¦°à¦¤à§‡ <strong>Supabase â†’ academy_settings</strong> table à¦ <strong>admin_pin</strong> row à¦à¦° value à¦¬à¦¦à¦²à¦¾à¦¨à¥¤</p>
</div>
<div class="card" style="padding:17px"><button onclick="logout()" class="btn btn-red">ğŸšª à¦²à¦—à¦†à¦‰à¦Ÿ</button></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px"><div class="card" style="padding:17px"><h3 class="stitle">ğŸ« à¦•à§à¦²à¦¾à¦¸</h3><div style="display:flex;gap:6px;margin-bottom:11px"><input type="text" id="nCl" class="inp" placeholder="à¦¨à¦¤à§à¦¨ à¦•à§à¦²à¦¾à¦¸..."><button onclick="addSet('class')" style="flex-shrink:0;background:linear-gradient(135deg,var(--g1),var(--g2));color:#fff;border:none;padding:0 13px;border-radius:11px;font-size:1.1rem;cursor:pointer;font-weight:700">+</button></div><ul id="clL" style="display:flex;flex-direction:column;gap:6px"></ul></div><div class="card" style="padding:17px"><h3 class="stitle">ğŸ“¦ à¦¬à§à¦¯à¦¾à¦š</h3><div style="display:flex;gap:6px;margin-bottom:11px"><input type="text" id="nBt" class="inp" placeholder="à¦¨à¦¤à§à¦¨ à¦¬à§à¦¯à¦¾à¦š..."><button onclick="addSet('batch')" style="flex-shrink:0;background:linear-gradient(135deg,var(--g1),var(--g2));color:#fff;border:none;padding:0 13px;border-radius:11px;font-size:1.1rem;cursor:pointer;font-weight:700">+</button></div><ul id="btL" style="display:flex;flex-direction:column;gap:6px"></ul></div></div><div class="card" style="padding:17px"><h3 class="stitle">ğŸ‘¥ à¦¶à¦¿à¦•à§à¦·à¦¾à¦°à§à¦¥à§€</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px"><select id="sCl" onchange="loadSetS()" class="inp dynC"></select><select id="sBt" onchange="loadSetS()" class="inp dynB"></select></div><input id="setSearch" class="inp" placeholder="ğŸ” à¦¨à¦¾à¦® à¦¬à¦¾ à¦°à§‹à¦² à¦¨à¦®à§à¦¬à¦°..." oninput="filterSetS()" style="margin-bottom:10px;width:100%;box-sizing:border-box">
<div id="setL" style="display:flex;flex-direction:column;gap:6px"></div></div></div></section>

  <!-- ENROLL SECTION -->
  <section id="sec-enroll" class="hidden">
    <div style="display:flex;flex-direction:column;gap:16px">

      

      <!-- Bulk Upload Card -->
      <div class="card" style="padding:18px">
        <h2 class="stitle">ğŸ“¤ à¦¬à¦¾à¦²à§à¦• à¦†à¦ªà¦²à§‹à¦¡ (Excel/CSV)</h2>
        <p style="font-size:.72rem;color:var(--muted);margin:8px 0 14px">Excel à¦¬à¦¾ CSV à¦«à¦¾à¦‡à¦²à§‡ à¦•à¦²à¦¾à¦® à¦¥à¦¾à¦•à¦¤à§‡ à¦¹à¦¬à§‡: <strong>name, roll_no, class, batch, phone</strong></p>

        <!-- Download Template -->
        <button onclick="dlTemplate()" class="btn btn-ghost" style="margin-bottom:12px;font-size:.78rem">â¬‡ï¸ Template à¦¡à¦¾à¦‰à¦¨à¦²à§‹à¦¡ à¦•à¦°à§à¦¨</button>

        <!-- File Upload -->
        <div id="dropZone" onclick="document.getElementById('bulkFile').click()" style="border:2px dashed #c7d2fe;border-radius:14px;padding:28px 16px;text-align:center;cursor:pointer;background:#f8faff;transition:all .2s">
          <p style="font-size:2rem;margin-bottom:6px">ğŸ“‚</p>
          <p style="font-weight:700;color:var(--g1);font-size:.85rem">à¦«à¦¾à¦‡à¦² à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨ à¦¬à¦¾ à¦à¦–à¦¾à¦¨à§‡ à¦Ÿà§‡à¦¨à§‡ à¦†à¦¨à§à¦¨</p>
          <p style="font-size:.7rem;color:var(--muted);margin-top:4px">.xlsx, .xls, .csv à¦¸à¦¾à¦ªà§‹à¦°à§à¦Ÿà§‡à¦¡</p>
          <input type="file" id="bulkFile" accept=".xlsx,.xls,.csv" style="display:none" onchange="parseBulkFile(this)">
        </div>

        <!-- Preview Table -->
        <div id="bulkPreview" style="display:none;margin-top:14px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
            <p id="bulkCount" style="font-size:.78rem;font-weight:700;color:var(--g1)"></p>
            <button onclick="clearBulk()" style="font-size:.7rem;color:var(--muted);background:none;border:none;cursor:pointer">âœ– à¦¬à¦¾à¦¤à¦¿à¦²</button>
          </div>
          <div style="overflow-x:auto;border-radius:10px;border:1px solid #e0e7ff">
            <table style="width:100%;border-collapse:collapse;font-size:.75rem">
              <thead>
                <tr style="background:linear-gradient(135deg,var(--g1),var(--g2));color:#fff">
                  <th style="padding:8px 10px;text-align:left">à¦¨à¦¾à¦®</th>
                  <th style="padding:8px 10px;text-align:left">à¦°à§‹à¦²</th>
                  <th style="padding:8px 10px;text-align:left">à¦•à§à¦²à¦¾à¦¸</th>
                  <th style="padding:8px 10px;text-align:left">à¦¬à§à¦¯à¦¾à¦š</th>
                  <th style="padding:8px 10px;text-align:left">à¦«à§‹à¦¨</th>
                  <th style="padding:8px 10px;text-align:left">à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸</th>
                </tr>
              </thead>
              <tbody id="bulkTbody"></tbody>
            </table>
          </div>
          <button onclick="submitBulk()" id="bulkSubmitBtn" class="btn btn-p" style="margin-top:12px;width:100%">âœ… à¦¸à¦¬à¦¾à¦‡à¦•à§‡ à¦­à¦°à§à¦¤à¦¿ à¦•à¦°à§à¦¨</button>
        </div>
      </div>

    </div>
  </section>

<section id="sec-expense" class="hidden">
  <div style="display:flex;flex-direction:column;gap:16px">
    <!-- Add Expense Card -->
    <div class="card" style="padding:18px">
      <h2 class="stitle" style="margin-bottom:14px">ğŸ’¸ à¦¨à¦¤à§à¦¨ à¦–à¦°à¦š à¦à¦¨à§à¦Ÿà§à¦°à¦¿</h2>
      <div style="display:flex;flex-direction:column;gap:9px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input type="date" id="exDate" class="inp">
          <input type="number" id="exAmt" class="inp" placeholder="ğŸ’µ à¦ªà¦°à¦¿à¦®à¦¾à¦£ (à¦Ÿà¦¾à¦•à¦¾)">
        </div>
        <select id="exCat" class="inp">
          <option value="">-- à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨ --</option>
          <option value="à¦¬à§‡à¦¤à¦¨">ğŸ‘¨â€ğŸ« à¦¬à§‡à¦¤à¦¨</option>
          <option value="à¦­à¦¾à¦¡à¦¼à¦¾">ğŸ  à¦­à¦¾à¦¡à¦¼à¦¾</option>
          <option value="à¦¬à¦¿à¦¦à§à¦¯à§à§">ğŸ’¡ à¦¬à¦¿à¦¦à§à¦¯à§à§</option>
          <option value="à¦¸à§à¦Ÿà§‡à¦¶à¦¨à¦¾à¦°à¦¿">ğŸ“ à¦¸à§à¦Ÿà§‡à¦¶à¦¨à¦¾à¦°à¦¿</option>
          <option value="à¦ªà¦°à¦¿à¦¬à¦¹à¦¨">ğŸš— à¦ªà¦°à¦¿à¦¬à¦¹à¦¨</option>
          <option value="à¦®à§‡à¦‡à¦¨à¦Ÿà§‡à¦¨à§à¦¯à¦¾à¦¨à§à¦¸">ğŸ”§ à¦®à§‡à¦‡à¦¨à¦Ÿà§‡à¦¨à§à¦¯à¦¾à¦¨à§à¦¸</option>
          <option value="à¦…à¦¨à§à¦¯à¦¾à¦¨à§à¦¯">ğŸ“¦ à¦…à¦¨à§à¦¯à¦¾à¦¨à§à¦¯</option>
        </select>
        <textarea id="exDesc" class="inp" rows="2" placeholder="à¦¬à¦¿à¦¬à¦°à¦£ (à¦à¦šà§à¦›à¦¿à¦•)" style="resize:none"></textarea>
        <button onclick="saveExpense()" class="btn btn-p">ğŸ’¾ à¦¸à§‡à¦­ à¦•à¦°à§à¦¨</button>
      </div>
    </div>
    <!-- Filter + Summary -->
    <div class="card" style="padding:18px">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center">
        <select id="exFMo" onchange="loadExpenses()" class="inp" style="flex:1;min-width:120px">
          <option value="01">à¦œà¦¾à¦¨à§à¦¯à¦¼à¦¾à¦°à¦¿</option><option value="02">à¦«à§‡à¦¬à§à¦°à§à¦¯à¦¼à¦¾à¦°à¦¿</option>
          <option value="03">à¦®à¦¾à¦°à§à¦š</option><option value="04">à¦à¦ªà§à¦°à¦¿à¦²</option>
          <option value="05">à¦®à§‡</option><option value="06">à¦œà§à¦¨</option>
          <option value="07">à¦œà§à¦²à¦¾à¦‡</option><option value="08">à¦†à¦—à¦¸à§à¦Ÿ</option>
          <option value="09">à¦¸à§‡à¦ªà§à¦Ÿà§‡à¦®à§à¦¬à¦°</option><option value="10">à¦…à¦•à§à¦Ÿà§‹à¦¬à¦°</option>
          <option value="11">à¦¨à¦­à§‡à¦®à§à¦¬à¦°</option><option value="12">à¦¡à¦¿à¦¸à§‡à¦®à§à¦¬à¦°</option>
        </select>
        <select id="exFYr" onchange="loadExpenses()" class="inp" style="flex:1;min-width:90px">
          <option value="2025">2025</option>
          <option value="2026" selected>2026</option>
          <option value="2027">2027</option>
        </select>
        <button onclick="loadExpenses()" class="btn btn-ghost" style="font-size:.75rem">ğŸ”</button>
      </div>
      <!-- Summary -->
      <div id="exSummary" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px"></div>
      <!-- List -->
      <div id="exList" style="display:flex;flex-direction:column;gap:6px"></div>
    </div>
  </div>
</section>


</main>

<!-- MOBILE NAV with "More" button -->
<!-- MOBILE NAV -->
<div class="mn">
  <div class="mn-in" id="mnMain">
    <button onclick="gTab('daily')" id="m-daily" class="mt on">
      <span class="i">ğŸ“‹</span><span class="l">à¦¹à¦¾à¦œà¦¿à¦°à¦¾</span>
    </button>
    <button onclick="gTab('fee')" id="m-fee" class="mt">
      <span class="i">ğŸ’°</span><span class="l">à¦«à¦¿</span>
    </button>
    <button onclick="gTab('absent')" id="m-absent" class="mt">
      <span class="i">ğŸ“</span><span class="l">à¦•à¦²</span>
    </button>
    <button onclick="gTab('report')" id="m-report" class="mt">
      <span class="i">ğŸ“Š</span><span class="l">à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ</span>
    </button>
    <button onclick="toggleMobileMenu()" id="m-more" class="mt">
      <span class="i">â˜°</span><span class="l">à¦†à¦°à¦“</span>
    </button>
  </div>
</div>

<!-- MOBILE MORE MENU -->
<div id="morePanel" style="display:none;position:fixed;bottom:70px;left:0;right:0;z-index:999;padding:0 12px 8px">
  <div style="background:#fff;border-radius:20px 20px 0 0;box-shadow:0 -8px 32px rgba(0,0,0,.15);padding:16px 12px 8px">
    <div style="width:36px;height:4px;background:#e2e8f0;border-radius:99px;margin:0 auto 16px"></div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
      <button onclick="closeMM();gTab('homework')" class="mm-btn"><span>ğŸ“</span><span>HW</span></button>
      <button onclick="closeMM();gTab('exam')" class="mm-btn"><span>ğŸ“„</span><span>à¦ªà¦°à§€à¦•à§à¦·à¦¾</span></button>
      <button onclick="closeMM();gTab('modeltest')" class="mm-btn"><span>ğŸ¯</span><span>à¦®à¦¡à§‡à¦²</span></button>
      <button onclick="closeMM();gTab('notice')" class="mm-btn"><span>ğŸ“¢</span><span>à¦¨à§‹à¦Ÿà¦¿à¦¸</span></button>
      <button onclick="closeMM();gTab('routine')" class="mm-btn"><span>ğŸ—“ï¸</span><span>à¦°à§à¦Ÿà¦¿à¦¨</span></button>
      <button onclick="closeMM();gTab('lectureplan')" class="mm-btn"><span>ğŸ“š</span><span>à¦²à§‡à¦•à¦šà¦¾à¦°</span></button>
      <button onclick="closeMM();gTab('enroll')" class="mm-btn"><span>ğŸ“¤</span><span>à¦¬à¦¾à¦²à§à¦• à¦­à¦°à§à¦¤à¦¿</span></button>
      <button onclick="closeMM();gTab('expense');initExpenseTab()" class="mm-btn"><span>ğŸ’¸</span><span>à¦–à¦°à¦š</span></button>
      <button onclick="closeMM();gTab('dailytest')" class="mm-btn"><span>ğŸ“</span><span>à¦¡à§‡à¦‡à¦²à¦¿ à¦Ÿà§‡à¦¸à§à¦Ÿ</span></button>
      <button onclick="closeMM();gTab('online')" class="mm-btn"><span>ğŸ¥</span><span>à¦…à¦¨à¦²à¦¾à¦‡à¦¨</span></button>
      <button onclick="closeMM();gTab('settings')" class="mm-btn"><span>âš™ï¸</span><span>à¦¸à§‡à¦Ÿà¦¿à¦‚à¦¸</span></button>
      <button onclick="closeMM();logout()" class="mm-btn" style="color:#ef4444"><span>ğŸšª</span><span>à¦²à¦—à¦†à¦‰à¦Ÿ</span></button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="pm" class="mb" onclick="if(event.target===this)closeM()"><div class="ms"><div style="width:36px;height:4px;background:#e0e7ff;border-radius:99px;margin:11px auto 0"></div><div style="display:flex;align-items:center;justify-content:space-between;padding:13px 19px 0"><div><p style="font-size:.57rem;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:2px">âš ï¸ à¦¨à§‹à¦Ÿ</p><h2 id="pmNm" style="font-family:'Sora',sans-serif;font-size:.92rem;font-weight:700;color:var(--ink2);margin-top:2px"></h2></div><button onclick="closeM()" style="width:28px;height:28px;border-radius:99px;background:#f1f5f9;border:none;cursor:pointer;color:var(--muted);font-weight:700">âœ•</button></div><div style="padding:14px 19px 28px;display:flex;flex-direction:column;gap:10px"><input type="hidden" id="pmId"><textarea id="pmTx" placeholder="à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦²à¦¿à¦–à§à¦¨..." class="inp" style="height:115px"></textarea><div style="display:flex;gap:8px"><button onclick="saveProb()" class="btn btn-o" style="flex:1">ğŸ’¾ à¦¸à§‡à¦­</button><button onclick="clearProb()" class="btn btn-ghost" style="width:auto;padding:11px 13px;font-size:.79rem">ğŸ—‘</button></div></div></div></div>


<!-- ENROLL MODAL -->
<div id="em" class="mb" onclick="if(event.target===this)closeEF()">
  <div class="ms">
    <div style="width:36px;height:4px;background:#e0e7ff;border-radius:99px;margin:11px auto 0"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;padding:13px 19px 0">
      <div><p style="font-size:.57rem;font-weight:700;color:var(--g1);text-transform:uppercase;letter-spacing:2px">â• à¦›à¦¾à¦¤à§à¦° à¦­à¦°à§à¦¤à¦¿</p>
      <h2 id="eT" style="font-family:'Sora',sans-serif;font-size:.92rem;font-weight:700;color:var(--ink2);margin-top:2px">à¦¨à¦¤à§à¦¨ à¦›à¦¾à¦¤à§à¦° à¦­à¦°à§à¦¤à¦¿</h2></div>
      <button onclick="closeEF()" style="width:28px;height:28px;border-radius:99px;background:#f1f5f9;border:none;cursor:pointer;color:var(--muted);font-weight:700">âœ•</button>
    </div>
    <div style="padding:14px 19px 28px;display:flex;flex-direction:column;gap:10px">
      <input type="hidden" id="eId">
      <input type="text" id="eNm" placeholder="à¦ªà§‚à¦°à§à¦£ à¦¨à¦¾à¦® *" class="inp">
      <input type="number" id="eRl" placeholder="à¦°à§‹à¦² à¦¨à¦®à§à¦¬à¦° *" class="inp">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <select id="eCl" class="inp dynC"></select>
        <select id="eBt" class="inp dynB"></select>
      </div>
      <input type="text" id="ePh" placeholder="à¦«à§‹à¦¨ à¦¨à¦®à§à¦¬à¦° (à¦ªà¦¾à¦¸à¦“à¦¯à¦¼à¦¾à¦°à§à¦¡)" class="inp">
      <select id="eAdm" class="inp">
        <option value="">-- à¦­à¦°à§à¦¤à¦¿à¦° à¦®à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨ --</option>
        <option value="January">à¦œà¦¾à¦¨à§à¦¯à¦¼à¦¾à¦°à¦¿</option>
        <option value="February">à¦«à§‡à¦¬à§à¦°à§à¦¯à¦¼à¦¾à¦°à¦¿</option>
        <option value="March">à¦®à¦¾à¦°à§à¦š</option>
        <option value="April">à¦à¦ªà§à¦°à¦¿à¦²</option>
        <option value="May">à¦®à§‡</option>
        <option value="June">à¦œà§à¦¨</option>
        <option value="July">à¦œà§à¦²à¦¾à¦‡</option>
        <option value="August">à¦†à¦—à¦¸à§à¦Ÿ</option>
        <option value="September">à¦¸à§‡à¦ªà§à¦Ÿà§‡à¦®à§à¦¬à¦°</option>
        <option value="October">à¦…à¦•à§à¦Ÿà§‹à¦¬à¦°</option>
        <option value="November">à¦¨à¦­à§‡à¦®à§à¦¬à¦°</option>
        <option value="December">à¦¡à¦¿à¦¸à§‡à¦®à§à¦¬à¦°</option>
      </select>
      <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:#f0fdf4;border-radius:10px;border:1px solid #bbf7d0">
        <input type="checkbox" id="eCollectFee" onchange="toggleEnrollFee()" style="width:16px;height:16px;cursor:pointer">
        <label for="eCollectFee" style="font-size:.8rem;font-weight:700;color:#065f46;cursor:pointer">ğŸ’° à¦­à¦°à§à¦¤à¦¿à¦° à¦¸à¦¾à¦¥à§‡ à¦šà¦²à¦¤à¦¿ à¦®à¦¾à¦¸à§‡à¦° à¦¬à§‡à¦¤à¦¨ à¦¨à¦¿à¦¨</label>
      </div>
      <div id="eFeeExtra" style="display:none;flex-direction:column;gap:8px">
        <input type="number" id="eFeeAmt" class="inp" placeholder="ğŸ’µ à¦Ÿà¦¾à¦•à¦¾à¦° à¦ªà¦°à¦¿à¦®à¦¾à¦£">
        <input type="text" id="eFeeMemo" class="inp" placeholder="ğŸ§¾ à¦®à§‡à¦®à§‹ à¦¨à¦®à§à¦¬à¦°">
      </div>
      <button onclick="saveStu()" class="btn btn-p">ğŸ’¾ à¦¸à§‡à¦­ à¦•à¦°à§à¦¨</button>
      <button id="eCnl" onclick="resetE()" class="btn btn-ghost hidden" style="font-size:.82rem">âœ– à¦¨à¦¤à§à¦¨ à¦à¦¨à§à¦Ÿà§à¦°à¦¿</button>
    </div>
  </div>
</div>
<script>
// Fix alert for Bengali text
var _alert = window.alert;
window.alert = function(msg) {
  if(msg === 'âœ…') msg = 'à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦¸à§‡à¦­ à¦¹à¦¯à¦¼à§‡à¦›à§‡!';
  _alert(msg);
};
var SB=supabase.createClient('https://sfsrtozgfethgdfrmskk.supabase.co','sb_publishable_ds6DYMap76uRiquvQ9a0fQ_rctZqM61');
var AD={},HD={},TAD={},THD={},selFeeId=null,repData=null,stuCache={};
var selExamId=null,selExamTotal=100,tSelExamId=null,tSelExamTotal=100;
var feeCache={},mtSubjectsList=[],selMTId=null,selMTData=null;
var ALL_MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
var MONTH_BN={'January':'à¦œà¦¾à¦¨à§','February':'à¦«à§‡à¦¬à§à¦°à§','March':'à¦®à¦¾à¦°à§à¦š','April':'à¦à¦ªà§à¦°à¦¿à¦²','May':'à¦®à§‡','June':'à¦œà§à¦¨','July':'à¦œà§à¦²à¦¾à¦‡','August':'à¦†à¦—à¦¸à§à¦Ÿ','September':'à¦¸à§‡à¦ªà§à¦Ÿà§‡','October':'à¦…à¦•à§à¦Ÿà§‹','November':'à¦¨à¦­à§‡','December':'à¦¡à¦¿à¦¸à§‡'};

function e(s){if(!s&&s!==0)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fd(iso){if(!iso)return'';try{return new Date(iso).toLocaleDateString('bn-BD',{day:'numeric',month:'long',year:'numeric'});}catch(x){return iso;}}
function g(id){return document.getElementById(id);}
function show(id){var el=g(id);if(el){el.classList.remove('hidden');if(el.style.display==='none')el.style.display='';}}
function hide(id){var el=g(id);if(el)el.classList.add('hidden');}
function gv(id){var el=g(id);return el?el.value:'';}
function openM(){g('pm').classList.add('open');document.body.style.overflow='hidden';}
function closeM(){g('pm').classList.remove('open');document.body.style.overflow='';}
function openEF(){g('em').classList.add('open');document.body.style.overflow='hidden';setTimeout(function(){g('eNm').focus();},200);}
function closeEF(){g('em').classList.remove('open');document.body.style.overflow='';}
function toggleMobileMenu(){var p=g('morePanel'),bd=g('morePanelBackdrop'),btn=g('m-more');if(!p)return;var open=p.style.display!=='none';p.style.display=open?'none':'block';if(bd)bd.style.display=open?'none':'block';if(btn)btn.classList.toggle('on',!open);}
function closeMM(){var p=g('morePanel'),btn=g('m-more');if(p)p.style.display='none';if(btn)btn.classList.remove('on');}
function toggleSL(){var body=g('slBody'),btn=g('slToggle');if(!body)return;if(body.style.display==='none'){body.style.display='';btn.innerText='â–² à¦²à§à¦•à¦¾à¦¨';}else{body.style.display='none';btn.innerText='â–¼ à¦¦à§‡à¦–à¦¾à¦¨';}}
function closeM(){g('pm').classList.remove('open');document.body.style.overflow='';}
function calcGrade(pct){if(pct>=80)return{grade:'A+',color:'#065f46',label:'à¦…à¦¸à¦¾à¦§à¦¾à¦°à¦£'};if(pct>=70)return{grade:'A',color:'#065f46',label:'à¦–à§à¦¬ à¦­à¦¾à¦²à§‹'};if(pct>=60)return{grade:'B',color:'#1e40af',label:'à¦­à¦¾à¦²à§‹'};if(pct>=50)return{grade:'C',color:'#92400e',label:'à¦®à§‹à¦Ÿà¦¾à¦®à§à¦Ÿà¦¿'};if(pct>=40)return{grade:'D',color:'#92400e',label:'à¦ªà¦¾à¦¸'};return{grade:'F',color:'#9f1239',label:'à¦«à§‡à¦²'};}
function getMonthsUpToCurrent(){return ALL_MONTHS.slice(0,new Date().getMonth()+1);}
function getDueMonths(sid){
  var paid=feeCache[sid]||[];
  var student=stuCache[sid];
  var admMonth=student&&student.admission_month?student.admission_month:'January';
  var admIdx=ALL_MONTHS.indexOf(admMonth);
  if(admIdx<0)admIdx=0;
  var curIdx=new Date().getMonth();
  var expected=ALL_MONTHS.slice(admIdx,curIdx+1);
  return expected.filter(function(m){return paid.indexOf(m)===-1;});
}
function getDueTag(sid){var d=getDueMonths(sid);return d.length===0?'<span class="fee-ok-tag">âœ…</span>':'<span class="fee-due-tag">ğŸ’°'+d.length+'à¦®à¦¾à¦¸</span>';}
async function loadFeeData(){var yr=new Date().getFullYear().toString();var r=await SB.from('fees_collection').select('student_id,payment_month').eq('payment_year',yr);feeCache={};if(r.data)r.data.forEach(function(f){if(!feeCache[f.student_id])feeCache[f.student_id]=[];if(feeCache[f.student_id].indexOf(f.payment_month)===-1)feeCache[f.student_id].push(f.payment_month);});}

/* MORE MENU */
/* MORE MENU */
function toggleMore(){
  var panel = g('morePanel');
  var btn = g('m-more');
  if(panel.style.display === 'none'){
    panel.style.display = 'block';
    btn.classList.add('on');
  } else {
    panel.style.display = 'none';
    btn.classList.remove('on');
  }
}

/* AUTH */
function selRole(r){var parts=['pa','pt','ps'],btns=['rA','rT','rS'];parts.forEach(function(id){var el=g(id);el.classList.add('hidden');el.style.display='none';});btns.forEach(function(id){g(id).classList.remove('sel');});var idx=r==='a'?0:r==='t'?1:2;g(parts[idx]).classList.remove('hidden');g(parts[idx]).style.display='flex';g(btns[idx]).classList.add('sel');hide('lerr');}
async function aLogin(){
  var pin=gv('aPass');
  var r=await SB.from('academy_settings').select('value').eq('type','admin_pin').single();
  var stored=r.data?r.data.value:'1234';
  if(pin===stored){localStorage.setItem('ub','a');showAdmin();}
  else{g('lerr').innerText='âŒ à¦ªà¦¿à¦¨ à¦­à§à¦²!';show('lerr');g('aPass').value='';}
}
async function tLogin(){var pin=gv('tPass').trim();if(!pin){g('lerr').innerText='âŒ à¦ªà¦¿à¦¨ à¦¦à¦¿à¦¨!';show('lerr');return;}var r=await SB.from('teachers').select('*').eq('pin',pin).single();if(r.data){localStorage.setItem('ub','t');localStorage.setItem('ub_tname',r.data.name||'à¦Ÿà¦¿à¦šà¦¾à¦°');localStorage.setItem('ub_tcls',r.data.assigned_class||'All');showTeacher();}else{g('lerr').innerText='âŒ à¦ªà¦¿à¦¨ à¦­à§à¦²!';show('lerr');g('tPass').value='';}}
async function sLogin(){
  var cls=gv('sClass'),roll=gv('sRoll'),ph=gv('sPhone').trim();
  if(!cls||!roll||!ph){alert('à¦•à§à¦²à¦¾à¦¸, à¦°à§‹à¦² à¦“ à¦«à§‹à¦¨ à¦¨à¦®à§à¦¬à¦° à¦¦à¦¿à¦¨!');return;}
  // class+roll = unique student, phone = identity verification
  var r=await SB.from('students').select('*').eq('class',cls).eq('roll_no',parseInt(roll,10));
  if(!r.data||!r.data.length){
    g('lerr').innerText='âŒ à¦à¦‡ à¦•à§à¦²à¦¾à¦¸à§‡ à¦à¦‡ à¦°à§‹à¦² à¦¨à§‡à¦‡!';show('lerr');return;
  }
  // Find the one matching phone (handles siblings with same phone on different classes)
  var stu=r.data.find(function(s){return (s.phone||'').trim()===ph;});
  if(stu){
    localStorage.setItem('ub','s');
    localStorage.setItem('ub_sid', stu.id);
    hide('lo');g('sd').style.display='block';renderStuDash(stu);
  }else{
    g('lerr').innerText='âŒ à¦«à§‹à¦¨ à¦¨à¦®à§à¦¬à¦° à¦®à§‡à¦²à§‡à¦¨à¦¿!';show('lerr');
  }
}
function logout(){localStorage.removeItem('ub');localStorage.removeItem('ub_tname');localStorage.removeItem('ub_tcls');localStorage.removeItem('ub_sid');location.reload();}

async function showAdmin(){
  setTimeout(savePlayerToken, 2000);hide('lo');g('am').style.display='block';var cur=ALL_MONTHS[new Date().getMonth()];var opts=g('fMo').options;for(var i=0;i<opts.length;i++)if(opts[i].value===cur)opts[i].selected=true;var t=new Date();g('rMo').value=t.getFullYear()+'-'+String(t.getMonth()+1).padStart(2,'0');g('drDate').value=t.toISOString().split('T')[0];g('exDate').value=t.toISOString().split('T')[0];g('mtDate').value=t.toISOString().split('T')[0];await loadFeeData();syncDrops();loadPubNotice();}
function showTeacher(){hide('lo');g('td').style.display='block';TAD={};THD={};loadTDrops();g('tRMo').value=new Date().getFullYear()+'-'+String(new Date().getMonth()+1).padStart(2,'0');}

var TABS=['daily','fee','absent','homework','exam','modeltest','dailytest','notice','report','routine','lectureplan','settings','enroll','expense','online'];
function gTab(t){closeMM();
  var mp=g('morePanel');if(mp)mp.style.display='none';
g('m-more').classList.remove('on');
  TABS.forEach(function(id){hide('sec-'+id);var d=g('d-'+id);if(d)d.classList.remove('on');var m=g('m-'+id);if(m)m.classList.remove('on');});
  // Also clear more menu highlights
  show('sec-'+t);
  var d=g('d-'+t);if(d)d.classList.add('on');
  var m=g('m-'+t);if(m)m.classList.add('on');
  // If tab is in more menu, highlight more button and the item
  g('sb').style.display=t==='daily'?'grid':'none';
  if(t==='dailytest'){loadDailyTests();var now=new Date();g('dtDate').value=now.toISOString().split('T')[0];g('dtMo').value=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');syncDrops();}if(t==='online'){loadOnlineClasses();syncDrops();var isA=localStorage.getItem('ub')==='a';if(g('ocAdmin'))g('ocAdmin').style.display=isA?'block':'none';}if(t==='fee')loadFee();if(t==='absent')loadAb();if(t==='homework')loadHW();if(t==='notice'){
    loadNotices();setNotifTarget('all');renderNotifHistory();
    var ntcl=g('ntCl');if(ntcl){var sc=g('sCl');if(sc)ntcl.innerHTML=sc.innerHTML;}
    var ntbt=g('ntBt');if(ntbt)ntbt.innerHTML='<option value="All">à¦¸à¦¬ à¦¬à§à¦¯à¦¾à¦š</option>';
  }if(t==='exam')loadExams();
  if(t==='modeltest'){loadModelTests();loadMTDropdown();}
  if(t==='routine'){syncRtDrops();loadClassDaysSettings();loadRoutineNew();}
  if(t==='lectureplan')syncLPDrops();
  if(t==='report'){loadDailyRep();loadRep();}
  if(t==='enroll'){syncDrops();}
  if(t==='expense'){initExpenseTab();}
  if(t==='settings'){loadSetS();syncDrops();}
}
async function tTab(id){['ta','tp','te','tr'].forEach(function(x){hide(x);var b=g('tb-'+x);if(b)b.classList.remove('on');});show(id);var b=g('tb-'+id);if(b)b.classList.add('on');if(id==='tp')loadTP();if(id==='te')loadTExams();if(id==='tr')loadTR();}

async function loadPubNotice(){try{var r=await SB.from('notices').select('title').order('created_at',{ascending:false}).limit(1).single();if(r.data){show('ln');g('lnt').innerText=r.data.title;}}catch(x){}}
async function syncDrops(){var r=await SB.from('academy_settings').select('*').order('value');if(!r.data)return;var cls=r.data.filter(function(i){return i.type==='class';}),bch=r.data.filter(function(i){return i.type==='batch';});var cO='<option value="All">à¦¸à¦¬ à¦•à§à¦²à¦¾à¦¸</option>'+cls.map(function(x){return'<option value="'+e(x.value)+'">'+e(x.value)+'</option>';}).join('');var bO='<option value="All">à¦¸à¦¬ à¦¬à§à¦¯à¦¾à¦š</option>'+bch.map(function(x){return'<option value="'+e(x.value)+'">'+e(x.value)+'</option>';}).join('');document.querySelectorAll('.dynC').forEach(function(el){el.innerHTML=cO;});document.querySelectorAll('.dynB').forEach(function(el){el.innerHTML=bO;});g('clL').innerHTML=cls.map(function(i){return'<li style="display:flex;justify-content:space-between;align-items:center;background:#f8faff;padding:8px 12px;border-radius:10px;border:1px solid #e0e7ff"><span style="font-weight:600">'+e(i.value)+'</span><button onclick="delSet(\''+i.id+'\')" style="color:var(--red);background:transparent;border:none;cursor:pointer;font-weight:700">âœ•</button></li>';}).join('')||'<p style="text-align:center;color:var(--muted);padding:12px">à¦¨à§‡à¦‡</p>';g('btL').innerHTML=bch.map(function(i){return'<li style="display:flex;justify-content:space-between;align-items:center;background:#f8faff;padding:8px 12px;border-radius:10px;border:1px solid #e0e7ff"><span style="font-weight:600">'+e(i.value)+'</span><button onclick="delSet(\''+i.id+'\')" style="color:var(--red);background:transparent;border:none;cursor:pointer;font-weight:700">âœ•</button></li>';}).join('')||'<p style="text-align:center;color:var(--muted);padding:12px">à¦¨à§‡à¦‡</p>';loadS();loadSetS();}

/* ATTENDANCE */
async function loadS(){var cls=gv('aCl'),bch=gv('aBt'),sn=gv('aSN').toLowerCase(),sr='';var today=new Date().toISOString().split('T')[0];var q=SB.from('students').select('*');if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);var r1=await q.order('roll_no').limit(1000),r2=await SB.from('attendance').select('*').eq('attendance_date',today);if(!r1.data)return;
  var stuIds3=(r1.data||[]).map(function(s){return s.id;});
  var r3abs=await SB.from('attendance').select('student_id,status').in('student_id',stuIds3).eq('status','Absent').limit(5000);
  var totalAbsMap2={};
  (r3abs.data||[]).forEach(function(a){totalAbsMap2[a.student_id]=(totalAbsMap2[a.student_id]||0)+1;});



  var list=r1.data.filter(function(s){
    if(!sn)return true;
    return s.name.toLowerCase().includes(sn)||s.roll_no.toString()===sn.trim();
  });g('cT').innerText=list.length;var pC=0,aC=0;stuCache={};list.forEach(function(s){stuCache[s.id]=s;});
  // Pre-populate AD and HD from existing Supabase records so partial saves work correctly
  if(r2.data){r2.data.forEach(function(rec){
    if(!AD[rec.student_id]&&rec.status)AD[rec.student_id]=rec.status;
    if(!HD[rec.student_id]&&rec.homework_status)HD[rec.student_id]=rec.homework_status;
  });}
  await loadFeeData();g('SL').innerHTML=list.map(function(s){var rec=r2.data&&r2.data.find(function(x){return x.student_id===s.id;});if(rec){if(rec.status==='Present')pC++;else if(rec.status==='Absent')aC++;}var pA=AD[s.id]==='Present'||(!AD[s.id]&&rec&&rec.status==='Present');var aA=AD[s.id]==='Absent'||(!AD[s.id]&&rec&&rec.status==='Absent');var yA=HD[s.id]==='Yes'||(!HD[s.id]&&rec&&rec.homework_status==='Yes');var nA=HD[s.id]==='No'||(!HD[s.id]&&rec&&rec.homework_status==='No');var hn=s.problem_note&&s.problem_note.trim();
var dueM=getDueMonths(s.id);return'<div class="sr fi'+(hn?' hn':'')+'"><div class="sr-top"><div style="flex:1;min-width:0;cursor:pointer" onclick="openPM('+s.id+')"><p style="font-weight:700;color:var(--ink2);font-size:.84rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+e(s.name)+(hn?' âš ï¸':'')+(totalAbsMap2[s.id]>0?' <span style="font-size:.75rem;font-weight:800;color:'+(totalAbsMap2[s.id]>5?'#dc2626':'#16a34a')+'">('+(totalAbsMap2[s.id]||0)+')</span>':'')+'</p><p style="font-size:.63rem;color:var(--muted);margin-top:1px">à¦°à§‹à¦²:'+s.roll_no+' | '+e(s.class)+' | '+e(s.batch||'')+' '+getDueTag(s.id)+'</p>'+(dueM.length?'<div class="due-months-bar">'+dueM.map(function(m){return'<span class="due-month-chip">'+MONTH_BN[m]+'</span>';}).join('')+'</div>':'')+'</div><div style="display:flex;gap:4px"><button id="p-'+s.id+'" onclick="mAtt(\''+s.id+'\',\'Present\')" class="ab pb'+(pA?' on':'')+'">P</button><button id="a-'+s.id+'" onclick="mAtt(\''+s.id+'\',\'Absent\')" class="ab xb'+(aA?' on':'')+'">A</button></div></div><div class="sr-bot"><span style="font-size:.6rem;color:#94a3b8;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+e(s.phone||'')+'</span><div style="display:flex;align-items:center;gap:4px"><span style="font-size:.55rem;font-weight:700;color:#94a3b8">HW</span><button id="y-'+s.id+'" onclick="mHw(\''+s.id+'\',\'Yes\')" class="ab yb'+(yA?' on':'')+'">Y</button><button id="n-'+s.id+'" onclick="mHw(\''+s.id+'\',\'No\')" class="ab nb'+(nA?' on':'')+'">N</button></div></div></div>';}).join('');g('cP').innerText=pC;g('cA').innerText=aC;}
function mAtt(id,s){AD[id]=s;g('p-'+id).className='ab pb'+(s==='Present'?' on':'');g('a-'+id).className='ab xb'+(s==='Absent'?' on':'');}
function mHw(id,s){HD[id]=s;g('y-'+id).className='ab yb'+(s==='Yes'?' on':'');g('n-'+id).className='ab nb'+(s==='No'?' on':'');}
async function subAtt(){
  var today=new Date().toISOString().split('T')[0];
  var attIds=Object.keys(AD);
  var hwIds=Object.keys(HD);
  if(!attIds.length&&!hwIds.length){alert('à¦®à¦¾à¦°à§à¦• à¦•à¦°à§à¦¨!');return;}
  var allIds=[...new Set([...attIds,...hwIds])];
  // Load existing records from Supabase to avoid overwriting
  var existing=await SB.from('attendance').select('student_id,status,homework_status').eq('attendance_date',today).in('student_id',allIds.map(Number));
  var existMap={};
  (existing.data||[]).forEach(function(r){existMap[r.student_id]=r;});
  // Build records merging existing + new changes
  var recs=allIds.map(function(id){
    var sid=parseInt(id,10);
    var ex=existMap[sid]||{};
    return{
      student_id:sid,
      attendance_date:today,
      status:AD[id]||ex.status||'Absent',
      homework_status:HD[id]!==undefined?HD[id]:(ex.homework_status||null)
    };
  });
  var r=await SB.from('attendance').upsert(recs,{onConflict:'student_id,attendance_date'});
  if(r.error)alert(r.error.message);
  else{
    alert('âœ… à¦¸à§‡à¦­!');
    // Send absent notifications
    sendAbsentNotifications(recs);
    AD={};HD={};loadS();
  }
}
async function resetE(){g('eId').value='';g('eNm').value='';g('eRl').value='';g('ePh').value='';g('eT').innerText='ğŸ‘¤ à¦­à¦°à§à¦¤à¦¿';hide('eCnl');var a=g('eAdm');if(a)a.selectedIndex=new Date().getMonth()+1;}
function editStu(s){g('eId').value=s.id;g('eNm').value=s.name;g('eRl').value=s.roll_no;g('ePh').value=s.phone||'';g('eT').innerText='à¦¤à¦¥à§à¦¯ à¦¸à¦®à§à¦ªà¦¾à¦¦à¦¨à¦¾';show('eCnl');openEF();setTimeout(function(){var c=g('eCl'),b=g('eBt'),a=g('eAdm');for(var i=0;i<c.options.length;i++)if(c.options[i].value===s.class)c.options[i].selected=true;for(var i=0;i<b.options.length;i++)if(b.options[i].value===s.batch)b.options[i].selected=true;if(a&&s.admission_month)for(var i=0;i<a.options.length;i++)if(a.options[i].value===s.admission_month)a.options[i].selected=true;},60);g('eNm').focus();}
function editSwitch(s){protect(function(){
  // Fill enroll modal fields
  g('eId').value=s.id;
  g('eNm').value=s.name||'';
  g('eRl').value=s.roll_no||'';
  g('ePh').value=s.phone||'';
  g('eT').innerText='à¦¤à¦¥à§à¦¯ à¦¸à¦®à§à¦ªà¦¾à¦¦à¦¨à¦¾';
  show('eCnl');
  openEF();
  setTimeout(function(){
    var cl=g('eCl'),bt=g('eBt'),adm=g('eAdm');
    for(var i=0;i<cl.options.length;i++) if(cl.options[i].value===s.class) cl.selectedIndex=i;
    for(var i=0;i<bt.options.length;i++) if(bt.options[i].value===s.batch) bt.selectedIndex=i;
    if(adm&&s.admission_month) for(var i=0;i<adm.options.length;i++) if(adm.options[i].value===s.admission_month){adm.selectedIndex=i;break;}
  },80);
});}
async function saveStu(){
  var id=gv('eId'),name=gv('eNm').trim(),roll=parseInt(gv('eRl'),10);
  var cls=gv('eCl'),bat=gv('eBt');
  if(!name||!roll){alert('à¦¨à¦¾à¦® à¦“ à¦°à§‹à¦² à¦¦à¦¿à¦¨!');return;}
  // Check duplicate roll in same class+batch
  var chk=await SB.from('students').select('id,name').eq('class',cls).eq('batch',bat).eq('roll_no',roll);
  if(chk.data&&chk.data.length){
    var existing=chk.data[0];
    // Allow if editing same student
    if(!id||existing.id!=id){
      alert('âŒ '+cls+' ('+bat+') à¦¤à§‡ à¦°à§‹à¦² à¦¨à¦®à§à¦¬à¦° '+roll+' à¦‡à¦¤à¦¿à¦®à¦§à§à¦¯à§‡ à¦†à¦›à§‡!\nğŸ‘¤ à¦¨à¦¾à¦®: '+existing.name);
      return;
    }
  }
  var pl={name:name,roll_no:roll,class:cls,batch:bat,phone:gv('ePh').trim(),admission_month:gv('eAdm')};
  var r=id?await SB.from('students').update(pl).eq('id',id):await SB.from('students').insert([pl]).select();
  if(r.error){alert(r.error.message);return;}
  // Collect current month fee if checkbox checked
  var collectFee=g('eCollectFee')&&g('eCollectFee').checked;
  if(collectFee){
    // Get student id - for new student from insert, for edit use existing id
    var sid=id?parseInt(id):( r.data&&r.data[0]?r.data[0].id:null );
    if(!sid){
      // Fetch by roll+class+batch
      var sr=await SB.from('students').select('id').eq('class',cls).eq('batch',bat).eq('roll_no',roll).single();
      sid=sr.data?sr.data.id:null;
    }
    if(sid){
      var now=new Date();
      var months=['January','February','March','April','May','June','July','August','September','October','November','December'];
      var feeAmt=parseFloat(g('eFeePay')?g('eFeePay').value:0)||0;
      var feeMemo=g('eFeeMemo')?g('eFeeMemo').value.trim():'à¦­à¦°à§à¦¤à¦¿à¦° à¦¸à¦®à¦¯à¦¼ à¦¬à§‡à¦¤à¦¨';
      var fr=await SB.from('fees_collection').insert([{
        student_id:sid,
        payment_month:months[now.getMonth()],
        payment_year:now.getFullYear().toString(),
        payment_date:now.toISOString().split('T')[0],
        amount:feeAmt||null,
        memo_no:feeMemo
      }]);
      if(fr.error)alert('à¦­à¦°à§à¦¤à¦¿ à¦¹à¦¯à¦¼à§‡à¦›à§‡ à¦•à¦¿à¦¨à§à¦¤à§ à¦¬à§‡à¦¤à¦¨ à¦¸à§‡à¦­ à¦¹à¦¯à¦¼à¦¨à¦¿: '+fr.error.message);
      else{resetE();closeEF();syncDrops();alert('âœ… à¦­à¦°à§à¦¤à¦¿ à¦¸à¦®à§à¦ªà¦¨à§à¦¨! à¦¬à§‡à¦¤à¦¨à¦“ à¦¨à§‡à¦“à¦¯à¦¼à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡à¥¤');return;}
    }
  }
  resetE();closeEF();syncDrops();alert('âœ…');
}

/* FEE */
async function loadFee(){var mon=gv('fMo'),cls=gv('fCl'),bch=gv('fBt'),yr=new Date().getFullYear().toString();
var srch=(g('fSearch')?g('fSearch').value.trim().toLowerCase():'');
var c=g('fL');c.innerHTML='<div class="sk" style="height:50px;width:100%"></div>';var q=SB.from('students').select('*');if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);
var r1=await q.order('roll_no').limit(1000),r2=await SB.from('fees_collection').select('*').eq('payment_year',yr);
var stuIds2=(r1.data||[]).map(function(s){return s.id;});
var r3=stuIds2.length?await SB.from('attendance').select('student_id,status').in('student_id',stuIds2).eq('status','Absent').limit(5000):{data:[]};
var absentMap={};
(r3.data||[]).forEach(function(a){absentMap[a.student_id]=(absentMap[a.student_id]||0)+1;});
// Load latest call note per student
var r4=stuIds2.length?await SB.from('call_notes').select('student_id,note,created_at').in('student_id',stuIds2).order('created_at',{ascending:false}).limit(1000):{data:[]};
var noteMap={};
(r4.data||[]).forEach(function(n){if(!noteMap[n.student_id])noteMap[n.student_id]=n;});
if(srch&&r1.data){r1.data=r1.data.filter(function(s){return s.name.toLowerCase().indexOf(srch)!==-1||String(s.roll_no).indexOf(srch)!==-1;});}
if(r1.data)r1.data.forEach(function(s){stuCache[s.id]=s;});
if(!r1.data||!r1.data.length){c.innerHTML='<p style="text-align:center;padding:26px;color:var(--muted)">à¦¨à§‡à¦‡</p>';return;}feeCache={};if(r2.data)r2.data.forEach(function(f){if(!feeCache[f.student_id])feeCache[f.student_id]=[];if(feeCache[f.student_id].indexOf(f.payment_month)===-1)feeCache[f.student_id].push(f.payment_month);});var pc=r2.data?r2.data.filter(function(p){return p.payment_month===mon&&r1.data.some(function(s){return s.id===p.student_id;});}).length:0;
// Count unique students who have ANY due (from admission month onwards)
var dueStuCount=r1.data.filter(function(s){return getDueMonths(s.id).length>0;}).length;
c.innerHTML='<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:13px"><span class="paid-b">âœ… à¦ªà¦°à¦¿à¦¶à§‹à¦§: '+pc+'</span><span class="due-b">â³ à¦¬à¦•à§‡à¦¯à¦¼à¦¾ à¦†à¦›à§‡: '+dueStuCount+' à¦œà¦¨</span></div><div style="display:flex;flex-direction:column;gap:7px">'+r1.data.map(function(s){var pay=r2.data&&r2.data.find(function(p){return p.student_id===s.id&&p.payment_month===mon;});var dueM=getDueMonths(s.id);return'<div style="background:#fff;padding:12px;border-radius:12px;border-left:4px solid '+(pay?'var(--green)':'var(--red)')+';display:flex;flex-direction:column;gap:5px"><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:6px"><div style="flex:1;min-width:0"><p style="font-weight:700;font-size:.85rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+e(s.name)+'</p><p style="font-size:.63rem;color:var(--muted)">à¦°à§‹à¦²:'+s.roll_no+' | '+e(s.batch||'')+'</p>'+'<p style="font-size:.63rem;color:var(--muted)">ğŸ“ '+e(s.phone||'â€”')+'</p></div>'+'<div style="display:flex;gap:3px;align-items:center;flex-shrink:0">'+(pay?'<span class="paid-b">PAID âœ“</span>':'<button onclick="openFF(\''+s.id+'\',\''+e(s.name)+'\')" style="background:var(--g1);color:#fff;border:none;padding:6px 10px;border-radius:10px;font-family:var(--font);font-weight:700;font-size:.7rem;cursor:pointer;white-space:nowrap">ğŸ’° à¦«à¦¿ à¦¨à¦¿à¦¨</button>')+'<button class="fee-edit-btn" data-sid="'+s.id+'" style="background:#eff6ff;color:var(--g1);border:none;padding:7px 9px;border-radius:10px;font-weight:700;font-size:.72rem;cursor:pointer">âœï¸</button>'+'<button onclick="openCallNote('+s.id+',\''+e(s.name)+'\')" style="background:#f0fdf4;color:#16a34a;border:none;padding:7px 9px;border-radius:10px;font-weight:700;font-size:.72rem;cursor:pointer">ğŸ“</button>'+'</div>'+'</div>'+(dueM.length?'<div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap"><span class="fee-due-tag">âš ï¸ '+dueM.length+' à¦®à¦¾à¦¸</span><div class="due-months-bar">'+dueM.map(function(m){return'<span class="due-month-chip">'+MONTH_BN[m]+'</span>';}).join('')+'</div></div>':'<span class="fee-ok-tag">âœ… à¦¸à¦¬ à¦ à¦¿à¦•</span>')+
(absentMap[s.id]>0?'<div style="display:flex;align-items:center;gap:6px;margin-top:2px"><span style="font-size:.65rem;font-weight:700;color:'+(absentMap[s.id]>5?'#dc2626':'#16a34a')+'">'+( absentMap[s.id]>5?'âš ï¸ à¦…à¦¨à¦¿à¦¯à¦¼à¦®à¦¿à¦¤':'âœ… à¦¨à¦¿à¦¯à¦¼à¦®à¦¿à¦¤')+'</span><span style="font-size:.63rem;color:#64748b">à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤: '+absentMap[s.id]+' à¦¦à¦¿à¦¨</span></div>':'')+
(noteMap[s.id]?'<div style="margin-top:5px;padding:7px 9px;background:#f8faff;border-radius:8px;border-left:3px solid #6366f1"><p style="font-size:.6rem;color:#94a3b8;margin-bottom:2px">ğŸ“ '+new Date(noteMap[s.id].created_at).toLocaleDateString('bn-BD')+'</p><p style="font-size:.72rem;color:#1e1b4b;line-height:1.4">'+e(noteMap[s.id].note)+'</p></div>':'')+
'</div>';}).join('')+'</div>';
  // Add click handlers for edit buttons
  g('fL').querySelectorAll('.fee-edit-btn').forEach(function(btn){
    btn.onclick=function(){editSwitch(stuCache[btn.dataset.sid]);};
  });}
async function openFF(id,name){selFeeId=id;g('fNm').innerText=name;g('fAm').value='';g('fMe').value='';g('fNo').value='';show('fF');g('fAm').focus();}
async function subFee(){
  var amt=gv('fAm'),memo=gv('fMe'),mo=gv('fMo');
  if(!amt){alert('à¦Ÿà¦¾à¦•à¦¾à¦° à¦ªà¦°à¦¿à¦®à¦¾à¦£ à¦¦à¦¿à¦¨!');return;}

  if(!mo){alert('à¦®à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  if(!selFeeId){alert('à¦•à§‹à¦¨à§‹ student select à¦¹à¦¯à¦¼à¦¨à¦¿!');return;}
  var payload={
    student_id:selFeeId,
    amount:parseFloat(amt),
    memo_no:memo||null,
    payment_month:mo,
    payment_year:new Date().getFullYear().toString(),
    payment_date:new Date().toISOString().split('T')[0],
    fee_type:'Monthly',
    memo_note:gv('fNo')||''
  };
  var r=await SB.from('fees_collection').insert([payload]);
  if(r.error){
    alert('âŒ à¦¸à§‡à¦­ à¦¹à¦¯à¦¼à¦¨à¦¿: '+r.error.message);
    console.error('Fee insert error:', r.error);
    return;
  }
  alert('âœ… à¦«à¦¿ à¦à¦¨à§à¦Ÿà§à¦°à¦¿ à¦¸à¦«à¦²!');
  hide('fF');
  await loadFeeData();
  loadFee();
  loadS();
}

/* ABSENT CALL */
async function loadAb(){var today=new Date().toISOString().split('T')[0],cls=gv('abCl'),bch=gv('abBt');var c=g('abL');c.innerHTML='<div class="sk" style="height:56px;width:100%"></div>';var r1=await SB.from('attendance').select('student_id').eq('attendance_date',today).eq('status','Absent');if(!r1.data||!r1.data.length){c.innerHTML='<p style="text-align:center;padding:26px;color:var(--muted)">ğŸ‰ à¦•à§‡à¦‰ à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤ à¦¨à§‡à¦‡!</p>';return;}var q=SB.from('students').select('*').in('id',r1.data.map(function(a){return a.student_id;}));if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);var r2=await q.order('roll_no');if(!r2.data||!r2.data.length){c.innerHTML='<p style="text-align:center;padding:26px;color:var(--muted)">à¦¨à§‡à¦‡</p>';return;}c.innerHTML=r2.data.map(function(s){return'<div style="background:#fff;padding:13px;border-radius:12px;border-left:4px solid var(--red);display:flex;justify-content:space-between;align-items:center"><div><p style="font-weight:700">'+e(s.name)+'</p><p style="font-size:.68rem;color:var(--muted)">'+e(s.class)+' | à¦°à§‹à¦²:'+s.roll_no+'</p><p style="font-size:.73rem;color:var(--g1);font-weight:700;margin-top:2px">'+e(s.phone)+'</p></div><a href="tel:'+e(s.phone)+'" style="width:36px;height:36px;background:var(--rs);border-radius:99px;display:flex;align-items:center;justify-content:center;font-size:.95rem;text-decoration:none">ğŸ“</a></div>';}).join('');}

/* HOMEWORK */
async function loadHW(){var today=new Date().toISOString().split('T')[0],cls=gv('hwCl'),bch=gv('hwBt');var c=g('hwL');c.innerHTML='<div class="sk" style="height:56px;width:100%;grid-column:1/-1"></div>';var r1=await SB.from('attendance').select('student_id,homework_status').eq('attendance_date',today).not('homework_status','is',null);var q=SB.from('students').select('*');if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);var r2=await q;if(!r1.data||!r1.data.length){c.innerHTML='<p style="grid-column:1/-1;text-align:center;padding:26px;color:var(--muted)">à¦†à¦œ à¦•à§‹à¦¨à§‹ HW à¦à¦¨à§à¦Ÿà§à¦°à¦¿ à¦¨à§‡à¦‡à¥¤</p>';return;}var sIds=new Set((r2.data||[]).map(function(s){return s.id;}));var f=r1.data.filter(function(a){return sIds.has(a.student_id);});if(!f.length){c.innerHTML='<p style="grid-column:1/-1;text-align:center;padding:26px;color:var(--muted)">à¦à¦‡ à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦°à§‡ à¦¨à§‡à¦‡à¥¤</p>';return;}c.innerHTML=f.map(function(a){var s=(r2.data||[]).find(function(x){return x.id===a.student_id;});if(!s)return'';var d=a.homework_status==='Yes';return'<div style="padding:12px;background:#fff;border-radius:12px;border-left:4px solid '+(d?'var(--green)':'var(--amber)')+'"><p style="font-weight:700">'+e(s.name)+' <span style="color:var(--muted);font-size:.73rem">('+s.roll_no+')</span></p><p style="font-size:.75rem;font-weight:700;margin-top:3px;color:'+(d?'var(--green)':'var(--amber)')+'">'+(d?'âœ… à¦œà¦®à¦¾ à¦¦à¦¿à¦¯à¦¼à§‡à¦›à§‡à¦¨':'â³ à¦œà¦®à¦¾ à¦¦à§‡à¦¨à¦¨à¦¿')+'</p><p style="font-size:.62rem;color:#94a3b8;margin-top:3px">'+e(s.class)+'</p></div>';}).join('');}

/* NOTICE */
async function postNotice(){var ti=gv('nTi').trim(),bo=g('nBo').value.trim();if(!ti||!bo){alert('à¦¦à¦¿à¦¨!');return;}await SB.from('notices').insert([{title:ti,content:bo}]);alert('âœ…');g('nTi').value='';g('nBo').value='';loadNotices();}
async function loadNotices(){var r=await SB.from('notices').select('*').order('created_at',{ascending:false}).limit(10);g('nL').innerHTML=(r.data||[]).map(function(n){return'<div class="ni" style="display:flex;justify-content:space-between"><div style="flex:1"><p style="font-weight:700">'+e(n.title)+'</p><p style="font-size:.75rem;color:var(--muted);margin-top:3px">'+e(n.content.substring(0,100))+'</p><p style="font-size:.62rem;color:#94a3b8;margin-top:5px">'+fd(n.created_at)+'</p></div><button onclick="delNotice(\''+n.id+'\')" style="color:var(--red);background:transparent;border:none;cursor:pointer;font-weight:700;margin-left:9px">âœ•</button></div>';}).join('')||'<p style="text-align:center;color:var(--muted);padding:13px">à¦¨à§‡à¦‡</p>';}
async function delNotice(id){if(!confirm('à¦®à§à¦›à¦¬à§‡à¦¨?'))return;var r=await SB.from('notices').delete().eq('id',id);if(r.error){alert('âŒ Error: '+r.error.message);}else{loadNotices();}}

/* EXAM */
async function createExam(){var name=gv('exName').trim(),date=gv('exDate'),total=parseInt(gv('exTotal'),10)||100;if(!name||!date){alert('à¦¨à¦¾à¦® à¦“ à¦¤à¦¾à¦°à¦¿à¦– à¦¦à¦¿à¦¨!');return;}await SB.from('exams').insert([{exam_name:name,exam_date:date,class:gv('exCl'),batch:gv('exBt'),total_marks:total}]);alert('âœ…');g('exName').value='';loadExams();}
async function loadExams(){var cls=gv('exLCl'),bch=gv('exLBt');var c=g('examList');var q=SB.from('exams').select('*').order('exam_date',{ascending:false});if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);var r=await q;if(!r.data||!r.data.length){c.innerHTML='<p style="grid-column:1/-1;text-align:center;padding:26px;color:var(--muted)">à¦¨à§‡à¦‡</p>';hide('marksEntry');return;}c.innerHTML=r.data.map(function(ex){return'<div class="exam-card fi" onclick="selectExam('+ex.id+',\''+e(ex.exam_name).replace(/'/g,'')+'\','+ex.total_marks+',\''+e(ex.class)+'\',\''+e(ex.batch||'All')+'\',\''+ex.exam_date+'\')"><p style="font-weight:700">'+e(ex.exam_name)+'</p><p style="font-size:.63rem;color:var(--muted)">'+fd(ex.exam_date)+' | '+e(ex.class)+' | '+ex.total_marks+'</p><div style="display:flex;gap:5px;margin-top:8px"><button onclick="event.stopPropagation()" style="flex:1;background:var(--g1);color:#fff;border:none;padding:5px;border-radius:8px;font-weight:700;font-size:.68rem;cursor:pointer">ğŸ“</button><button onclick="event.stopPropagation();delExam('+ex.id+')" style="background:var(--rs);color:var(--red);border:none;padding:5px 8px;border-radius:8px;font-weight:700;font-size:.68rem;cursor:pointer">ğŸ—‘</button></div></div>';}).join('');}
async function delExam(id){if(!confirm('à¦®à§à¦›à¦¬à§‡à¦¨?'))return;await SB.from('exam_results').delete().eq('exam_id',id);await SB.from('exams').delete().eq('id',id);selExamId=null;hide('marksEntry');loadExams();}
async function selectExam(id,name,total,cls,bch,date){selExamId=id;selExamTotal=total;g('selExName').innerText=name;g('selExInfo').innerText=fd(date)+' | '+cls+' | à¦¸à¦°à§à¦¬à§‹à¦šà§à¦š: '+total;show('marksEntry');var q=SB.from('students').select('*');if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);var r1=await q.order('roll_no').limit(1000);var r2=await SB.from('exam_results').select('*').eq('exam_id',id).limit(1000);g('marksList').innerHTML=(r1.data||[]).map(function(s){var res=r2.data&&r2.data.find(function(x){return x.student_id===s.id;});return'<div class="sr fi" style="flex-direction:row;align-items:center;gap:10px"><div style="flex:1"><p style="font-weight:700;font-size:.82rem">'+e(s.name)+'</p><p style="font-size:.6rem;color:var(--muted)">à¦°à§‹à¦²:'+s.roll_no+'</p></div><input type="number" id="mk-'+s.id+'" class="marks-inp" value="'+(res?res.marks_obtained:'')+'" max="'+total+'"><div id="gr-'+s.id+'" style="min-width:32px;text-align:center;font-size:.68rem;font-weight:700;color:#94a3b8">'+(res?calcGrade((res.marks_obtained/total)*100).grade:'â€”')+'</div></div>';}).join('');g('marksEntry').scrollIntoView({behavior:'smooth'});}
async function saveMarks(){if(!selExamId)return;var inps=g('marksList').querySelectorAll('.marks-inp');var recs=[];inps.forEach(function(inp){var sid=parseInt(inp.id.replace('mk-',''),10);if(inp.value!==''){var m=parseFloat(inp.value)||0;recs.push({exam_id:selExamId,student_id:sid,marks_obtained:m,grade:calcGrade((m/selExamTotal)*100).grade});}});if(!recs.length){alert('à¦¨à¦®à§à¦¬à¦° à¦¦à¦¿à¦¨!');return;}var r=await SB.from('exam_results').upsert(recs,{onConflict:'exam_id,student_id'});if(r.error)alert(r.error.message);else alert('âœ… à¦¸à§‡à¦­!');}
function exportExamXls(){if(!selExamId)return;var inps=g('marksList').querySelectorAll('.marks-inp');var data=[['à¦¨à¦¾à¦®','à¦°à§‹à¦²','à¦¨à¦®à§à¦¬à¦°','à¦—à§à¦°à§‡à¦¡']];inps.forEach(function(inp){var row=inp.closest('.sr');data.push([row.querySelector('p').innerText,row.querySelectorAll('p')[1].innerText.replace('à¦°à§‹à¦²:',''),inp.value||'',g('gr-'+inp.id.replace('mk-','')).innerText]);});var ws=XLSX.utils.aoa_to_sheet(data);var wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Results');XLSX.writeFile(wb,'Exam.xlsx');}

/* PRINT EXAM */
async function printExamResult(){
  if(!selExamId)return;
  var name=g('selExName').innerText,info=g('selExInfo').innerText;
  // Load ALL from Supabase
  var r1=await SB.from('exam_results').select('marks_obtained,student_id').eq('exam_id',selExamId).limit(1000);
  var r2=await SB.from('students').select('id,name,roll_no').limit(1000);
  if(!r1.data||!r1.data.length){alert('à¦•à§‹à¦¨à§‹ à¦°à§‡à¦œà¦¾à¦²à§à¦Ÿ à¦¨à§‡à¦‡!');return;}
  var stuMap={};
  (r2.data||[]).forEach(function(s){stuMap[s.id]=s;});
  var rows=[];
  r1.data.forEach(function(d){
    if(d.marks_obtained===null||d.marks_obtained===undefined)return;
    var s=stuMap[d.student_id];
    if(!s)return;
    var pct=Math.round((d.marks_obtained/selExamTotal)*100);
    var gr=calcGrade(pct);
    rows.push({name:s.name,roll:s.roll_no,marks:d.marks_obtained,pct:pct,grade:gr.grade});
  });
  rows.sort(function(a,b){return b.marks-a.marks;});
  rows.forEach(function(r,i){r.merit=i+1;});
  var today=new Date();
  var dateStr=today.getDate()+'/'+(today.getMonth()+1)+'/'+today.getFullYear();
  var html='<!DOCTYPE html><html><head><meta charset="UTF-8">'+
  '<style>'+
  'body{font-family:Arial,sans-serif;margin:0;padding:10mm;background:#fff;color:#000}'+
  'h1{text-align:center;font-size:20pt;margin:0;letter-spacing:2px}'+
  '.sub{text-align:center;font-size:9pt;color:#555;margin:4px 0 10px;border-bottom:2px solid #4f46e5;padding-bottom:6px}'+
  'table{width:100%;border-collapse:collapse;font-size:9pt}'+
  'thead th{background:#4f46e5;color:#fff;padding:6px 8px;text-align:center;border:1px solid #3730a3}'+
  'td{padding:5px 7px;border:1px solid #ddd;text-align:center}'+
  'tr:nth-child(even) td{background:#f8faff}'+
  '.name-cell{text-align:left;font-weight:600}'+
  '.m1 td{background:#fef9c3!important;font-weight:700}'+
  '.m2 td{background:#e0f2fe!important;font-weight:700}'+
  '.m3 td{background:#fce7f3!important;font-weight:700}'+
  '.footer{margin-top:8mm;display:flex;justify-content:space-between;font-size:8pt;color:#666;border-top:1px solid #ddd;padding-top:4px}'+
  '.stamp{margin-top:12mm;display:flex;justify-content:space-around;font-size:8pt;color:#666}'+
  '.stamp div{text-align:center;min-width:40mm}'+
  '.stamp span{display:block;margin-top:14mm;border-top:1px solid #000;padding-top:3px}'+
  '.grade-box{margin-top:6mm;border:1px solid #ddd;border-radius:4px;padding:4px 8px;font-size:7.5pt;display:flex;gap:8mm;justify-content:center;flex-wrap:wrap;color:#555}'+
  '@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact}}'+
  '</style></head><body>'+
  '<h1>UBIQUE</h1>'+
  '<div class="sub">'+e(name)+' â€” '+e(info)+'</div>'+
  '<table><thead><tr><th>à¦®à§‡à¦°à¦¿à¦Ÿ</th><th style="text-align:left">à¦¨à¦¾à¦®</th><th>à¦°à§‹à¦²</th><th>à¦¨à¦®à§à¦¬à¦°</th><th>à¦®à§‹à¦Ÿ</th><th>%</th><th>à¦—à§à¦°à§‡à¦¡</th></tr></thead><tbody>'+
  rows.map(function(r){
    var mc=r.merit===1?'m1':r.merit===2?'m2':r.merit===3?'m3':'';
    return'<tr class="'+mc+'"><td>'+r.merit+'</td><td class="name-cell">'+e(r.name)+'</td><td>'+r.roll+'</td><td style="font-weight:700">'+r.marks+'</td><td>'+selExamTotal+'</td><td>'+r.pct+'%</td><td><b>'+r.grade+'</b></td></tr>';
  }).join('')+
  '</tbody></table>'+
  '<div class="grade-box"><span>A+ â‰¥80%</span><span>A â‰¥70%</span><span>B â‰¥60%</span><span>C â‰¥50%</span><span>D â‰¥40%</span><span>F &lt;40%</span></div>'+
  '<div class="stamp"><div>à¦ªà¦°à§€à¦•à§à¦·à¦•<span>à¦¸à§à¦¬à¦¾à¦•à§à¦·à¦°</span></div><div>à¦ªà§à¦°à¦§à¦¾à¦¨ à¦¶à¦¿à¦•à§à¦·à¦•<span>à¦¸à§à¦¬à¦¾à¦•à§à¦·à¦° à¦“ à¦¸à¦¿à¦²</span></div></div>'+
  '<div class="footer"><span>à¦¤à¦¾à¦°à¦¿à¦–: '+dateStr+'</span><span>à¦®à§‹à¦Ÿ à¦ªà¦°à§€à¦•à§à¦·à¦¾à¦°à§à¦¥à§€: '+rows.length+'</span><span>UBIQUE</span></div>'+
  '<\/body><\/html>';
  // Open in new window for print/save as PDF
  var w=window.open('','_blank','width=900,height=700');
  w.document.write(html);
  w.document.close();
  w.onload=function(){w.focus();w.print();};
}

/* MODEL TEST */
function addMTSubject(){var name=gv('mtSubName').trim(),max=parseInt(gv('mtSubMax'),10)||100;if(!name){alert('à¦¬à¦¿à¦·à¦¯à¦¼ à¦¦à¦¿à¦¨!');return;}mtSubjectsList.push({name:name,max:max});renderMTSubs();g('mtSubName').value='';g('mtSubMax').value='100';g('mtSubName').focus();}
function removeMTSub(i){mtSubjectsList.splice(i,1);renderMTSubs();}
async function renderMTSubs(){g('mtSubjects').innerHTML=mtSubjectsList.map(function(s,i){return'<span class="sub-chip">'+e(s.name)+' ('+s.max+') <button onclick="removeMTSub('+i+')">âœ•</button></span>';}).join('');}
async function createModelTest(){var name=gv('mtName').trim();if(!name){alert('à¦¨à¦¾à¦® à¦¦à¦¿à¦¨!');return;}if(!mtSubjectsList.length){alert('à¦¬à¦¿à¦·à¦¯à¦¼ à¦¯à§‹à¦— à¦•à¦°à§à¦¨!');return;}await SB.from('model_tests').insert([{test_name:name,test_date:gv('mtDate'),class:gv('mtCl'),batch:gv('mtBt'),subjects:mtSubjectsList}]);alert('âœ…');g('mtName').value='';mtSubjectsList=[];renderMTSubs();loadModelTests();loadMTDropdown();}
async function loadModelTests(){var cls=gv('mtLCl'),bch=gv('mtLBt');var c=g('mtList');var q=SB.from('model_tests').select('*').order('test_date',{ascending:false});if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);var r=await q;if(!r.data||!r.data.length){c.innerHTML='<p style="grid-column:1/-1;text-align:center;padding:26px;color:var(--muted)">à¦¨à§‡à¦‡</p>';hide('mtEntry');return;}c.innerHTML=r.data.map(function(mt){var subs=mt.subjects||[];var tm=subs.reduce(function(a,s){return a+s.max;},0);return'<div class="exam-card fi" onclick="selectMT('+mt.id+')"><p style="font-weight:700">'+e(mt.test_name)+'</p><p style="font-size:.63rem;color:var(--muted)">'+fd(mt.test_date)+' | '+e(mt.class)+' | '+subs.length+' à¦¬à¦¿à¦·à¦¯à¦¼ | à¦®à§‹à¦Ÿ:'+tm+'</p><div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:6px">'+subs.map(function(s){return'<span style="background:#eff6ff;color:var(--g1);padding:2px 6px;border-radius:5px;font-size:.58rem;font-weight:700">'+e(s.name)+'</span>';}).join('')+'</div><div style="display:flex;gap:5px;margin-top:8px"><button onclick="event.stopPropagation()" style="flex:1;background:var(--g1);color:#fff;border:none;padding:5px;border-radius:8px;font-weight:700;font-size:.68rem;cursor:pointer">ğŸ“</button><button onclick="event.stopPropagation();delMT('+mt.id+')" style="background:var(--rs);color:var(--red);border:none;padding:5px 8px;border-radius:8px;font-weight:700;font-size:.68rem;cursor:pointer">ğŸ—‘</button></div></div>';}).join('');}
async function delMT(id){if(!confirm('à¦®à§à¦›à¦¬à§‡à¦¨?'))return;await SB.from('model_test_results').delete().eq('model_test_id',id);await SB.from('model_tests').delete().eq('id',id);selMTId=null;hide('mtEntry');loadModelTests();loadMTDropdown();}
async function selectMT(id){selMTId=id;var mt=(await SB.from('model_tests').select('*').eq('id',id).single()).data;if(!mt)return;selMTData=mt;var subs=mt.subjects||[];var tm=subs.reduce(function(a,s){return a+s.max;},0);g('mtSelName').innerText=mt.test_name;g('mtSelInfo').innerText=fd(mt.test_date)+' | '+mt.class+' | à¦®à§‹à¦Ÿ:'+tm;g('mtSelSubs').innerHTML=subs.map(function(s){return'<span style="background:#fff;color:var(--amber);padding:3px 8px;border-radius:6px;font-size:.65rem;font-weight:700;border:1px solid #fde68a">'+e(s.name)+' ('+s.max+')</span>';}).join('');show('mtEntry');var q=SB.from('students').select('*');if(mt.class!=='All')q=q.eq('class',mt.class);if(mt.batch!=='All')q=q.eq('batch',mt.batch);var r1=await q.order('roll_no');var r2=await SB.from('model_test_results').select('*').eq('model_test_id',id);g('mtMarksHead').innerHTML='<tr><th style="text-align:left;min-width:100px">à¦¨à¦¾à¦®</th><th>à¦°à§‹à¦²</th>'+subs.map(function(s){return'<th>'+e(s.name)+'<br><span style="font-weight:400;font-size:.6rem">('+s.max+')</span></th>';}).join('')+'<th>à¦®à§‹à¦Ÿ</th><th>%</th><th>à¦—à§à¦°à§‡à¦¡</th></tr>';g('mtMarksBody').innerHTML=(r1.data||[]).map(function(s){var res=r2.data&&r2.data.find(function(x){return x.student_id===s.id;});var sm=res?res.subject_marks:{};return'<tr><td style="text-align:left;font-weight:700;font-size:.75rem">'+e(s.name)+'</td><td style="text-align:center;font-size:.72rem">'+s.roll_no+'</td>'+subs.map(function(sub){return'<td style="text-align:center"><input type="number" id="mt-'+s.id+'-'+sub.name.replace(/\s/g,'_')+'" class="marks-inp" style="width:50px" value="'+(sm[sub.name]!==undefined?sm[sub.name]:'')+'" max="'+sub.max+'"></td>';}).join('')+'<td id="mtt-'+s.id+'" style="text-align:center;font-weight:700;color:var(--g1)">â€”</td><td id="mtp-'+s.id+'" style="text-align:center;font-weight:700">â€”</td><td id="mtg-'+s.id+'" style="text-align:center;font-weight:700">â€”</td></tr>';}).join('');g('mtMarksBody').querySelectorAll('.marks-inp').forEach(function(inp){inp.addEventListener('input',function(){calcMTRow(this);});});(r1.data||[]).forEach(function(s){calcMTRowById(s.id,subs,tm);});g('mtEntry').scrollIntoView({behavior:'smooth'});}
function calcMTRow(inp){if(!selMTData)return;var subs=selMTData.subjects||[];var tm=subs.reduce(function(a,s){return a+s.max;},0);var sid=inp.id.split('-')[1];var total=0;subs.forEach(function(sub){var el=g('mt-'+sid+'-'+sub.name.replace(/\s/g,'_'));if(el&&el.value)total+=parseFloat(el.value)||0;});var pct=tm>0?Math.round((total/tm)*100):0;var gr=calcGrade(pct);g('mtt-'+sid).innerText=total;g('mtp-'+sid).innerText=pct+'%';g('mtg-'+sid).innerHTML='<span style="color:'+gr.color+'">'+gr.grade+'</span>';}
function calcMTRowById(sid,subs,tm){var total=0;subs.forEach(function(sub){var el=g('mt-'+sid+'-'+sub.name.replace(/\s/g,'_'));if(el&&el.value)total+=parseFloat(el.value)||0;});var pct=tm>0?Math.round((total/tm)*100):0;var gr=calcGrade(pct);if(g('mtt-'+sid))g('mtt-'+sid).innerText=total;if(g('mtp-'+sid))g('mtp-'+sid).innerText=pct+'%';if(g('mtg-'+sid))g('mtg-'+sid).innerHTML='<span style="color:'+gr.color+'">'+gr.grade+'</span>';}
async function saveMTMarks(){if(!selMTId||!selMTData)return;var subs=selMTData.subjects||[];var tm=subs.reduce(function(a,s){return a+s.max;},0);var rows=g('mtMarksBody').querySelectorAll('tr');var recs=[];rows.forEach(function(tr){var inps=tr.querySelectorAll('.marks-inp');if(!inps.length)return;var sid=parseInt(inps[0].id.split('-')[1],10);var sm={};var total=0;var hasAny=false;subs.forEach(function(sub,i){if(inps[i]&&inps[i].value!==''){sm[sub.name]=parseFloat(inps[i].value)||0;total+=sm[sub.name];hasAny=true;}});if(hasAny){var pct=tm>0?Math.round((total/tm)*100):0;recs.push({model_test_id:selMTId,student_id:sid,subject_marks:sm,total_marks:total,percentage:pct,grade:calcGrade(pct).grade});}});if(!recs.length){alert('à¦¨à¦®à§à¦¬à¦° à¦¦à¦¿à¦¨!');return;}recs.sort(function(a,b){return b.total_marks-a.total_marks;});recs.forEach(function(r,i){r.merit_position=i+1;});var r=await SB.from('model_test_results').upsert(recs,{onConflict:'model_test_id,student_id'});if(r.error)alert(r.error.message);else alert('âœ… à¦¸à§‡à¦­ + à¦®à§‡à¦°à¦¿à¦Ÿ!');}

/* PRINT MT */
function printMTResult(){if(!selMTId||!selMTData)return;var mt=selMTData,subs=mt.subjects||[];var tm=subs.reduce(function(a,s){return a+s.max;},0);var rows=[];g('mtMarksBody').querySelectorAll('tr').forEach(function(tr){var tds=tr.querySelectorAll('td');var inps=tr.querySelectorAll('.marks-inp');if(!inps.length)return;var name=tds[0].innerText,roll=tds[1].innerText;var sm={};var total=0;var hasAny=false;subs.forEach(function(sub,i){if(inps[i]&&inps[i].value!==''){sm[sub.name]=parseFloat(inps[i].value)||0;total+=sm[sub.name];hasAny=true;}});if(hasAny)rows.push({name:name,roll:roll,sm:sm,total:total,pct:tm>0?Math.round((total/tm)*100):0,grade:calcGrade(tm>0?Math.round((total/tm)*100):0).grade});});rows.sort(function(a,b){return b.total-a.total;});rows.forEach(function(r,i){r.merit=i+1;});var html='<div class="print-sheet"><h1>UBIQUE</h1><div class="subtitle">'+e(mt.test_name)+' â€” '+fd(mt.test_date)+' | '+e(mt.class)+'</div><table><thead><tr><th>à¦®à§‡à¦°à¦¿à¦Ÿ</th><th style="text-align:left">à¦¨à¦¾à¦®</th><th>à¦°à§‹à¦²</th>'+subs.map(function(s){return'<th>'+e(s.name)+'<br>('+s.max+')</th>';}).join('')+'<th>à¦®à§‹à¦Ÿ<br>('+tm+')</th><th>%</th><th>à¦—à§à¦°à§‡à¦¡</th></tr></thead><tbody>'+rows.map(function(r){var mc=r.merit<=3?' class="merit-'+r.merit+'"':'';return'<tr'+mc+'><td style="font-weight:700">'+r.merit+'</td><td class="name-cell">'+e(r.name)+'</td><td>'+r.roll+'</td>'+subs.map(function(s){return'<td>'+(r.sm[s.name]!==undefined?r.sm[s.name]:'â€”')+'</td>';}).join('')+'<td style="font-weight:700;color:#6366f1">'+r.total+'</td><td style="font-weight:700">'+r.pct+'%</td><td><strong>'+r.grade+'</strong></td></tr>';}).join('')+'</tbody></table><div class="grade-box"><div>A+ (80%â†‘)</div><div>A (70%â†‘)</div><div>B (60%â†‘)</div><div>C (50%â†‘)</div><div>D (40%â†‘)</div><div>F (&lt;40%)</div></div><div class="stamp-area"><div>à¦ªà¦°à§€à¦•à§à¦·à¦•<span>à¦¸à§à¦¬à¦¾à¦•à§à¦·à¦°</span></div><div>à¦ªà§à¦°à¦§à¦¾à¦¨ à¦¶à¦¿à¦•à§à¦·à¦•<span>à¦¸à§à¦¬à¦¾à¦•à§à¦·à¦° à¦“ à¦¸à¦¿à¦²</span></div></div><div class="footer"><span>'+new Date().toLocaleDateString('bn-BD')+'</span><span>UBIQUE SMS</span></div></div>';doPrint(html);}

function printMTCards(){if(!selMTId||!selMTData)return;var mt=selMTData,subs=mt.subjects||[];var tm=subs.reduce(function(a,s){return a+s.max;},0);var rows=[];g('mtMarksBody').querySelectorAll('tr').forEach(function(tr){var tds=tr.querySelectorAll('td');var inps=tr.querySelectorAll('.marks-inp');if(!inps.length)return;var name=tds[0].innerText,roll=tds[1].innerText;var sm={};var total=0;var hasAny=false;subs.forEach(function(sub,i){if(inps[i]&&inps[i].value!==''){sm[sub.name]=parseFloat(inps[i].value)||0;total+=sm[sub.name];hasAny=true;}});if(hasAny){var pct=tm>0?Math.round((total/tm)*100):0;rows.push({name:name,roll:roll,sm:sm,total:total,pct:pct,grade:calcGrade(pct)});}});rows.sort(function(a,b){return b.total-a.total;});rows.forEach(function(r,i){r.merit=i+1;});var html=rows.map(function(r){var c='<div class="print-card"><div class="header"><h1>UBIQUE</h1><p>'+e(mt.test_name)+' â€” '+fd(mt.test_date)+'</p></div><div class="student-info"><div><span class="label">à¦¨à¦¾à¦®:</span><span class="value">'+e(r.name)+'</span></div><div><span class="label">à¦°à§‹à¦²:</span><span class="value">'+r.roll+'</span></div><div><span class="label">à¦•à§à¦²à¦¾à¦¸:</span><span class="value">'+e(mt.class)+'</span></div><div><span class="label">à¦®à§‡à¦°à¦¿à¦Ÿ:</span><span class="value" style="color:#6366f1;font-size:12pt">'+r.merit+'</span></div></div><table><thead><tr><th style="text-align:left">à¦¬à¦¿à¦·à¦¯à¦¼</th><th>à¦¸à¦°à§à¦¬à§‹à¦šà§à¦š</th><th>à¦ªà§à¦°à¦¾à¦ªà§à¦¤</th><th>à¦—à§à¦°à§‡à¦¡</th></tr></thead><tbody>';subs.forEach(function(s){var m=r.sm[s.name]||0;var g2=calcGrade((m/s.max)*100);c+='<tr><td style="text-align:left;font-weight:600">'+e(s.name)+'</td><td>'+s.max+'</td><td style="font-weight:700">'+m+'</td><td style="color:'+g2.color+';font-weight:700">'+g2.grade+'</td></tr>';});c+='<tr style="background:#f1f5f9;font-weight:700"><td style="text-align:left">à¦®à§‹à¦Ÿ</td><td>'+tm+'</td><td style="color:#6366f1">'+r.total+'</td><td>'+r.grade.grade+'</td></tr></tbody></table><div class="summary"><div style="background:#f0fdf4;border-color:#bbf7d0"><p class="s-label">à¦®à§‹à¦Ÿ</p><p class="s-value" style="color:#065f46">'+r.total+'/'+tm+'</p></div><div style="background:#eff6ff;border-color:#bfdbfe"><p class="s-label">à¦¶à¦¤à¦¾à¦‚à¦¶</p><p class="s-value" style="color:#1e40af">'+r.pct+'%</p></div><div style="background:#f5f3ff;border-color:#ddd6fe"><p class="s-label">à¦—à§à¦°à§‡à¦¡</p><p class="s-value" style="color:#6366f1">'+r.grade.grade+'</p></div><div style="background:#fefce8;border-color:#fde68a"><p class="s-label">à¦®à§‡à¦°à¦¿à¦Ÿ</p><p class="s-value" style="color:#92400e">'+r.merit+'</p></div></div><p style="text-align:center;font-size:8pt;color:#64748b;font-weight:700">'+r.grade.label+'</p><div class="stamp-area"><div>à¦…à¦­à¦¿à¦­à¦¾à¦¬à¦•<span>à¦¸à§à¦¬à¦¾à¦•à§à¦·à¦°</span></div><div>à¦¶à§à¦°à§‡à¦£à¦¿ à¦¶à¦¿à¦•à§à¦·à¦•<span>à¦¸à§à¦¬à¦¾à¦•à§à¦·à¦°</span></div><div>à¦ªà§à¦°à¦§à¦¾à¦¨ à¦¶à¦¿à¦•à§à¦·à¦•<span>à¦¸à§à¦¬à¦¾à¦•à§à¦·à¦° à¦“ à¦¸à¦¿à¦²</span></div></div></div>';return c;}).join('');doPrint(html);}
async function doPrint(html){var pa=g('printArea');pa.innerHTML=html;pa.classList.remove('hidden');setTimeout(function(){window.print();setTimeout(function(){pa.classList.add('hidden');pa.innerHTML='';},500);},300);}

/* MT RESULTS */
async function loadMTDropdown(){var r=await SB.from('model_tests').select('id,test_name,test_date').order('test_date',{ascending:false});g('mtResSelect').innerHTML='<option value="">-- à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨ --</option>'+(r.data||[]).map(function(mt){return'<option value="'+mt.id+'">'+e(mt.test_name)+' ('+fd(mt.test_date)+')</option>';}).join('');}
async function loadMTResults(){var id=gv('mtResSelect');if(!id){g('mtResHead').innerHTML='';g('mtResBody').innerHTML='';hide('mtResultStats');return;}var mt=(await SB.from('model_tests').select('*').eq('id',id).single()).data;if(!mt)return;var subs=mt.subjects||[];var r=await SB.from('model_test_results').select('*,students(name,roll_no)').eq('model_test_id',id).order('merit_position');g('mtResHead').innerHTML='<tr><th>à¦®à§‡à¦°à¦¿à¦Ÿ</th><th style="text-align:left">à¦¨à¦¾à¦®</th><th>à¦°à§‹à¦²</th>'+subs.map(function(s){return'<th>'+e(s.name)+'</th>';}).join('')+'<th>à¦®à§‹à¦Ÿ</th><th>%</th><th>à¦—à§à¦°à§‡à¦¡</th></tr>';var pass=0,fail=0,highest=0;g('mtResBody').innerHTML=(r.data||[]).map(function(res){var s=res.students;if(!s)return'';var sm=res.subject_marks||{};var gr=calcGrade(res.percentage);if(gr.grade!=='F')pass++;else fail++;if(res.total_marks>highest)highest=res.total_marks;var mc=res.merit_position<=3?' class="merit-'+res.merit_position+'"':'';return'<tr'+mc+'><td style="font-weight:700;text-align:center">'+res.merit_position+'</td><td style="text-align:left;font-weight:700">'+e(s.name)+'</td><td style="text-align:center">'+s.roll_no+'</td>'+subs.map(function(sub){return'<td style="text-align:center">'+(sm[sub.name]!==undefined?sm[sub.name]:'â€”')+'</td>';}).join('')+'<td style="text-align:center;font-weight:700;color:var(--g1)">'+res.total_marks+'</td><td style="text-align:center;font-weight:700">'+res.percentage+'%</td><td style="text-align:center"><span style="color:'+gr.color+';font-weight:700">'+gr.grade+'</span></td></tr>';}).join('');var avg=(r.data||[]).length>0?Math.round((r.data||[]).reduce(function(a,x){return a+x.percentage;},0)/r.data.length):0;function mkC(bg,bc,lbl,val,col){return'<div style="background:'+bg+';border:1.5px solid '+bc+';border-radius:12px;padding:12px;text-align:center"><p style="font-size:.55rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:2px">'+lbl+'</p><p style="font-size:1.3rem;font-weight:700;color:'+col+";font-family:'Sora',sans-serif\">"+val+'</p></div>';}g('mtResultStats').innerHTML=mkC('#f0fdf4','#bbf7d0','à¦ªà¦¾à¦¸',pass,'var(--green)')+mkC('#fff1f2','#fecdd3','à¦«à§‡à¦²',fail,'var(--red)')+mkC('#eff6ff','#bfdbfe','à¦—à¦¡à¦¼',avg+'%','var(--g1)')+mkC('#fefce8','#fde68a','à¦¸à¦°à§à¦¬à§‹à¦šà§à¦š',highest,'var(--amber)');show('mtResultStats');}

/* REPORT */
async function loadRep(){var mi=gv('rMo'),cls=gv('rCl'),bch=gv('rBt');if(!mi){alert('à¦®à¦¾à¦¸ à¦¦à¦¿à¦¨!');return;}show('rLd');g('rH').innerHTML='';g('rB').innerHTML='';hide('rS');hide('xBtn');var p=mi.split('-').map(Number),yyyy=p[0],mm=p[1],dim=new Date(yyyy,mm,0).getDate();var q=SB.from('students').select('*');if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);var r1=await q.order('roll_no');if(!r1.data||!r1.data.length){hide('rLd');g('rB').innerHTML='<tr><td colspan="100" style="text-align:center;padding:26px;color:var(--muted)">à¦¨à§‡à¦‡</td></tr>';return;}var dates=[];for(var d=1;d<=dim;d++)dates.push(yyyy+'-'+String(mm).padStart(2,'0')+'-'+String(d).padStart(2,'0'));var r2=await SB.from('attendance').select('student_id,attendance_date,status').in('student_id',r1.data.map(function(s){return s.id;})).gte('attendance_date',dates[0]).lte('attendance_date',dates[dates.length-1]);var aM={};if(r2.data)r2.data.forEach(function(a){aM[a.student_id+'_'+a.attendance_date]=a.status;});g('rH').innerHTML='<tr><th style="text-align:left;position:sticky;left:0;z-index:5;min-width:110px">à¦¨à¦¾à¦®</th><th>à¦°à§‹à¦²</th>'+dates.map(function(_,i){return'<th>'+(i+1)+'</th>';}).join('')+'<th>âœ…</th><th>âŒ</th></tr>';var gP=0,gA=0,rows=[];g('rB').innerHTML=r1.data.map(function(s){var tp=0,ta=0;var cells=dates.map(function(dt){var st=aM[s.id+'_'+dt];if(st==='Present'){tp++;return'<td class="pc">P</td>';}if(st==='Absent'){ta++;return'<td class="ac">A</td>';}return'<td style="text-align:center;color:#cbd5e1">â€“</td>';}).join('');gP+=tp;gA+=ta;var row={name:s.name,roll:s.roll_no,class:s.class,batch:s.batch};dates.forEach(function(dt,i){row['d'+(i+1)]=aM[s.id+'_'+dt]||'-';});row.tp=tp;row.ta=ta;rows.push(row);return'<tr><td style="position:sticky;left:0;background:#fff;z-index:4;font-weight:700;border-right:1px solid #e0e7ff">'+e(s.name)+'</td><td style="text-align:center;color:var(--muted);font-size:.72rem">'+s.roll_no+'</td>'+cells+'<td class="tc">'+tp+'</td><td class="ac">'+ta+'</td></tr>';}).join('');hide('rLd');repData={students:r1.data,dates:dates,rows:rows,yyyy:yyyy,mm:String(mm).padStart(2,'0')};var avg=r1.data.length>0?Math.round((gP/(r1.data.length*dates.length))*100):0;function mkC(bg,bc,lbl,val,col){return'<div style="background:'+bg+';border:1.5px solid '+bc+';border-radius:12px;padding:13px;text-align:center"><p style="font-size:.58rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:2px">'+lbl+'</p><p style="font-size:1.6rem;font-weight:700;color:'+col+";font-family:'Sora',sans-serif\">"+val+'</p></div>';}g('rS').innerHTML=mkC('#eff6ff','#bfdbfe','à¦®à§‹à¦Ÿ',r1.data.length,'var(--g1)')+mkC('#f0fdf4','#bbf7d0','à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤',gP,'var(--green)')+mkC('#fff1f2','#fecdd3','à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤',gA,'var(--red)')+mkC('#f5f3ff','#ddd6fe','à¦—à¦¡à¦¼',avg+'%','var(--g2)');show('rS');show('xBtn');}
function exportXls(){if(!repData)return;var hdr=['à¦¨à¦¾à¦®','à¦°à§‹à¦²','à¦•à§à¦²à¦¾à¦¸','à¦¬à§à¦¯à¦¾à¦š'];repData.dates.forEach(function(_,i){hdr.push(String(i+1));});hdr.push('à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤','à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤');var data=repData.rows.map(function(r){var c=[r.name,r.roll,r.class,r.batch];repData.dates.forEach(function(_,i){c.push(r['d'+(i+1)]);});c.push(r.tp,r.ta);return c;});var ws=XLSX.utils.aoa_to_sheet([hdr].concat(data));var wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Report');XLSX.writeFile(wb,'Report_'+repData.yyyy+'-'+repData.mm+'.xlsx');}

/* SETTINGS */
async function loadSetS(){
  var cls=gv('sCl'),bch=gv('sBt');
  var q=SB.from('students').select('*');
  if(cls!=='All')q=q.eq('class',cls);
  if(bch!=='All')q=q.eq('batch',bch);
  var r=await q.order('roll_no');
  var el=g('setL');
  if(!r.data||!r.data.length){el.innerHTML='<p style="text-align:center;color:var(--muted);padding:13px">à¦¨à§‡à¦‡</p>';return;}
  r.data.forEach(function(s){stuCache[s.id]=s;});
  el.innerHTML='';
  r.data.forEach(function(s){
    var row=document.createElement('div');
    row.style.cssText='background:#f8faff;padding:10px 12px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid #e0e7ff;margin-bottom:6px';
    row.dataset.sid=s.id;
    row.dataset.name=s.name.toLowerCase();
    row.dataset.roll=s.roll_no;
    var info=document.createElement('div');
    info.innerHTML='<span style="font-weight:700">'+e(s.name)+'</span> <span style="font-size:.68rem;color:var(--muted)">'+e(s.class)+' à¦°à§‹à¦²:'+s.roll_no+'</span>';
    var btns=document.createElement('div');
    btns.style.cssText='display:flex;gap:4px';
    var editBtn=document.createElement('button');
    editBtn.textContent='à¦à¦¡à¦¿à¦Ÿ';
    editBtn.style.cssText='font-size:.7rem;color:var(--g1);font-weight:700;padding:4px 9px;background:#eff6ff;border:none;border-radius:8px;cursor:pointer';
    editBtn.onclick=function(){editSwitch(stuCache[s.id]);};
    var delBtn=document.createElement('button');
    delBtn.textContent='à¦®à§à¦›à§à¦¨';
    delBtn.style.cssText='font-size:.7rem;color:var(--red);font-weight:700;padding:4px 9px;background:var(--rs);border:none;border-radius:8px;cursor:pointer';
    delBtn.onclick=function(){delStu(s.id);};
    btns.appendChild(editBtn);
    btns.appendChild(delBtn);
    row.appendChild(info);
    row.appendChild(btns);
    el.appendChild(row);
  });
}

async function addSet(type){var el=g(type==='class'?'nCl':'nBt'),val=el.value.trim();if(!val)return;await SB.from('academy_settings').insert([{type:type,value:val}]);el.value='';syncDrops();}
async function delSet(id){if(!confirm('à¦®à§à¦›à¦¬à§‡à¦¨?'))return;await SB.from('academy_settings').delete().eq('id',id);syncDrops();}
async function delStu(id){protect(async function(){if(!confirm('âš ï¸ à¦¸à¦¬ à¦¡à§‡à¦Ÿà¦¾ à¦®à§à¦›à§‡ à¦¯à¦¾à¦¬à§‡!'))return;await SB.from('attendance').delete().eq('student_id',id);await SB.from('fees_collection').delete().eq('student_id',id);await SB.from('exam_results').delete().eq('student_id',id);await SB.from('model_test_results').delete().eq('student_id',id);await SB.from('students').delete().eq('id',id);syncDrops();});}

/* TEACHER */
async function loadTDrops(){var tcls=localStorage.getItem('ub_tcls')||'All';var r=await SB.from('academy_settings').select('*').order('value');if(!r.data)return;var cls=r.data.filter(function(i){return i.type==='class';}),bch=r.data.filter(function(i){return i.type==='batch';});var cO=tcls!=='All'?'<option value="'+e(tcls)+'">'+e(tcls)+'</option>':'<option value="All">à¦¸à¦¬</option>'+cls.map(function(x){return'<option>'+e(x.value)+'</option>';}).join('');var bO='<option value="All">à¦¸à¦¬</option>'+bch.map(function(x){return'<option>'+e(x.value)+'</option>';}).join('');['tCl','tPCl','tRCl','tExCl'].forEach(function(id){var el=g(id);if(el)el.innerHTML=cO;});['tBt','tPBt','tRBt','tExBt'].forEach(function(id){var el=g(id);if(el)el.innerHTML=bO;});loadTS();}
async function loadTS(){var tcls=localStorage.getItem('ub_tcls')||'All';var cls=gv('tCl')||tcls,bch=gv('tBt')||'All',sn=(gv('tSr')||'').toLowerCase();var today=new Date().toISOString().split('T')[0];var q=SB.from('students').select('id,name,roll_no,class,batch');if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);var r1=await q.order('roll_no'),r2=await SB.from('attendance').select('student_id,status,homework_status').eq('attendance_date',today);g('tSL').innerHTML=(r1.data||[]).filter(function(s){return s.name.toLowerCase().includes(sn);}).map(function(s){var rec=r2.data&&r2.data.find(function(x){return x.student_id===s.id;});var pA=TAD[s.id]==='Present'||(!TAD[s.id]&&rec&&rec.status==='Present');var aA=TAD[s.id]==='Absent'||(!TAD[s.id]&&rec&&rec.status==='Absent');var yA=THD[s.id]==='Yes'||(!THD[s.id]&&rec&&rec.homework_status==='Yes');var nA=THD[s.id]==='No'||(!THD[s.id]&&rec&&rec.homework_status==='No');return'<div class="sr fi"><div class="sr-top"><div style="flex:1"><p style="font-weight:700;font-size:.84rem">'+e(s.name)+'</p><p style="font-size:.63rem;color:var(--muted)">à¦°à§‹à¦²:'+s.roll_no+'</p></div><div style="display:flex;gap:4px"><button id="tp-'+s.id+'" onclick="tMA(\''+s.id+'\',\'Present\')" class="ab pb'+(pA?' on':'')+'">P</button><button id="ta-'+s.id+'" onclick="tMA(\''+s.id+'\',\'Absent\')" class="ab xb'+(aA?' on':'')+'">A</button></div></div><div class="sr-bot"><span style="flex:1"></span><div style="display:flex;align-items:center;gap:4px"><span style="font-size:.55rem;font-weight:700;color:#94a3b8">HW</span><button id="ty-'+s.id+'" onclick="tMH(\''+s.id+'\',\'Yes\')" class="ab yb'+(yA?' on':'')+'">Y</button><button id="tn-'+s.id+'" onclick="tMH(\''+s.id+'\',\'No\')" class="ab nb'+(nA?' on':'')+'">N</button></div></div></div>';}).join('')||'<p style="text-align:center;padding:26px;color:var(--muted)">à¦¨à§‡à¦‡</p>';}
function tMA(id,s){TAD[id]=s;g('tp-'+id).className='ab pb'+(s==='Present'?' on':'');g('ta-'+id).className='ab xb'+(s==='Absent'?' on':'');}
function tMH(id,s){THD[id]=s;g('ty-'+id).className='ab yb'+(s==='Yes'?' on':'');g('tn-'+id).className='ab nb'+(s==='No'?' on':'');}
async function subTAtt(){var today=new Date().toISOString().split('T')[0];var ids=[...new Set([...Object.keys(TAD),...Object.keys(THD)])];if(!ids.length){alert('à¦®à¦¾à¦°à§à¦• à¦•à¦°à§à¦¨!');return;}var recs=ids.map(function(id){return{student_id:parseInt(id,10),attendance_date:today,status:TAD[id]||'Absent',homework_status:THD[id]||null};});await SB.from('attendance').upsert(recs,{onConflict:'student_id,attendance_date'});alert('âœ…');TAD={};THD={};loadTS();}
  
async function loadTP(){
  var tcls=localStorage.getItem('ub_tcls')||'All';
  var cls=gv('tPCl')||tcls,bch=gv('tPBt')||'All',sn=(gv('tPSr')||'').toLowerCase();
  if(!cls||cls==='')cls=tcls;
  var el=g('tPL');
  if(cls==='All'&&bch==='All'&&tcls==='All'){el.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted)"><p style="font-size:2rem">âš ï¸</p><p style="font-weight:700;font-size:.875rem">à¦•à§à¦²à¦¾à¦¸ à¦¬à¦¾ à¦¬à§à¦¯à¦¾à¦š à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ à¦•à¦°à§à¦¨</p></div>';return;}
  el.innerHTML='<div class="sk" style="height:56px"></div><div class="sk" style="height:56px"></div>';
  var q=SB.from('students').select('*');
  if(cls!=='All')q=q.eq('class',cls);
  if(bch!=='All')q=q.eq('batch',bch);
  var r=await q.order('roll_no');
  var el2=g('tPL');
  if(r.error){el2.innerHTML='<p style="text-align:center;padding:22px;color:var(--red)">âš ï¸ '+r.error.message+'</p>';return;}
  var list=(r.data||[]).filter(function(s){return s.name.toLowerCase().includes(sn);});
  list.forEach(function(s){stuCache[s.id]=s;});
  if(!list.length){el2.innerHTML='<p style="text-align:center;padding:22px;color:var(--muted)">à¦•à§‹à¦¨à§‹ à¦¶à¦¿à¦•à§à¦·à¦¾à¦°à§à¦¥à§€ à¦¨à§‡à¦‡</p>';el2.onclick=null;return;}
  el2.innerHTML=list.map(function(s){
    var hn=s.problem_note&&s.problem_note.trim();
    return '<div class="sr fi'+(hn?' hn':'')+'" style="cursor:pointer" onclick="tpOpenNote('+s.id+')"><div class="sr-top"><div style="flex:1;min-width:0"><p style="font-weight:700;color:var(--ink2)">'+e(s.name)+'</p><p style="font-size:.63rem;color:var(--muted)">'+e(s.class)+' | à¦°à§‹à¦²: '+s.roll_no+'</p>'+(hn?'<p style="font-size:.66rem;color:var(--orange);margin-top:2px">âš ï¸ '+e(s.problem_note.substring(0,40))+'</p>':'<p style="font-size:.66rem;color:#cbd5e1;margin-top:2px">à¦¨à§‹à¦Ÿ à¦¨à§‡à¦‡ â€” à¦Ÿà§à¦¯à¦¾à¦ª à¦•à¦°à§à¦¨</p>')+'</div><span style="font-size:1.2rem;flex-shrink:0;padding:4px">'+(hn?'âœï¸':'â•')+'</span></div></div>';
  }).join('');
}

async function loadTExams(){var cls=gv('tExCl')||localStorage.getItem('ub_tcls')||'All';var bch=gv('tExBt')||'All';var q=SB.from('exams').select('*').order('exam_date',{ascending:false});if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);var r=await q;g('tExList').innerHTML=(r.data||[]).map(function(ex){return'<div class="exam-card fi" onclick="selectTExam('+ex.id+',\''+e(ex.exam_name)+'\','+ex.total_marks+',\''+e(ex.class)+'\',\''+e(ex.batch||'All')+'\',\''+ex.exam_date+'\')"><p style="font-weight:700">'+e(ex.exam_name)+'</p><p style="font-size:.63rem;color:var(--muted)">'+fd(ex.exam_date)+' | '+ex.total_marks+'</p></div>';}).join('')||'<p style="text-align:center;padding:22px;color:var(--muted)">à¦¨à§‡à¦‡</p>';}
async function selectTExam(id,name,total,cls,bch,date){tSelExamId=id;tSelExamTotal=total;g('tExName').innerText=name;g('tExInfo').innerText=fd(date)+' | à¦¸à¦°à§à¦¬à§‹à¦šà§à¦š: '+total;show('tExEntry');var q=SB.from('students').select('*');if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);var r1=await q.order('roll_no');var r2=await SB.from('exam_results').select('*').eq('exam_id',id);g('tExStudents').innerHTML=(r1.data||[]).map(function(s){var res=r2.data&&r2.data.find(function(x){return x.student_id===s.id;});return'<div class="sr fi" style="flex-direction:row;align-items:center;gap:10px"><div style="flex:1"><p style="font-weight:700;font-size:.82rem">'+e(s.name)+'</p><p style="font-size:.6rem;color:var(--muted)">à¦°à§‹à¦²:'+s.roll_no+'</p></div><input type="number" id="tmk-'+s.id+'" class="marks-inp" value="'+(res?res.marks_obtained:'')+'" max="'+total+'"></div>';}).join('');}
async function saveTExMarks(){if(!tSelExamId)return;var inps=g('tExStudents').querySelectorAll('.marks-inp');var recs=[];inps.forEach(function(inp){var sid=parseInt(inp.id.replace('tmk-',''),10);if(inp.value!==''){var m=Math.min(parseFloat(inp.value)||0,tSelExamTotal);recs.push({exam_id:tSelExamId,student_id:sid,marks_obtained:m,grade:calcGrade((m/tSelExamTotal)*100).grade});}});if(!recs.length)return;await SB.from('exam_results').upsert(recs,{onConflict:'exam_id,student_id'});alert('âœ…');}
async function loadTR(){var mi=gv('tRMo'),cls=gv('tRCl'),bch=gv('tRBt');if(!mi)return;show('tRL');g('tRH').innerHTML='';g('tRB').innerHTML='';hide('tRS');var p=mi.split('-').map(Number),yyyy=p[0],mm=p[1],dim=new Date(yyyy,mm,0).getDate();var q=SB.from('students').select('*');if(cls!=='All')q=q.eq('class',cls);if(bch!=='All')q=q.eq('batch',bch);var r1=await q.order('roll_no');if(!r1.data||!r1.data.length){hide('tRL');return;}var dates=[];for(var d=1;d<=dim;d++)dates.push(yyyy+'-'+String(mm).padStart(2,'0')+'-'+String(d).padStart(2,'0'));var r2=await SB.from('attendance').select('student_id,attendance_date,status').in('student_id',r1.data.map(function(s){return s.id;})).gte('attendance_date',dates[0]).lte('attendance_date',dates[dates.length-1]);var aM={};if(r2.data)r2.data.forEach(function(a){aM[a.student_id+'_'+a.attendance_date]=a.status;});g('tRH').innerHTML='<tr><th style="text-align:left;position:sticky;left:0;z-index:5;min-width:100px">à¦¨à¦¾à¦®</th><th>à¦°à§‹à¦²</th>'+dates.map(function(_,i){return'<th>'+(i+1)+'</th>';}).join('')+'<th>âœ…</th><th>âŒ</th></tr>';var gP=0,gA=0;g('tRB').innerHTML=r1.data.map(function(s){var tp=0,ta=0;var cells=dates.map(function(dt){var st=aM[s.id+'_'+dt];if(st==='Present'){tp++;return'<td class="pc">P</td>';}if(st==='Absent'){ta++;return'<td class="ac">A</td>';}return'<td style="text-align:center;color:#cbd5e1">â€“</td>';}).join('');gP+=tp;gA+=ta;return'<tr><td style="position:sticky;left:0;background:#fff;z-index:4;font-weight:700;border-right:1px solid #e0e7ff">'+e(s.name)+'</td><td style="text-align:center;color:var(--muted);font-size:.72rem">'+s.roll_no+'</td>'+cells+'<td class="tc">'+tp+'</td><td class="ac">'+ta+'</td></tr>';}).join('');hide('tRL');var avg=r1.data.length>0?Math.round((gP/(r1.data.length*dates.length))*100):0;function mkC(bg,bc,lbl,val,col){return'<div style="background:'+bg+';border:1.5px solid '+bc+';border-radius:12px;padding:12px;text-align:center"><p style="font-size:.58rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:2px">'+lbl+'</p><p style="font-size:1.5rem;font-weight:700;color:'+col+";font-family:'Sora',sans-serif\">"+val+'</p></div>';}g('tRS').innerHTML=mkC('#f0fdf4','#bbf7d0','à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤',gP,'var(--green)')+mkC('#fff1f2','#fecdd3','à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤',gA,'var(--red)')+mkC('#f5f3ff','#ddd6fe','à¦—à¦¡à¦¼',avg+'%','var(--g2)');show('tRS');}

/* STUDENT DASHBOARD */
async function renderStuDash(s){window._stuId=s.id;g('sdn').innerText=s.name;g('sdi').innerText=s.class+' | à¦°à§‹à¦²:'+s.roll_no;if(s.problem_note&&s.problem_note.trim()){show('spb');g('spt').innerText=s.problem_note;}var today=new Date().toISOString().split('T')[0];var r=await SB.from('attendance').select('homework_status').eq('student_id',s.id).eq('attendance_date',today).single();if(r.data&&r.data.homework_status!=null){show('shw');var b=g('shw');b.innerHTML=r.data.homework_status==='Yes'?'<p style="font-weight:700;color:#065f46">âœ… HW à¦œà¦®à¦¾ à¦¦à¦¿à¦¯à¦¼à§‡à¦›à§‡à¦¨</p>':'<p style="font-weight:700;color:#9f1239">âŒ HW à¦œà¦®à¦¾ à¦¦à§‡à¦¨à¦¨à¦¿</p>';b.style.cssText='padding:14px;border-radius:15px;'+(r.data.homework_status==='Yes'?'background:#dcfce7;border:1.5px solid #bbf7d0':'background:#ffe4e6;border:1.5px solid #fecdd3');}var yr=new Date().getFullYear().toString();var fR=await SB.from('fees_collection').select('payment_month').eq('student_id',s.id).eq('payment_year',yr);var paid=(fR.data||[]).map(function(f){return f.payment_month;});
var admMonth=s.admission_month||'January';
var admIdx=ALL_MONTHS.indexOf(admMonth);
if(admIdx<0)admIdx=0;
var curIdx=new Date().getMonth();
var expected=ALL_MONTHS.slice(admIdx,curIdx+1);
var due=expected.filter(function(m){return paid.indexOf(m)===-1;});if(due.length||paid.length){show('sFeeCard');g('sFeeCard').innerHTML='<h3 style="font-weight:700;font-size:.85rem;margin-bottom:8px">ğŸ’° à¦«à¦¿ ('+yr+')</h3>'+(due.length?'<div style="background:#ffe4e6;border-radius:10px;padding:8px 12px;margin-bottom:6px;border:1px solid #fecdd3"><p style="font-weight:700;color:#be123c;font-size:.8rem">âš ï¸ '+due.length+' à¦®à¦¾à¦¸ à¦¬à¦•à§‡à¦¯à¦¼à¦¾</p><div class="due-months-bar" style="margin-top:4px">'+due.map(function(m){return'<span class="due-month-chip">'+MONTH_BN[m]+'</span>';}).join('')+'</div></div>':'<p style="color:#065f46;font-weight:700">âœ… à¦¸à¦¬ à¦ à¦¿à¦•!</p>')+(paid.length?'<div class="due-months-bar" style="margin-top:6px">'+paid.map(function(m){return'<span class="paid-month-chip">âœ…'+MONTH_BN[m]+'</span>';}).join('')+'</div>':'');}
var stuEx=[];
// Fetch student's own results
var exR=await SB.from('exam_results').select('*,exams(exam_name,exam_date,total_marks,class,batch)').eq('student_id',s.id);
var mtR=await SB.from('model_test_results').select('*').eq('student_id',s.id);
// Fetch model_tests separately
var mtIds2=(mtR.data||[]).map(function(r){return r.model_test_id;});
var mtDetails={};
if(mtIds2.length){
  var mtDet=await SB.from('model_tests').select('id,test_name,test_date,subjects').in('id',mtIds2);
  (mtDet.data||[]).forEach(function(m){mtDetails[m.id]=m;});
}
// Attach model_tests data manually
(mtR.data||[]).forEach(function(r){r.model_tests=mtDetails[r.model_test_id]||null;});

// For each exam, also fetch ALL results to show class ranking
var examIds=(exR.data||[]).map(function(r){return r.exam_id;});
var mtIds=(mtR.data||[]).map(function(r){return r.model_test_id;});
var allExR=examIds.length?await SB.from('exam_results').select('student_id,marks_obtained,exam_id').in('exam_id',examIds):{data:[]};
var allMtR=mtIds.length?await SB.from('model_test_results').select('student_id,total_marks,percentage,model_test_id,merit_position').in('model_test_id',mtIds):{data:[]};

(exR.data||[]).forEach(function(r){
  if(!r.exams)return;
  // Build ranking for this exam
  var allForExam=(allExR.data||[]).filter(function(x){return x.exam_id===r.exam_id;});
  allForExam.sort(function(a,b){return b.marks_obtained-a.marks_obtained;});
  var myRank=allForExam.findIndex(function(x){return x.student_id===s.id;})+1;
  var total_students=allForExam.length;
  stuEx.push({type:'exam',exam_id:r.exam_id,name:r.exams.exam_name,date:r.exams.exam_date,marks:r.marks_obtained,total:r.exams.total_marks,pct:Math.round((r.marks_obtained/r.exams.total_marks)*100),grade:calcGrade((r.marks_obtained/r.exams.total_marks)*100),myRank:myRank,totalStudents:total_students,allResults:allForExam});
});

(mtR.data||[]).forEach(function(r){
  if(!r.model_tests)return;
  var subs=r.model_tests.subjects||[];
  var tm=subs.reduce(function(a,x){return a+x.max;},0);
  var allForMT=(allMtR.data||[]).filter(function(x){return x.model_test_id===r.model_test_id;});
  allForMT.sort(function(a,b){return b.total_marks-a.total_marks;});
  var myRank=r.merit_position||allForMT.findIndex(function(x){return x.student_id===s.id;})+1;
  stuEx.push({type:'model',model_test_id:r.model_test_id,name:r.model_tests.test_name,date:r.model_tests.test_date,marks:r.total_marks,total:tm,pct:r.percentage,grade:calcGrade(r.percentage),merit:r.merit_position,sm:r.subject_marks,subs:subs,myRank:myRank,totalStudents:allForMT.length});
});

stuEx.sort(function(a,b){return new Date(b.date)-new Date(a.date);});

g('stuExamList').innerHTML=stuEx.length?stuEx.map(function(ex){
  var isF=ex.grade.grade==='F';
  var rankColor=ex.myRank===1?'#f59e0b':ex.myRank===2?'#94a3b8':ex.myRank===3?'#b45309':'#6366f1';
  var rankBg=ex.myRank===1?'#fef9c3':ex.myRank===2?'#f1f5f9':ex.myRank===3?'#fef3c7':'#eff6ff';
  var html='<div style="border-radius:13px;padding:14px;'+(isF?'background:#ffe4e6;border:1.5px solid #fecdd3':'background:#f8faff;border:1.5px solid #e0e7ff')+'">';
  // Header row
  html+='<div style="display:flex;justify-content:space-between;align-items:flex-start">';
  html+='<div><p style="font-weight:700;font-size:.86rem">'+e(ex.name)+(ex.type==='model'?' ğŸ“„':'')+'</p><p style="font-size:.63rem;color:var(--muted)">'+fd(ex.date)+'</p></div>';
  html+='<div style="display:flex;gap:6px;align-items:center">';
  html+='<div style="padding:4px 10px;border-radius:99px;font-weight:700;font-size:.9rem;'+(isF?'background:#fecdd3;color:#9f1239':'background:#dcfce7;color:#065f46')+'">'+ex.grade.grade+'</div>';
  html+='</div></div>';
  // Subject breakdown for model test
  if(ex.type==='model'&&ex.subs){
    html+='<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px">';
    ex.subs.forEach(function(sub){var m=ex.sm[sub.name]||0;html+='<span style="background:rgba(255,255,255,.8);padding:2px 7px;border-radius:6px;font-size:.62rem;font-weight:700">'+e(sub.name)+':'+m+'/'+sub.max+'</span>';});
    html+='</div>';
  }
  // Stats row
  html+='<div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">';
  html+='<div style="background:rgba(255,255,255,.7);padding:6px 10px;border-radius:10px;text-align:center"><p style="font-size:.52rem;color:var(--muted);font-weight:700">à¦¨à¦®à§à¦¬à¦°</p><p style="font-size:1rem;font-weight:700">'+ex.marks+'/'+ex.total+'</p></div>';
  html+='<div style="background:rgba(255,255,255,.7);padding:6px 10px;border-radius:10px;text-align:center"><p style="font-size:.52rem;color:var(--muted);font-weight:700">%</p><p style="font-size:1rem;font-weight:700">'+ex.pct+'%</p></div>';
  if(ex.myRank){
    html+='<div style="background:'+rankBg+';padding:6px 10px;border-radius:10px;text-align:center;border:1.5px solid '+rankColor+'20"><p style="font-size:.52rem;font-weight:700;color:'+rankColor+'">à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨</p><p style="font-size:1rem;font-weight:700;color:'+rankColor+'">'+ex.myRank+'/'+ex.totalStudents+'</p></div>';
  }
  html+='</div>';
  // Mini leaderboard - top 3 + self if not in top 3
  if(ex.allResults&&ex.allResults.length>1){
    html+='<div style="margin-top:10px;background:rgba(255,255,255,.6);border-radius:10px;padding:8px">';
    html+='<p style="font-size:.6rem;font-weight:700;color:var(--muted);margin-bottom:6px">ğŸ† à¦¶à§€à¦°à§à¦· à¦«à¦²à¦¾à¦«à¦²</p>';
    var shown=[];
    var top=ex.allResults.slice(0,3);
    top.forEach(function(r,i){
      var isSelf=r.student_id===s.id;
      shown.push(r.student_id);
      html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 6px;border-radius:6px;'+(isSelf?'background:#eff6ff;border:1px solid #c7d2fe':'')+'">';
      html+='<span style="font-size:.68rem;font-weight:'+(isSelf?'700':'600')+';color:'+(isSelf?'#4f46e5':'#374151')+'">'+(i+1)+(i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':'ğŸ¥‰')+' '+(isSelf?'à¦†à¦ªà¦¨à¦¿ â˜…':'â€”')+'</span>';
      html+='<span style="font-size:.7rem;font-weight:700">'+r.marks_obtained+'</span>';
      html+='</div>';
    });
    // Show self if not in top 3
    if(ex.myRank>3){
      html+='<div style="border-top:1px dashed #e0e7ff;margin-top:4px;padding-top:4px;display:flex;justify-content:space-between;align-items:center;padding:3px 6px;border-radius:6px;background:#eff6ff;border:1px solid #c7d2fe">';
      html+='<span style="font-size:.68rem;font-weight:700;color:#4f46e5">'+ex.myRank+' à¦†à¦ªà¦¨à¦¿ â˜…</span>';
      html+='<span style="font-size:.7rem;font-weight:700">'+ex.marks+'</span>';
      html+='</div>';
    }
    html+='</div>';
  }
  html+='</div>';
  return html;
}).join(''):'<p style="text-align:center;color:var(--muted);padding:18px">à¦¨à§‡à¦‡</p>';
loadStuOnline(s.class,s.batch);
  var nR=await SB.from('notices').select('*').order('created_at',{ascending:false});g('sntc').innerHTML=(nR.data||[]).map(function(n){return'<div class="ni"><p style="font-weight:700">'+e(n.title)+'</p><p style="font-size:.76rem;color:var(--muted);margin-top:3px">'+e(n.content)+'</p><p style="font-size:.62rem;color:#94a3b8;margin-top:5px">'+fd(n.created_at)+'</p></div>';}).join('')||'<p style="text-align:center;color:var(--muted);padding:20px">à¦¨à§‡à¦‡</p>';}

/* INIT */
async function loadLoginCls(){var r=await SB.from('academy_settings').select('*').eq('type','class').order('value');g('sClass').innerHTML=(r.data||[]).length?'<option value="">-- à¦•à§à¦²à¦¾à¦¸ --</option>'+r.data.map(function(x){return'<option>'+e(x.value)+'</option>';}).join(''):'<option value="">à¦¨à§‡à¦‡</option>';}

// â”€â”€ BULK UPLOAD â”€â”€
var bulkData=[];
function dlTemplate(){
  var ws=XLSX.utils.aoa_to_sheet([['name','roll_no','class','batch','phone'],['à¦°à¦¹à¦¿à¦®','1','Cadet 26','Morning','01700000000']]);
  var wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Students');
  XLSX.writeFile(wb,'ubique_template.xlsx');
}
function parseBulkFile(input){
  var file=input.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var data=new Uint8Array(e.target.result);
      var wb=XLSX.read(data,{type:'array'});
      var ws=wb.Sheets[wb.SheetNames[0]];
      var rows=XLSX.utils.sheet_to_json(ws,{defval:''});
      if(!rows.length){alert('à¦«à¦¾à¦‡à¦²à§‡ à¦•à§‹à¦¨à§‹ à¦¡à¦¾à¦Ÿà¦¾ à¦¨à§‡à¦‡!');return;}
      bulkData=rows.map(function(r,i){
        return{
          name:(r.name||r.Name||r['à¦¨à¦¾à¦®']||'').toString().trim(),
          roll_no:parseInt(r.roll_no||r['à¦°à§‹à¦²']||r.roll||0),
          class:(r.class||r.Class||r['à¦•à§à¦²à¦¾à¦¸']||'').toString().trim(),
          batch:(r.batch||r.Batch||r['à¦¬à§à¦¯à¦¾à¦š']||'').toString().trim(),
          phone:(r.phone||r.Phone||r['à¦«à§‹à¦¨']||'').toString().trim(),
          _row:i+2,_ok:true,_err:''
        };
      });
      // Validate
      bulkData.forEach(function(r){
        if(!r.name){r._ok=false;r._err='à¦¨à¦¾à¦® à¦¨à§‡à¦‡';}
        else if(!r.roll_no){r._ok=false;r._err='à¦°à§‹à¦² à¦¨à§‡à¦‡';}
        else if(!r.class){r._ok=false;r._err='à¦•à§à¦²à¦¾à¦¸ à¦¨à§‡à¦‡';}
      });
      renderBulkPreview();
    }catch(err){alert('à¦«à¦¾à¦‡à¦² à¦ªà¦¡à¦¼à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾: '+err.message);}
  };
  reader.readAsArrayBuffer(file);
}
function renderBulkPreview(){
  var ok=bulkData.filter(function(r){return r._ok;}).length;
  var bad=bulkData.length-ok;
  g('bulkCount').innerText='à¦®à§‹à¦Ÿ: '+bulkData.length+' à¦œà¦¨ | âœ… '+ok+' à¦œà¦¨ à¦ªà§à¦°à¦¸à§à¦¤à§à¦¤'+(bad?' | âŒ '+bad+' à¦œà¦¨à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾':'');
  g('bulkTbody').innerHTML=bulkData.map(function(r){
    return'<tr style="border-bottom:1px solid #f1f5f9;background:'+(r._ok?'':'#fef2f2')+'">'+
      '<td style="padding:7px 10px;font-weight:600">'+e(r.name)+'</td>'+
      '<td style="padding:7px 10px">'+r.roll_no+'</td>'+
      '<td style="padding:7px 10px">'+e(r.class)+'</td>'+
      '<td style="padding:7px 10px">'+e(r.batch)+'</td>'+
      '<td style="padding:7px 10px">'+e(r.phone)+'</td>'+
      '<td style="padding:7px 10px;font-size:.7rem;font-weight:700;color:'+(r._ok?'var(--green)':'var(--red)')+'">'+
        (r._ok?'âœ… à¦ à¦¿à¦• à¦†à¦›à§‡':'âŒ '+r._err)+'</td></tr>';
  }).join('');
  g('bulkPreview').style.display='block';
}
function clearBulk(){bulkData=[];g('bulkPreview').style.display='none';g('bulkFile').value='';}
async function submitBulk(){
  var valid=bulkData.filter(function(r){return r._ok;});
  if(!valid.length){alert('à¦•à§‹à¦¨à§‹ à¦¬à§ˆà¦§ à¦¡à¦¾à¦Ÿà¦¾ à¦¨à§‡à¦‡!');return;}
  var btn=g('bulkSubmitBtn');btn.disabled=true;btn.innerText='â³ à¦†à¦ªà¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...';
  var done=0,fail=0;
  for(var i=0;i<valid.length;i++){
    var r=valid[i];
    var res=await SB.from('students').insert([{name:r.name,roll_no:r.roll_no,class:r.class,batch:r.batch,phone:r.phone}]);
    if(res.error)fail++;else done++;
    btn.innerText='â³ '+(i+1)+'/'+valid.length+' à¦†à¦ªà¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...';
  }
  btn.disabled=false;
  btn.innerText='âœ… à¦¸à¦¬à¦¾à¦‡à¦•à§‡ à¦­à¦°à§à¦¤à¦¿ à¦•à¦°à§à¦¨';
  alert('âœ… '+done+' à¦œà¦¨ à¦­à¦°à§à¦¤à¦¿ à¦¹à¦¯à¦¼à§‡à¦›à§‡!'+(fail?' âŒ '+fail+' à¦œà¦¨à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡à¥¤':''));
  clearBulk();syncDrops();
}


// Drag & drop
document.addEventListener('DOMContentLoaded',function(){
  var dz=g('dropZone');
  if(!dz)return;
  dz.addEventListener('dragover',function(e){e.preventDefault();dz.style.borderColor='var(--g1)';dz.style.background='#eef2ff';});
  dz.addEventListener('dragleave',function(){dz.style.borderColor='#c7d2fe';dz.style.background='#f8faff';});
  dz.addEventListener('drop',function(e){
    e.preventDefault();dz.style.borderColor='#c7d2fe';dz.style.background='#f8faff';
    var file=e.dataTransfer.files[0];
    if(file){var fi=g('bulkFile');var dt=new DataTransfer();dt.items.add(file);fi.files=dt.files;parseBulkFile(fi);}
  });
});


// â”€â”€ NOTE MODAL â”€â”€
async function openPM(id){
  // stuCache key can be string or int - check both
  var s=stuCache[id]||stuCache[String(id)]||stuCache[parseInt(id,10)];
  if(!s){
    var r=await SB.from('students').select('*').eq('id',id).single();
    if(r.error||!r.data){alert('à¦›à¦¾à¦¤à§à¦° à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿: '+id);return;}
    stuCache[id]=r.data;s=r.data;
  }
  var pmIdEl=g('pmId');
  var pmNmEl=g('pmNm');
  var pmTxEl=g('pmTx');
  var pmEl=g('pm');
  if(!pmIdEl||!pmNmEl||!pmTxEl||!pmEl){alert('Modal element missing!');return;}
  pmIdEl.value=s.id;
  pmNmEl.innerText=s.name||'à¦¶à¦¿à¦•à§à¦·à¦¾à¦°à§à¦¥à§€';
  pmTxEl.value=s.problem_note||'';
  pmEl.classList.add('open');
  document.body.style.overflow='hidden';
}
async function saveProb(){
  var id=parseInt(gv('pmId'),10),note=g('pmTx').value.trim();
  if(!id)return;
  var rs=await SB.from('students').update({problem_note:note}).eq('id',id);
  if(rs.error){alert('à¦¸à¦®à¦¸à§à¦¯à¦¾: '+rs.error.message);return;}
  if(stuCache[id])stuCache[id].problem_note=note;
  closeM();
  try{loadS();}catch(x){}
  try{loadTP();}catch(x){}
}
async function clearProb(){
  var id=parseInt(gv('pmId'),10);
  if(!id){closeM();return;}
  var rc=await SB.from('students').update({problem_note:''}).eq('id',id);
  if(rc.error){alert('à¦¸à¦®à¦¸à§à¦¯à¦¾: '+rc.error.message);return;}
  if(stuCache[id])stuCache[id].problem_note='';
  closeM();
  try{loadS();}catch(x){}
  try{loadTP();}catch(x){}
}


function tpOpenNote(sid){
  var s=stuCache[sid]||stuCache[String(sid)];
  if(!s){alert('Cache miss, reloading...');loadTP();return;}
  g('pmId').value=s.id;
  g('pmNm').innerText=s.name||'à¦¶à¦¿à¦•à§à¦·à¦¾à¦°à§à¦¥à§€';
  g('pmTx').value=s.problem_note||'';
  g('pm').classList.add('open');
  document.body.style.overflow='hidden';
}

// â”€â”€ SETTINGS PROTECTION â”€â”€
async function protect(callback){
  var pin=prompt('à¦¨à¦¿à¦¶à§à¦šà¦¿à¦¤ à¦•à¦°à¦¤à§‡ à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨ PIN à¦¦à¦¿à¦¨:');
  if(!pin)return;
  var r=await SB.from('academy_settings').select('value').eq('type','admin_pin').single();
  var stored=r.data?r.data.value:(localStorage.getItem('ub_apin')||'1234');
  if(pin===stored){callback();}
  else{alert('âŒ à¦­à§à¦² PIN!');}
}


function changeAdminPin(){
  var cur=prompt('à¦¬à¦°à§à¦¤à¦®à¦¾à¦¨ PIN:');
  if(!cur)return;
  var stored=localStorage.getItem('ub_apin')||'1234';
  if(cur!==stored){alert('âŒ à¦­à§à¦² PIN!');return;}
  var n1=prompt('à¦¨à¦¤à§à¦¨ PIN (à§ª+ à¦¸à¦‚à¦–à§à¦¯à¦¾):');
  if(!n1||n1.length<4){alert('âŒ à¦•à¦®à¦ªà¦•à§à¦·à§‡ à§ª à¦¸à¦‚à¦–à§à¦¯à¦¾ à¦¦à¦¿à¦¨!');return;}
  var n2=prompt('à¦¨à¦¤à§à¦¨ PIN à¦†à¦¬à¦¾à¦° à¦¦à¦¿à¦¨:');
  if(n1!==n2){alert('âŒ PIN à¦®à¦¿à¦²à¦›à§‡ à¦¨à¦¾!');return;}
  localStorage.setItem('ub_apin',n1);
  alert('âœ… PIN à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦¹à¦¯à¦¼à§‡à¦›à§‡!');
}


// â”€â”€ DAILY ATTENDANCE REPORT â”€â”€
var drData = [];

async function loadDailyRep(){
  var date=gv('drDate'),cls=gv('drCl'),bch=gv('drBt');
  if(!date){alert('à¦¤à¦¾à¦°à¦¿à¦– à¦¦à¦¿à¦¨!');return;}
  show('drLd');
  g('drH').innerHTML='';g('drB').innerHTML='';
  hide('drPrint');hide('drXls');hide('drS');

  var q=SB.from('students').select('*');
  if(cls!=='All')q=q.eq('class',cls);
  if(bch!=='All')q=q.eq('batch',bch);
  var r1=await q.order('roll_no');
  if(!r1.data||!r1.data.length){hide('drLd');g('drB').innerHTML='<tr><td style="text-align:center;padding:26px;color:var(--muted)">à¦¶à¦¿à¦•à§à¦·à¦¾à¦°à§à¦¥à§€ à¦¨à§‡à¦‡</td></tr>';return;}

  var r2=await SB.from('attendance').select('student_id,status,homework_status').eq('attendance_date',date).in('student_id',r1.data.map(function(s){return s.id;}));
  hide('drLd');

  var attMap={};
  if(r2.data)r2.data.forEach(function(a){attMap[a.student_id]=a;});

  // Header
  g('drH').innerHTML='<tr>'+
    '<th style="text-align:left;min-width:110px">à¦¨à¦¾à¦®</th>'+
    '<th>à¦°à§‹à¦²</th>'+
    '<th>à¦•à§à¦²à¦¾à¦¸</th>'+
    '<th>à¦¬à§à¦¯à¦¾à¦š</th>'+
    '<th>à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤à¦¿</th>'+
    '<th>HW</th>'+
    '</tr>';

  var pC=0,aB=0,nE=0;
  drData=[];

  g('drB').innerHTML=r1.data.map(function(s){
    var att=attMap[s.id];
    var st=att?att.status:'â€”';
    var hw=att?att.homework_status:'â€”';
    if(st==='Present')pC++;
    else if(st==='Absent')aB++;
    else nE++;
    drData.push({name:s.name,roll:s.roll_no,class:s.class,batch:s.batch||'',status:st,hw:hw});
    var sc=st==='Present'?'var(--green)':st==='Absent'?'var(--red)':'#94a3b8';
    return '<tr>'+
      '<td style="font-weight:600">'+e(s.name)+'</td>'+
      '<td style="text-align:center">'+s.roll_no+'</td>'+
      '<td>'+e(s.class)+'</td>'+
      '<td>'+e(s.batch||'')+'</td>'+
      '<td style="text-align:center;font-weight:700;color:'+sc+'">'+st+'</td>'+
      '<td style="text-align:center;color:'+(hw==='Yes'?'var(--green)':hw==='No'?'var(--amber)':'#94a3b8')+'">'+hw+'</td>'+
      '</tr>';
  }).join('');

  // Summary
  var drSEl=g('drS');
  drSEl.innerHTML=
    '<span class="paid-b">âœ… à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤: '+pC+'</span>'+
    '<span class="due-b">âŒ à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤: '+aB+'</span>'+
    '<span style="background:#f1f5f9;color:#64748b;padding:3px 10px;border-radius:99px;font-size:.72rem;font-weight:700">â€” à¦à¦¨à§à¦Ÿà§à¦°à¦¿ à¦¨à§‡à¦‡: '+nE+'</span>';
  show('drS');show('drPrint');show('drXls');
}

function printDailyRep(){
  var date=gv('drDate'),cls=gv('drCl'),bch=gv('drBt');
  var title='à¦¦à§ˆà¦¨à¦¿à¦• à¦¹à¦¾à¦œà¦¿à¦°à¦¾ â€” '+date+(cls&&cls!=='All'?' | '+cls:'')+(bch&&bch!=='All'?' | '+bch:'');
  var rows=drData.map(function(r,i){
    var sc=r.status==='Present'?'#065f46':r.status==='Absent'?'#9f1239':'#94a3b8';
    return '<tr style="border-bottom:1px solid #e2e8f0">'+
      '<td style="padding:6px 10px">'+(i+1)+'</td>'+
      '<td style="padding:6px 10px;font-weight:600">'+r.name+'</td>'+
      '<td style="padding:6px 10px;text-align:center">'+r.roll+'</td>'+
      '<td style="padding:6px 10px">'+r.class+'</td>'+
      '<td style="padding:6px 10px">'+r.batch+'</td>'+
      '<td style="padding:6px 10px;text-align:center;font-weight:700;color:'+sc+'">'+r.status+'</td>'+
      '<td style="padding:6px 10px;text-align:center">'+r.hw+'</td>'+
      '</tr>';
  }).join('');

  var pC=drData.filter(function(r){return r.status==='Present';}).length;
  var aB=drData.filter(function(r){return r.status==='Absent';}).length;

  var html='<html><head><meta charset="UTF-8">'+
    '<style>body{font-family:"Hind Siliguri",sans-serif;padding:20px;color:#1e293b}'+
    'h2{margin:0 0 4px;font-size:1.1rem}p{margin:0 0 16px;font-size:.8rem;color:#64748b}'+
    'table{width:100%;border-collapse:collapse}th{background:#4f46e5;color:#fff;padding:8px 10px;text-align:left;font-size:.8rem}'+
    'tr:nth-child(even){background:#f8faff}.summary{margin-top:16px;display:flex;gap:16px;font-size:.82rem;font-weight:700}'+
    '.p{color:#065f46}.a{color:#9f1239}@media print{button{display:none}}</style></head>'+
    '<body><h2>UBIQUE â€” à¦¦à§ˆà¦¨à¦¿à¦• à¦¹à¦¾à¦œà¦¿à¦°à¦¾ à¦°à¦¿à¦ªà§‹à¦°à§à¦Ÿ</h2>'+
    '<p>'+title+'</p>'+
    '<table><thead><tr>'+
    '<th>#</th><th>à¦¨à¦¾à¦®</th><th>à¦°à§‹à¦²</th><th>à¦•à§à¦²à¦¾à¦¸</th><th>à¦¬à§à¦¯à¦¾à¦š</th><th>à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤à¦¿</th><th>HW</th>'+
    '</tr></thead><tbody>'+rows+'</tbody></table>'+
    '<div class="summary"><span class="p">âœ… à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤: '+pC+'</span><span class="a">âŒ à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤: '+aB+'</span></div>'+
    '</body></html>';

  doPrint(html);
}

function exportDailyXls(){
  var date=gv('drDate'),cls=gv('drCl'),bch=gv('drBt');
  var wsData=[['à¦¨à¦¾à¦®','à¦°à§‹à¦²','à¦•à§à¦²à¦¾à¦¸','à¦¬à§à¦¯à¦¾à¦š','à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤à¦¿','HW']].concat(
    drData.map(function(r){return[r.name,r.roll,r.class,r.batch,r.status,r.hw];})
  );
  var ws=XLSX.utils.aoa_to_sheet(wsData);
  var wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'à¦¹à¦¾à¦œà¦¿à¦°à¦¾');
  XLSX.writeFile(wb,'à¦¹à¦¾à¦œà¦¿à¦°à¦¾_'+date+(cls!=='All'?'_'+cls:'')+(bch!=='All'?'_'+bch:'')+'.xlsx');
}


async function loadStuAtt(){
  var sid=window._stuId;
  if(!sid)return;
  var mo=g('sAttMo').value;
  if(!mo)return;
  var p=mo.split('-'),yyyy=parseInt(p[0]),mm=parseInt(p[1]);
  var dim=new Date(yyyy,mm,0).getDate();
  var from=mo+'-01',to=yyyy+'-'+String(mm).padStart(2,'0')+'-'+String(dim).padStart(2,'0');
  var r=await SB.from('attendance').select('attendance_date,status').eq('student_id',sid).gte('attendance_date',from).lte('attendance_date',to).order('attendance_date');
  var list=r.data||[];
  if(!list.length){
    g('sAttList').innerHTML='<p style="text-align:center;color:var(--muted);font-size:.8rem;padding:12px">à¦à¦‡ à¦®à¦¾à¦¸à§‡ à¦•à§‹à¦¨à§‹ à¦à¦¨à§à¦Ÿà§à¦°à¦¿ à¦¨à§‡à¦‡</p>';
    hide('sAttStat');return;
  }
  var present=0,absent=0;
  g('sAttList').innerHTML=list.map(function(a){
    var isP=a.status==='Present';
    if(isP)present++;else absent++;
    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 10px;border-radius:10px;background:'+(isP?'#f0fdf4':'#fff1f2')+'">'
      +'<span style="font-size:.78rem;font-weight:600">'+fd(a.attendance_date)+'</span>'
      +'<span style="font-size:.75rem;font-weight:700;color:'+(isP?'#065f46':'#9f1239')+'">'+(isP?'âœ… à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤':'âŒ à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤')+'</span>'
      +'</div>';
  }).join('');
  var total=present+absent;
  var pct=total>0?Math.round(present/total*100):0;
  g('sAttStat').innerHTML=
    '<span class="paid-b">âœ… à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤: '+present+'</span>'+
    '<span class="due-b">âŒ à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤: '+absent+'</span>'+
    '<span style="background:'+(pct>=75?'#dcfce7':'#ffe4e6')+';color:'+(pct>=75?'#065f46':'#9f1239')+';padding:3px 10px;border-radius:99px;font-size:.72rem;font-weight:700">ğŸ“Š '+pct+'% à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤à¦¿</span>';
  show('sAttStat');
}


function syncRtDrops(){
  var r=g('rtCl');if(!r)return;
  var src=g('sCl');if(src){r.innerHTML=src.innerHTML;}
  for(var i=r.options.length-1;i>=0;i--){if(r.options[i].value==='All')r.remove(i);}
  // Also sync batch
  var rb=g('rtBt');
  if(rb){var srcb=g('sBt');if(srcb){rb.innerHTML=srcb.innerHTML;}}
  loadClassDaysSettings();
}
function onRtClChange(){
  var cls=gv('rtCl');
  var rb=g('rtBt');
  if(!rb)return;
  // Filter batches by class
  var src=g('sBt');
  if(src){rb.innerHTML=src.innerHTML;}
}
function syncLPDrops(){
  var r=g('lpCl');if(!r)return;
  var src=g('sCl');if(src){r.innerHTML=src.innerHTML;}
  for(var i=r.options.length-1;i>=0;i--){if(r.options[i].value==='All')r.remove(i);}
  var t=new Date();
  if(!g('lpMo').value)g('lpMo').value=t.getFullYear()+'-'+String(t.getMonth()+1).padStart(2,'0');
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var DAYS_BN=['à¦¶à¦¨à¦¿à¦¬à¦¾à¦°','à¦°à¦¬à¦¿à¦¬à¦¾à¦°','à¦¸à§‹à¦®à¦¬à¦¾à¦°','à¦®à¦™à§à¦—à¦²à¦¬à¦¾à¦°','à¦¬à§à¦§à¦¬à¦¾à¦°','à¦¬à§ƒà¦¹à¦¸à§à¦ªà¦¤à¦¿à¦¬à¦¾à¦°','à¦¶à§à¦•à§à¦°à¦¬à¦¾à¦°'];
var classDays={};  // {class: [day1, day2, ...]}
var PERIODS=['à§§à¦®','à§¨à¦¯à¦¼','à§©à¦¯à¦¼','à§ªà¦°à§à¦¥','à§«à¦®','à§¬à¦·à§à¦ ','à§­à¦®','à§®à¦®'];
var routineData={};
var lpData={};

async function loadRoutine(){
  var cls=gv('rtCl');
  if(!cls){alert('à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  var r=await SB.from('class_routine').select('*').eq('class',cls).single();
  routineData[cls]=(r.data&&r.data.routine_data)||{};
  renderRoutineTable(cls);
  show('rtPrint');
}

function renderRoutineTable(cls){
  var data=routineData[cls]||{};
  var html='<table style="width:100%;border-collapse:collapse;font-size:.74rem;min-width:500px">';
  html+='<thead><tr><th style="background:#4f46e5;color:#fff;padding:8px 6px;border:1px solid #6366f1;min-width:50px">à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡</th>';
  DAYS_BN.forEach(function(d){
    html+='<th style="background:#4f46e5;color:#fff;padding:8px 6px;border:1px solid #6366f1;min-width:100px">'+d+'</th>';
  });
  html+='</tr></thead><tbody>';
  PERIODS.forEach(function(p,pi){
    html+='<tr>';
    html+='<td style="background:#eff6ff;font-weight:700;padding:7px 6px;border:1px solid #e0e7ff;text-align:center;white-space:nowrap">'+p+'</td>';
    DAYS_BN.forEach(function(d){
      var dk=d.replace(/\s/g,'_');
      var cell=(data[d]&&data[d][p])||{subject:'',teacher:'',time:''};
      var key='rt_'+pi+'_'+dk;
      html+='<td style="padding:4px;border:1px solid #e0e7ff;vertical-align:top">'
        +'<input id="'+key+'_sub" value="'+e(cell.subject||'')+'" placeholder="à¦¬à¦¿à¦·à¦¯à¦¼" style="width:100%;border:1px solid #e0e7ff;border-radius:5px;padding:3px 4px;font-size:.7rem;margin-bottom:2px;box-sizing:border-box">'
        +'<input id="'+key+'_tch" value="'+e(cell.teacher||'')+'" placeholder="à¦¶à¦¿à¦•à§à¦·à¦•" style="width:100%;border:1px solid #e0e7ff;border-radius:5px;padding:3px 4px;font-size:.67rem;color:#6366f1;box-sizing:border-box">'
        +'<input id="'+key+'_time" value="'+e(cell.time||'')+'" placeholder="à¦¸à¦®à¦¯à¦¼" style="width:100%;border:1px solid #e0e7ff;border-radius:5px;padding:3px 4px;font-size:.64rem;color:#94a3b8;box-sizing:border-box">'
        +'</td>';
    });
    html+='</tr>';
  });
  html+='</tbody></table>';
  g('rtTable').innerHTML=html;
}

async function saveRoutine(){
  var cls=gv('rtCl');
  if(!cls){alert('à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  // Block if conflict
  var ok=await checkConflict();
  if(!ok){alert('âŒ Conflict à¦†à¦›à§‡! à¦†à¦—à§‡ Conflict à¦ à¦¿à¦• à¦•à¦°à§à¦¨, à¦¤à¦¾à¦°à¦ªà¦° à¦¸à§‡à¦­ à¦•à¦°à§à¦¨à¥¤');return;}
  var data={};
  PERIODS.forEach(function(p,pi){
    DAYS_BN.forEach(function(d){
      var dk=d.replace(/\s/g,'_');
      var key='rt_'+pi+'_'+dk;
      var sub=g(key+'_sub'),tch=g(key+'_tch'),time=g(key+'_time');
      if(sub&&(sub.value.trim()||tch.value.trim())){
        if(!data[d])data[d]={};
        data[d][p]={subject:sub.value.trim(),teacher:tch.value.trim(),time:time.value.trim()};
      }
    });
  });
  routineData[cls]=data;
  var ex=await SB.from('class_routine').select('id').eq('class',cls).single();
  var r=ex.data
    ?await SB.from('class_routine').update({routine_data:data}).eq('class',cls)
    :await SB.from('class_routine').insert([{class:cls,routine_data:data}]);
  if(r.error)alert('âŒ '+r.error.message);
  else alert('âœ… à¦°à§à¦Ÿà¦¿à¦¨ à¦¸à§‡à¦­ à¦¹à¦¯à¦¼à§‡à¦›à§‡!');
}

function printRoutine(){
  var cls=gv('rtCl');
  var data=routineData[cls]||{};
  var rows='';
  PERIODS.forEach(function(p,pi){
    rows+='<tr><td style="font-weight:700;background:#eff6ff;padding:8px;border:1px solid #c7d2fe;text-align:center">'+p+'</td>';
    DAYS_BN.forEach(function(d){
      var cell=(data[d]&&data[d][p])||{};
      rows+='<td style="padding:7px 8px;border:1px solid #c7d2fe;vertical-align:top">'
        +(cell.subject?'<p style="font-weight:700;font-size:.82rem;margin:0">'+cell.subject+'</p>':'')
        +(cell.teacher?'<p style="font-size:.72rem;color:#6366f1;margin:0">'+cell.teacher+'</p>':'')
        +(cell.time?'<p style="font-size:.65rem;color:#94a3b8;margin:0">'+cell.time+'</p>':'â€”')
        +'</td>';
    });
    rows+='</tr>';
  });
  var html='<html><head><meta charset="UTF-8"><style>body{font-family:sans-serif;padding:20px}h2{margin:0 0 4px}p{margin:0 0 14px;color:#64748b;font-size:.82rem}table{width:100%;border-collapse:collapse}th{background:#4f46e5;color:#fff;padding:8px;font-size:.78rem}@media print{}</style></head>'
    +'<body><h2>UBIQUE â€” à¦•à§à¦²à¦¾à¦¸ à¦°à§à¦Ÿà¦¿à¦¨</h2><p>à¦•à§à¦²à¦¾à¦¸: '+cls+'</p>'
    +'<table><thead><tr><th>à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡</th>'+DAYS_BN.map(function(d){return'<th>'+d+'</th>';}).join('')+'</tr></thead>'
    +'<tbody>'+rows+'</tbody></table></body></html>';
  doPrint(html);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MONTHLY LECTURE PLAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadLP(){
  var cls=gv('lpCl'),mo=g('lpMo').value;
  if(!cls){alert('à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  if(!mo){alert('à¦®à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  var key=cls+'__'+mo;
  var r=await SB.from('lecture_plans').select('*').eq('class',cls).eq('month',mo).single();
  lpData[key]=(r.data&&r.data.plan_data)||{subjects:[]};
  renderLP(cls,mo);
  show('lpPrint');show('lpAddArea');
}

function renderLP(cls,mo){
  var key=cls+'__'+mo;
  var plan=lpData[key]||{subjects:[]};
  var subs=plan.subjects||[];
  if(!subs.length){
    g('lpContent').innerHTML='<p style="text-align:center;color:var(--muted);padding:24px">à¦•à§‹à¦¨à§‹ à¦¬à¦¿à¦·à¦¯à¦¼ à¦¨à§‡à¦‡ â€” à¦¨à¦¿à¦šà§‡ à¦¯à§‹à¦— à¦•à¦°à§à¦¨</p>';
    return;
  }
  var html='';
  subs.forEach(function(sub,si){
    html+='<div style="background:#f8faff;border-radius:14px;padding:14px;margin-bottom:12px;border:1px solid #e0e7ff">';
    html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
    html+='<div><p style="font-weight:700;font-size:.88rem;margin:0">ğŸ“– '+e(sub.name)+'</p>'
      +'<p style="font-size:.68rem;color:#6366f1;margin:0">'+e(sub.teacher||'')+'</p></div>';
    html+='<button onclick="removeLPSubject('+si+')" style="background:#fff1f2;color:#ef4444;border:none;padding:4px 10px;border-radius:8px;font-size:.7rem;cursor:pointer">âœ• à¦¬à¦¾à¦¦</button>';
    html+='</div>';
    html+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:.74rem;min-width:400px">';
    html+='<thead><tr>'
      +'<th style="background:#6366f1;color:#fff;padding:6px;border:1px solid #818cf8;width:55px">à¦¸à¦ªà§à¦¤à¦¾à¦¹</th>'
      +'<th style="background:#6366f1;color:#fff;padding:6px;border:1px solid #818cf8">à¦Ÿà¦ªà¦¿à¦• / à¦…à¦§à§à¦¯à¦¾à¦¯à¦¼</th>'
      +'<th style="background:#6366f1;color:#fff;padding:6px;border:1px solid #818cf8;width:90px">à¦²à¦•à§à¦·à§à¦¯à¦®à¦¾à¦¤à§à¦°à¦¾</th>'
      +'<th style="background:#6366f1;color:#fff;padding:6px;border:1px solid #818cf8;width:85px">à¦…à¦—à§à¦°à¦—à¦¤à¦¿</th>'
      +'</tr></thead><tbody>';
    for(var w=0;w<4;w++){
      var wd=(sub.weeks&&sub.weeks[w])||{topics:'',target:'',progress:''};
      var wk='lp_'+si+'_w'+w;
      html+='<tr>'
        +'<td style="padding:5px;border:1px solid #e0e7ff;text-align:center;font-weight:700;background:#eff6ff">'+(w+1)+'à¦®</td>'
        +'<td style="padding:4px;border:1px solid #e0e7ff"><textarea id="'+wk+'_top" rows="2" placeholder="à¦Ÿà¦ªà¦¿à¦• à¦²à¦¿à¦–à§à¦¨..." style="width:100%;border:none;resize:none;font-size:.72rem;background:transparent;box-sizing:border-box">'+e(wd.topics||'')+'</textarea></td>'
        +'<td style="padding:4px;border:1px solid #e0e7ff"><input id="'+wk+'_tgt" value="'+e(wd.target||'')+'" placeholder="à¦ªà§ƒà¦·à§à¦ à¦¾/à¦…à¦§à§à¦¯à¦¾à¦¯à¦¼" style="width:100%;border:none;font-size:.71rem;background:transparent;box-sizing:border-box"></td>'
        +'<td style="padding:4px;border:1px solid #e0e7ff">'
        +'<select id="'+wk+'_prg" style="width:100%;border:1px solid #e0e7ff;border-radius:6px;font-size:.68rem;padding:2px">'
        +'<option value=""'+(wd.progress===''?' selected':'')+'>â€”</option>'
        +'<option value="done"'+(wd.progress==='done'?' selected':'')+'>âœ… à¦¸à¦®à§à¦ªà¦¨à§à¦¨</option>'
        +'<option value="partial"'+(wd.progress==='partial'?' selected':'')+'>ğŸ”„ à¦†à¦‚à¦¶à¦¿à¦•</option>'
        +'<option value="pending"'+(wd.progress==='pending'?' selected':'')+'>â³ à¦¬à¦¾à¦•à¦¿</option>'
        +'</select></td>'
        +'</tr>';
    }
    html+='</tbody></table></div></div>';
  });
  g('lpContent').innerHTML=html;
}

function addLPSubject(){
  var cls=gv('lpCl'),mo=g('lpMo').value;
  if(!cls||!mo){alert('à¦†à¦—à§‡ à¦•à§à¦²à¦¾à¦¸ à¦“ à¦®à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦²à§‹à¦¡ à¦•à¦°à§à¦¨!');return;}
  var name=g('lpSubName').value.trim(),teacher=g('lpTeacher').value.trim();
  if(!name){alert('à¦¬à¦¿à¦·à¦¯à¦¼à§‡à¦° à¦¨à¦¾à¦® à¦¦à¦¿à¦¨!');return;}
  var key=cls+'__'+mo;
  if(!lpData[key])lpData[key]={subjects:[]};
  lpData[key].subjects.push({name:name,teacher:teacher,weeks:[{},{},{},{}]});
  renderLP(cls,mo);
  g('lpSubName').value='';g('lpTeacher').value='';
}

function removeLPSubject(si){
  var cls=gv('lpCl'),mo=g('lpMo').value;
  var key=cls+'__'+mo;
  if(!confirm('à¦¬à¦¾à¦¦ à¦¦à§‡à¦¬à§‡à¦¨?'))return;
  // collect current data first
  collectLPData(cls,mo);
  lpData[key].subjects.splice(si,1);
  renderLP(cls,mo);
}

function collectLPData(cls,mo){
  var key=cls+'__'+mo;
  var plan=lpData[key]||{subjects:[]};
  plan.subjects.forEach(function(sub,si){
    var weeks=[];
    for(var w=0;w<4;w++){
      var wk='lp_'+si+'_w'+w;
      weeks.push({
        topics:g(wk+'_top')?g(wk+'_top').value:'',
        target:g(wk+'_tgt')?g(wk+'_tgt').value:'',
        progress:g(wk+'_prg')?g(wk+'_prg').value:''
      });
    }
    sub.weeks=weeks;
  });
  lpData[key]=plan;
}

async function saveLP(){
  var cls=gv('lpCl'),mo=g('lpMo').value;
  if(!cls||!mo){alert('à¦•à§à¦²à¦¾à¦¸ à¦“ à¦®à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  collectLPData(cls,mo);
  var key=cls+'__'+mo;
  var plan=lpData[key];
  var ex=await SB.from('lecture_plans').select('id').eq('class',cls).eq('month',mo).single();
  var r=ex.data
    ?await SB.from('lecture_plans').update({plan_data:plan}).eq('class',cls).eq('month',mo)
    :await SB.from('lecture_plans').insert([{class:cls,month:mo,plan_data:plan}]);
  if(r.error)alert('âŒ '+r.error.message);
  else alert('âœ… à¦²à§‡à¦•à¦šà¦¾à¦° à¦ªà§à¦²à§à¦¯à¦¾à¦¨ à¦¸à§‡à¦­ à¦¹à¦¯à¦¼à§‡à¦›à§‡!');
}

function printLP(){
  var cls=gv('lpCl'),mo=g('lpMo').value;
  if(!cls||!mo)return;
  collectLPData(cls,mo);
  var key=cls+'__'+mo;
  var plan=lpData[key]||{subjects:[]};
  var html='<html><head><meta charset="UTF-8"><style>body{font-family:sans-serif;padding:20px;color:#1e293b}h2{margin:0 0 4px}.sub{color:#64748b;font-size:.82rem;margin:0 0 16px}.card{margin-bottom:18px;border:1px solid #e0e7ff;border-radius:10px;overflow:hidden}.ch{background:#4f46e5;color:#fff;padding:9px 14px;font-weight:700}table{width:100%;border-collapse:collapse}th{background:#6366f1;color:#fff;padding:6px;font-size:.78rem}td{padding:6px 8px;border:1px solid #e0e7ff;font-size:.78rem;vertical-align:top}</style></head><body>'
    +'<h2>UBIQUE â€” à¦®à¦¾à¦¨à§à¦¥à¦²à¦¿ à¦²à§‡à¦•à¦šà¦¾à¦° à¦ªà§à¦²à§à¦¯à¦¾à¦¨</h2>'
    +'<p class="sub">à¦•à§à¦²à¦¾à¦¸: '+cls+' | à¦®à¦¾à¦¸: '+mo+'</p>';
  plan.subjects.forEach(function(sub){
    html+='<div class="card"><div class="ch">ğŸ“– '+sub.name+(sub.teacher?' | '+sub.teacher:'')+'</div>';
    html+='<table><thead><tr><th style="width:55px">à¦¸à¦ªà§à¦¤à¦¾à¦¹</th><th>à¦Ÿà¦ªà¦¿à¦• / à¦…à¦§à§à¦¯à¦¾à¦¯à¦¼</th><th style="width:100px">à¦²à¦•à§à¦·à§à¦¯à¦®à¦¾à¦¤à§à¦°à¦¾</th><th style="width:80px">à¦…à¦—à§à¦°à¦—à¦¤à¦¿</th></tr></thead><tbody>';
    (sub.weeks||[]).forEach(function(w,i){
      var pg=w.progress==='done'?'âœ… à¦¸à¦®à§à¦ªà¦¨à§à¦¨':w.progress==='partial'?'ğŸ”„ à¦†à¦‚à¦¶à¦¿à¦•':w.progress==='pending'?'â³ à¦¬à¦¾à¦•à¦¿':'â€”';
      html+='<tr><td style="text-align:center;font-weight:700;background:#eff6ff">'+(i+1)+'à¦®</td><td>'+e(w.topics||'')+'</td><td>'+e(w.target||'')+'</td><td style="text-align:center">'+pg+'</td></tr>';
    });
    html+='</tbody></table></div>';
  });
  html+='</body></html>';
  doPrint(html);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SMART ROUTINE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var DAYS_BN = ['à¦¶à¦¨à¦¿à¦¬à¦¾à¦°','à¦°à¦¬à¦¿à¦¬à¦¾à¦°','à¦¸à§‹à¦®à¦¬à¦¾à¦°','à¦®à¦™à§à¦—à¦²à¦¬à¦¾à¦°','à¦¬à§à¦§à¦¬à¦¾à¦°','à¦¬à§ƒà¦¹à¦¸à§à¦ªà¦¤à¦¿à¦¬à¦¾à¦°','à¦¶à§à¦•à§à¦°à¦¬à¦¾à¦°'];
var teachersList = [];
var routineGrid = {}; // {day: {period: {subject, teacher_id}}}
var currentRtClass = '';
var rtPeriodTimes = [];

// â”€â”€ TEACHER MANAGEMENT â”€â”€
async function loadTeachers(){
  var r = await SB.from('teachers').select('*').order('name');
  teachersList = r.data || [];
  renderTeacherList();
}

function renderTeacherList(){
  var el = g('tchList');
  if(!teachersList.length){
    el.innerHTML = '<p style="text-align:center;color:var(--muted);font-size:.78rem;padding:10px">à¦•à§‹à¦¨à§‹ à¦¶à¦¿à¦•à§à¦·à¦• à¦¨à§‡à¦‡</p>';
    return;
  }
  el.innerHTML = teachersList.map(function(t){
    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#f8faff;border-radius:10px;border:1px solid #e0e7ff">'
      + '<span style="font-weight:700;font-size:.82rem">'+e(t.name)+'</span>'
      + '<button onclick="delTeacher(\''+t.id+'\')" style="background:#fff1f2;color:#ef4444;border:none;padding:4px 9px;border-radius:8px;font-size:.7rem;cursor:pointer">âœ•</button>'
      + '</div>';
  }).join('');
}

async function saveTeacher(){
  var name = g('tchName').value.trim();
  if(!name){alert('à¦¶à¦¿à¦•à§à¦·à¦•à§‡à¦° à¦¨à¦¾à¦® à¦¦à¦¿à¦¨!');return;}
  var r = await SB.from('teachers').insert([{name:name, pin:'0000'}]);
  if(r.error){alert('âŒ '+r.error.message);return;}
  g('tchName').value='';
  if(g('tchSubs'))g('tchSubs').value='';
  loadTeachers();
}

async function delTeacher(id){
  if(!confirm('à¦®à§à¦›à¦¬à§‡à¦¨?'))return;
  await SB.from('teachers').delete().eq('id', id);
  loadTeachers();
}

// â”€â”€ TIME CALCULATION â”€â”€
function calcPeriodTimes(startStr, endStr, count){
  var s = startStr.split(':').map(Number);
  var en = endStr.split(':').map(Number);
  var startMin = s[0]*60 + s[1];
  var endMin = en[0]*60 + en[1];
  var total = endMin - startMin;
  var perPeriod = Math.floor(total / count);
  var times = [];
  for(var i=0;i<count;i++){
    var from = startMin + i*perPeriod;
    var to = startMin + (i+1)*perPeriod;
    times.push({
      start: Math.floor(from/60)+':'+(from%60).toString().padStart(2,'0'),
      end: Math.floor(to/60)+':'+(to%60).toString().padStart(2,'0'),
      label: fmtTime(from)+' â€“ '+fmtTime(to)
    });
  }
  return times;
}

function fmtTime(mins){
  var h = Math.floor(mins/60);
  var m = mins%60;
  var ampm = h>=12?'PM':'AM';
  var h12 = h>12?h-12:h===0?12:h;
  return h12+':'+(m).toString().padStart(2,'0')+' '+ampm;
}

// â”€â”€ BUILD ROUTINE GRID â”€â”€
async function buildRoutineGrid(){
  var cls = gv('rtCl');
  if(!cls){alert('à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  var start = g('rtStart').value;
  var end = g('rtEnd').value;
  var count = parseInt(gv('rtPeriodCount'));
  if(!start||!end){alert('à¦¸à¦®à¦¯à¦¼ à¦¦à¦¿à¦¨!');return;}
  currentRtClass = cls;
  rtPeriodTimes = calcPeriodTimes(start, end, count);

  // Show time info
  g('rtTimeInfo').innerText = 'â± à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡: '+Math.floor((rtPeriodTimes[0]?((parseInt(end.split(':')[0])*60+parseInt(end.split(':')[1]))-(parseInt(start.split(':')[0])*60+parseInt(start.split(':')[1])))/count:45))+' à¦®à¦¿à¦¨à¦¿à¦Ÿ';

  // Load existing routine
  var r = await SB.from('class_routine').select('*').eq('class', cls);
  routineGrid = {};
  (r.data||[]).forEach(function(row){
    if(!routineGrid[row.day]) routineGrid[row.day]={};
    routineGrid[row.day][row.period]={subject:row.subject||'', teacher_id:row.teacher_id||''};
  });

  renderRoutineGrid(cls, count);
  show('rtPrint');
}

function renderRoutineGrid(cls, count){
  if(!teachersList.length){
    g('rtTable').innerHTML='<p style="color:var(--red);text-align:center;padding:16px">âš ï¸ à¦†à¦—à§‡ à¦¶à¦¿à¦•à§à¦·à¦• à¦¯à§‹à¦— à¦•à¦°à§à¦¨!</p>';
    return;
  }
  var html = '<table style="width:100%;border-collapse:collapse;font-size:.74rem">';
  // Header
  html += '<thead><tr><th style="background:#4f46e5;color:#fff;padding:8px;border:1px solid #6366f1;min-width:90px">à¦¦à¦¿à¦¨ / à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡</th>';
  for(var p=0;p<count;p++){
    html += '<th style="background:#4f46e5;color:#fff;padding:7px 5px;border:1px solid #6366f1;min-width:130px;font-size:.72rem">'
      + (p+1)+'à¦® à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡<br>'
      + '<span style="font-weight:400;font-size:.65rem;opacity:.85">'+rtPeriodTimes[p].label+'</span>'
      + '</th>';
  }
  html += '</tr></thead><tbody>';

  var rtBt=gv('rtBt')||'';
  var dayKey=cls+(rtBt&&rtBt!=='All'?'_'+rtBt:'');
  var activeDays=classDays[dayKey]&&classDays[dayKey].length?classDays[dayKey]:DAYS_BN;
  activeDays.forEach(function(day){  html += '<tr>';
    html += '<td style="background:#eff6ff;font-weight:700;padding:8px;border:1px solid #e0e7ff;text-align:center;white-space:nowrap">'+day+'</td>';
    for(var p=0;p<count;p++){
      var cellData = (routineGrid[day]&&routineGrid[day][p+1])||{subject:'',teacher_id:''};
      var subKey = 'rt_'+day+'_'+p+'_sub';
      var tchKey = 'rt_'+day+'_'+p+'_tch';

      // Subject dropdown - unique subjects from teachers
      var allSubs = [];
      teachersList.forEach(function(t){(t.subjects||[]).forEach(function(s){if(allSubs.indexOf(s)===-1)allSubs.push(s);});});
      allSubs.sort();

      var subOpts = '<option value="">-- à¦¬à¦¿à¦·à¦¯à¦¼ --</option>'
        + allSubs.map(function(s){
            return '<option value="'+e(s)+'"'+(cellData.subject===s?' selected':'')+'>'+e(s)+'</option>';
          }).join('');

      // Teacher dropdown - filtered by selected subject
      var tchOpts = buildTchOpts(cellData.subject, cellData.teacher_id, day, p+1);

      html += '<td style="padding:5px;border:1px solid #e0e7ff;vertical-align:top">'
        + '<select id="'+subKey+'" onchange="onSubjectChange(this,\''+day+'\','+p+')" style="width:100%;border:1px solid #e0e7ff;border-radius:6px;padding:3px 4px;font-size:.7rem;margin-bottom:3px">'+subOpts+'</select>'
        + '<select id="'+tchKey+'" onchange="checkConflict()" style="width:100%;border:1px solid #e0e7ff;border-radius:6px;padding:3px 4px;font-size:.68rem;color:#4f46e5">'+tchOpts+'</select>'
        + '</td>';
    }
    html += '</tr>';
  });
  html += '</tbody></table>';
  g('rtTable').innerHTML = html;
  hide('rtConflictBar');
}

function buildTchOpts(subject, selectedId, day, period){
  var filtered = subject
    ? teachersList.filter(function(t){return (t.subjects||[]).indexOf(subject)!==-1;})
    : teachersList;
  var opts = '<option value="">-- à¦¶à¦¿à¦•à§à¦·à¦• --</option>';
  filtered.forEach(function(t){
    opts += '<option value="'+t.id+'"'+(selectedId===t.id?' selected':'')+'>'+e(t.name)+'</option>';
  });
  return opts;
}

function onSubjectChange(sel, day, pIdx){
  var count = parseInt(gv('rtPeriodCount'));
  var subVal = sel.value;
  var tchSel = g('rt_'+day+'_'+pIdx+'_tch');
  if(tchSel){
    var existingTch = tchSel.value;
    tchSel.innerHTML = buildTchOpts(subVal, existingTch, day, pIdx+1);
  }
  checkConflict();
}

async function checkConflict(){
  var count = parseInt(gv('rtPeriodCount'));
  var cls = gv('rtCl');
  var conflicts = [];
  var rtBt=gv('rtBt')||'';
  var dayKey=cls+(rtBt&&rtBt!=='All'?'_'+rtBt:'');
  var activeDays=classDays[dayKey]&&classDays[dayKey].length?classDays[dayKey]:DAYS_BN;

  // Build current grid assignments: {day_period: teacher_id}
  var tchMap = {};
  activeDays.forEach(function(day){
    for(var p=0;p<count;p++){
      var tchSel = g('rt_'+day+'_'+p+'_tch');
      if(tchSel&&tchSel.value){
        var tid = tchSel.value;
        if(!tchMap[tid]) tchMap[tid]=[];
        tchMap[tid].push({day:day, period:p+1});
      }
    }
  });

  // Check duplicates within same class grid
  Object.keys(tchMap).forEach(function(tid){
    var seen={};
    tchMap[tid].forEach(function(sl){
      var k=sl.day+'_'+sl.period;
      if(seen[k]){
        var tname=(teachersList.find(function(t){return t.id==tid;})||{}).name||tid;
        conflicts.push('âš ï¸ '+tname+' â†’ '+sl.day+' à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡ '+sl.period+' (à¦à¦•à¦‡ à¦•à§à¦²à¦¾à¦¸à§‡ à¦¦à§à¦‡à¦¬à¦¾à¦°)');
      }
      seen[k]=true;
    });
  });

  // Cross-class check: load all other classes' routines from Supabase
  var tids=Object.keys(tchMap);
  if(tids.length){
    var crossR=await SB.from('class_routine').select('class,routine_data').neq('class',cls);
    (crossR.data||[]).forEach(function(row){
      var otherCls=row.class;
      var rd=row.routine_data||{};
      Object.keys(rd).forEach(function(day){
        Object.keys(rd[day]).forEach(function(period){
          var cell=rd[day][period];
          var tid=cell&&cell.teacher_id;
          if(!tid)return;
          if(tchMap[tid]){
            // Check if any slot in current grid matches this day+period
            tchMap[tid].forEach(function(sl){
              if(sl.day===day&&sl.period===parseInt(period)){
                var tname=(teachersList.find(function(t){return t.id==tid;})||{}).name||tid;
                conflicts.push('ğŸš« '+tname+' â†’ '+day+' à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡ '+period+' à¦¤à§‡ à¦‡à¦¤à¦¿à¦®à¦§à§à¦¯à§‡ à¦•à§à¦²à¦¾à¦¸ '+otherCls+' à¦ à¦†à¦›à§‡à¦¨!');
              }
            });
          }
        });
      });
    });
  }

  var bar = g('rtConflictBar');
  if(conflicts.length){
    bar.innerHTML = '<strong>Conflict à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦—à§‡à¦›à§‡!</strong><br>'+conflicts.join('<br>');
    bar.style.background='#fef2f2';
    bar.style.borderColor='#fecaca';
    bar.style.color='#dc2626';
    show('rtConflictBar');
  } else {
    hide('rtConflictBar');
  }
  return conflicts.length===0;
}

async function saveRoutine(){
  var cls = currentRtClass||gv('rtCl');
  if(!cls){alert('à¦†à¦—à§‡ à¦—à§à¦°à¦¿à¦¡ à¦¬à¦¾à¦¨à¦¾à¦¨!');return;}
  var count = parseInt(gv('rtPeriodCount'));
  // Delete existing
  await SB.from('class_routine').delete().eq('class', cls);
  // Build records
  var recs = [];
  DAYS_BN.forEach(function(day){
    for(var p=0;p<count;p++){
      var subSel = g('rt_'+day+'_'+p+'_sub');
      var tchSel = g('rt_'+day+'_'+p+'_tch');
      if(subSel&&subSel.value){
        recs.push({
          class: cls,
          day: day,
          period: p+1,
          subject: subSel.value,
          teacher_id: (tchSel&&tchSel.value)||null,
          start_time: rtPeriodTimes[p]?rtPeriodTimes[p].start:'',
          end_time: rtPeriodTimes[p]?rtPeriodTimes[p].end:''
        });
      }
    }
  });
  if(!recs.length){alert('à¦•à§‹à¦¨à§‹ à¦¬à¦¿à¦·à¦¯à¦¼ à¦¦à§‡à¦¨à¦¨à¦¿!');return;}
  var r = await SB.from('class_routine').insert(recs);
  if(r.error) alert('âŒ '+r.error.message);
  else alert('âœ… à¦°à§à¦Ÿà¦¿à¦¨ à¦¸à§‡à¦­ à¦¹à¦¯à¦¼à§‡à¦›à§‡! ('+recs.length+' à¦à¦¨à§à¦Ÿà§à¦°à¦¿)');
}

async function printRoutine(){
  var cls = currentRtClass||gv('rtCl');
  var count = parseInt(gv('rtPeriodCount'));
  var rows = '';
  DAYS_BN.forEach(function(day){
    rows += '<tr><td style="font-weight:700;background:#eff6ff;padding:8px;border:1px solid #c7d2fe;text-align:center">'+day+'</td>';
    for(var p=0;p<count;p++){
      var subSel = g('rt_'+day+'_'+p+'_sub');
      var tchSel = g('rt_'+day+'_'+p+'_tch');
      var sub = subSel?subSel.options[subSel.selectedIndex].text:'';
      var tch = tchSel?tchSel.options[tchSel.selectedIndex].text:'';
      var time = rtPeriodTimes[p]?rtPeriodTimes[p].label:'';
      rows += '<td style="padding:7px 8px;border:1px solid #c7d2fe;vertical-align:top;min-width:100px">'
        + (sub&&sub!='-- à¦¬à¦¿à¦·à¦¯à¦¼ --'?'<p style="font-weight:700;font-size:.82rem;margin:0">'+sub+'</p>':'')
        + (tch&&tch!='-- à¦¶à¦¿à¦•à§à¦·à¦• --'?'<p style="font-size:.72rem;color:#4f46e5;margin:2px 0">'+tch+'</p>':'')
        + (time?'<p style="font-size:.65rem;color:#94a3b8;margin:0">'+time+'</p>':'')
        + '</td>';
    }
    rows += '</tr>';
  });
  var headers = '<th style="background:#4f46e5;color:#fff;padding:8px">à¦¦à¦¿à¦¨</th>';
  for(var p=0;p<count;p++) headers += '<th style="background:#4f46e5;color:#fff;padding:8px">'+rtPeriodTimes[p].label+'</th>';
  var html = '<html><head><meta charset="UTF-8"><style>body{font-family:sans-serif;padding:20px}h2{margin:0 0 4px}p.s{color:#64748b;font-size:.82rem;margin:0 0 14px}table{width:100%;border-collapse:collapse}@media print{}</style></head>'
    +'<body><h2>UBIQUE â€” à¦•à§à¦²à¦¾à¦¸ à¦°à§à¦Ÿà¦¿à¦¨</h2><p class="s">à¦•à§à¦²à¦¾à¦¸: '+cls+'</p>'
    +'<table><thead><tr>'+headers+'</tr></thead><tbody>'+rows+'</tbody></table></body></html>';
  doPrint(html);
}

function syncRtDrops(){
  var r = g('rtCl'); if(!r) return;
  var src = g('sCl'); if(src) r.innerHTML = src.innerHTML;
  for(var i=r.options.length-1;i>=0;i--){if(r.options[i].value==='All')r.remove(i);}
  loadTeachers();
}



function filterSetS(){
  var q=g('setSearch').value.trim().toLowerCase();
  var items=g('setL').querySelectorAll('[data-sid]');
  items.forEach(function(el){
    var name=el.dataset.name||'';
    var roll=el.dataset.roll||'';
    el.style.display=(name.indexOf(q)!==-1||roll.indexOf(q)!==-1)?'':'none';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OFFLINE MODE â€” Attendance Queue System
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var isOnline = navigator.onLine;
// â”€â”€ Network status monitoring â”€â”€
window.addEventListener('online', function(){
  isOnline = true;
  updateOfflineBar();
  syncOfflineQueue(); // auto sync when back online
});
window.addEventListener('offline', function(){
  isOnline = false;
});

function updateOfflineBar(){
  var bar = g('offlineBar');
  if(!bar) return;
  var q = getQueue();
  if(!isOnline){
    bar.style.display = 'flex';
    bar.style.background = '#fef2f2';
    bar.style.borderColor = '#fecaca';
    bar.innerHTML = 'ğŸ”´ <strong>à¦…à¦«à¦²à¦¾à¦‡à¦¨</strong> â€” à¦¹à¦¾à¦œà¦¿à¦°à¦¾ à¦¸à§‡à¦­ à¦¹à¦¬à§‡ à¦‡à¦¨à§à¦Ÿà¦¾à¦°à¦¨à§‡à¦Ÿ à¦«à¦¿à¦°à¦²à§‡'
      + (q.length ? ' <span style="font-weight:700;color:#dc2626">('+q.length+'à¦Ÿà¦¿ à¦ªà§‡à¦¨à§à¦¡à¦¿à¦‚)</span>' : '');
  } else if(q.length > 0){
    bar.style.display = 'flex';
    bar.style.background = '#fefce8';
    bar.style.borderColor = '#fde68a';
    bar.innerHTML = 'ğŸŸ¡ à¦…à¦¨à¦²à¦¾à¦‡à¦¨ â€” <strong>'+q.length+'à¦Ÿà¦¿ à¦ªà§‡à¦¨à§à¦¡à¦¿à¦‚ à¦¹à¦¾à¦œà¦¿à¦°à¦¾</strong> à¦¸à¦¿à¦™à§à¦• à¦¹à¦šà§à¦›à§‡...'
      + ' <button onclick="syncOfflineQueue()" style="margin-left:8px;background:#f59e0b;color:#fff;border:none;padding:2px 10px;border-radius:7px;font-size:.7rem;cursor:pointer;font-weight:700">à¦à¦–à¦¨à¦‡ à¦¸à¦¿à¦™à§à¦•</button>';
  } else {
    bar.style.display = 'none';
  }
}

function getQueue(){
  try { return JSON.parse(localStorage.getItem(OFFLINE_KEY)||'[]'); }
  catch(e){ return []; }
}

function addToQueue(recs, date){
  var q = getQueue();
  // Remove any existing entries for same date
  q = q.filter(function(item){ return item.date !== date; });
  q.push({date: date, recs: recs, savedAt: new Date().toISOString()});
  saveQueue(q);
  updateOfflineBar();
}

// â”€â”€ Sync queue to Supabase â”€â”€
async function syncOfflineQueue(){
  var q = getQueue();
  if(!q.length || !isOnline) return;
  var bar = g('offlineBar');
  var success = [];
  for(var i=0; i<q.length; i++){
    var item = q[i];
    var r = await SB.from('attendance').upsert(item.recs, {onConflict:'student_id,attendance_date'});
    if(!r.error){
      success.push(item.date);
    }
  }
  // Remove synced items
  var remaining = q.filter(function(item){ return success.indexOf(item.date) === -1; });
  saveQueue(remaining);
  updateOfflineBar();
  if(success.length){
    if(bar){
      bar.style.display='flex';
      bar.style.background='#f0fdf4';
      bar.style.borderColor='#bbf7d0';
      bar.innerHTML='âœ… <strong>'+success.length+'à¦Ÿà¦¿ à¦¹à¦¾à¦œà¦¿à¦°à¦¾ à¦¸à¦¿à¦™à§à¦• à¦¹à¦¯à¦¼à§‡à¦›à§‡!</strong>';
      setTimeout(function(){ updateOfflineBar(); }, 3000);
    }
    loadS();
  }
}



async function printDueCards(){
  var cls=gv('fCl'),bch=gv('fBt'),mo=gv('fMo'),yr=new Date().getFullYear().toString();
  var q=SB.from('students').select('*');
  if(cls!=='All')q=q.eq('class',cls);
  if(bch!=='All')q=q.eq('batch',bch);
  var r1=await q.order('roll_no');
  if(!r1.data||!r1.data.length){alert('à¦•à§‹à¦¨à§‹ à¦¶à¦¿à¦•à§à¦·à¦¾à¦°à§à¦¥à§€ à¦¨à§‡à¦‡!');return;}
  var r2=await SB.from('fees_collection').select('student_id,payment_month').eq('payment_year',yr);
  var paidMap={};
  (r2.data||[]).forEach(function(f){
    if(!paidMap[f.student_id])paidMap[f.student_id]=[];
    paidMap[f.student_id].push(f.payment_month);
  });
  var ALL_MO=['January','February','March','April','May','June','July','August','September','October','November','December'];
  var MO_BN={January:'à¦œà¦¾à¦¨à§à¦¯à¦¼à¦¾à¦°à¦¿',February:'à¦«à§‡à¦¬à§à¦°à§à¦¯à¦¼à¦¾à¦°à¦¿',March:'à¦®à¦¾à¦°à§à¦š',April:'à¦à¦ªà§à¦°à¦¿à¦²',May:'à¦®à§‡',June:'à¦œà§à¦¨',July:'à¦œà§à¦²à¦¾à¦‡',August:'à¦†à¦—à¦¸à§à¦Ÿ',September:'à¦¸à§‡à¦ªà§à¦Ÿà§‡à¦®à§à¦¬à¦°',October:'à¦…à¦•à§à¦Ÿà§‹à¦¬à¦°',November:'à¦¨à¦­à§‡à¦®à§à¦¬à¦°',December:'à¦¡à¦¿à¦¸à§‡à¦®à§à¦¬à¦°'};
  var curMoIdx=ALL_MO.indexOf(mo);
  var cards=[];
  r1.data.forEach(function(s){
    var admIdx=ALL_MO.indexOf(s.admission_month||'January');
    var paid=paidMap[s.id]||[];
    var dueMos=[];
    for(var i=admIdx;i<=curMoIdx;i++){
      if(paid.indexOf(ALL_MO[i])===-1)dueMos.push(MO_BN[ALL_MO[i]]);
    }
    if(dueMos.length)cards.push({s:s,dueMos:dueMos});
  });
  if(!cards.length){alert('à¦•à§‹à¦¨à§‹ à¦¬à¦•à§‡à¦¯à¦¼à¦¾ à¦¨à§‡à¦‡!');return;}
  // Build preview
  var previewGrid=document.getElementById('dcPreviewBody');
  previewGrid.innerHTML='';
  cards.forEach(function(item){
    previewGrid.appendChild(buildCard(item,false));
  });
  document.getElementById('dcCount').innerText=cards.length+'à¦Ÿà¦¿ à¦¬à¦•à§‡à¦¯à¦¼à¦¾ à¦•à¦¾à¦°à§à¦¡ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦—à§‡à¦›à§‡';
  window._dueCards=cards;
  document.getElementById('dcModal').style.display='flex';
}

function buildCard(item,forPrint){
  var s=item.s,dueMos=item.dueMos;
  var absentDays=item.absentDays||0;
  var irregular=item.irregular||false;
  var today=new Date().toLocaleDateString('bn-BD');
  var div=document.createElement('div');
  div.className='due-card';
  var moHTML=dueMos.map(function(m){return '<span class="dc-mo">'+m+'</span>';}).join('');
  var absHTML='';
  if(absentDays>0){
    var absBg=irregular?'#fef2f2':'#f0fdf4';
    var absBd=irregular?'#fecaca':'#bbf7d0';
    var absCol=irregular?'#dc2626':'#16a34a';
    var absLabel=irregular?'âš ï¸ à¦…à¦¨à¦¿à¦¯à¦¼à¦®à¦¿à¦¤':'âœ… à¦¨à¦¿à¦¯à¦¼à¦®à¦¿à¦¤';
    absHTML='<div style="margin-top:3px;padding:3px 7px;border-radius:4px;font-size:7.5pt;display:flex;justify-content:space-between;align-items:center;background:'+absBg+';border:1px solid '+absBd+'">'+
      '<span style="font-weight:700;color:'+absCol+'">'+absLabel+'</span>'+
      '<span style="color:#374151">à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤: <b>'+absentDays+' à¦¦à¦¿à¦¨</b></span>'+
    '</div>';
  }
  div.innerHTML=
    '<div class="dc-header">'+
      '<span class="dc-logo">UBIQUE</span>'+
      '<span class="dc-tag">à¦¬à¦•à§‡à¦¯à¦¼à¦¾ à¦¨à§‹à¦Ÿà¦¿à¦¶</span>'+
    '</div>'+
    '<div class="dc-body">'+
      '<div class="dc-row"><span class="dc-lbl">à¦¨à¦¾à¦®</span><span class="dc-val">'+s.name+'</span></div>'+
      '<div class="dc-row"><span class="dc-lbl">à¦•à§à¦²à¦¾à¦¸</span><span class="dc-val">'+s.class+' | '+s.batch+'</span></div>'+
      '<div class="dc-row"><span class="dc-lbl">à¦°à§‹à¦²</span><span class="dc-val">'+s.roll_no+'</span></div>'+
      '<div class="dc-due-sec">'+
        '<div class="dc-lbl">à¦¬à¦•à§‡à¦¯à¦¼à¦¾ à¦®à¦¾à¦¸</div>'+
        '<div class="dc-months">'+moHTML+'</div>'+
      '</div>'+
      '<div class="dc-total">'+
        '<span>à¦®à§‹à¦Ÿ à¦¬à¦•à§‡à¦¯à¦¼à¦¾</span>'+
        '<span class="dc-num">'+dueMos.length+' à¦®à¦¾à¦¸</span>'+
      '</div>'+
      absHTML+
      '<div class="dc-msg">'+
        'à¦ªà§à¦°à¦¿à¦¯à¦¼ à¦…à¦­à¦¿à¦­à¦¾à¦¬à¦•, à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦¨à§à¦¤à¦¾à¦¨à§‡à¦° <b>'+dueMos.length+' à¦®à¦¾à¦¸à§‡à¦°</b> à¦¬à§‡à¦¤à¦¨ à¦¬à¦•à§‡à¦¯à¦¼à¦¾ à¦°à¦¯à¦¼à§‡à¦›à§‡à¥¤ '+
        'à¦…à¦¨à§à¦—à§à¦°à¦¹ à¦•à¦°à§‡ <b>à§­ à¦•à¦¾à¦°à§à¦¯à¦¦à¦¿à¦¬à¦¸à§‡à¦° à¦®à¦§à§à¦¯à§‡</b> à¦¬à§‡à¦¤à¦¨ à¦ªà¦°à¦¿à¦¶à§‹à¦§ à¦•à¦°à§à¦¨à¥¤'+
        ' à¦…à¦¨à§à¦¯à¦¥à¦¾à¦¯à¦¼ à¦•à§à¦²à¦¾à¦¸à§‡ à¦…à¦‚à¦¶à¦—à§à¦°à¦¹à¦£à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¤à§‡ à¦ªà¦¾à¦°à§‡à¥¤ &mdash; UBIQUE à¦•à¦°à§à¦¤à§ƒà¦ªà¦•à§à¦·'+
      '</div>'+
    '</div>'+
    '<div class="dc-footer">'+
      '<span>à¦¤à¦¾à¦°à¦¿à¦–: '+today+'</span>'+
      '<span>à¦¸à§à¦¬à¦¾à¦•à§à¦·à¦°: ___________</span>'+
    '</div>';
  return div;
}

function closeDcModal(){document.getElementById('dcModal').style.display='none';}

function printDueCardsNow(){
  var cards=window._dueCards||[];
  if(!cards.length)return;
  var cardHTML=cards.map(function(item){
    return buildCard(item,true).outerHTML;
  }).join('');
  var css=[
    '@page{size:A4;margin:8mm}',
    'body{font-family:Arial,sans-serif;margin:0;padding:2mm;background:#fff}',
    '.grid{display:grid;grid-template-columns:1fr 1fr;gap:5mm}',
    '.due-card{border:1.5px solid #4f46e5;border-radius:7px;overflow:hidden;break-inside:avoid;page-break-inside:avoid;font-size:8pt}',
    '.dc-header{background:#4f46e5;color:#fff;padding:5px 10px;display:flex;justify-content:space-between;align-items:center}',
    '.dc-logo{font-weight:900;font-size:11pt;letter-spacing:2px}',
    '.dc-tag{background:rgba(255,255,255,.2);padding:1px 7px;border-radius:99px;font-size:7pt;font-weight:700}',
    '.dc-body{padding:7px 10px;display:flex;flex-direction:column;gap:3px}',
    '.dc-row{display:flex;align-items:center;gap:5px}',
    '.dc-lbl{font-size:7pt;color:#64748b;min-width:40px;font-weight:700}',
    '.dc-val{font-weight:700;font-size:9pt;color:#1e1b4b}',
    '.dc-due-sec{margin-top:3px}',
    '.dc-months{display:flex;flex-wrap:wrap;gap:2px;margin-top:2px}',
    '.dc-mo{background:#fef3c7;color:#92400e;padding:1px 5px;border-radius:4px;font-size:7pt;font-weight:700;border:1px solid #fde68a}',
    '.dc-total{background:#fef2f2;border-radius:4px;padding:3px 7px;margin-top:3px;display:flex;justify-content:space-between;border:1px solid #fecaca;font-size:8pt}',
    '.dc-num{font-weight:900;color:#dc2626}',
    '.dc-msg{margin-top:5px;font-size:7pt;color:#374151;line-height:1.5;background:#f8faff;border-radius:4px;padding:5px 7px;border-left:3px solid #4f46e5}',
    '.dc-footer{background:#f1f5f9;border-top:1px solid #e0e7ff;padding:4px 10px;font-size:7pt;color:#64748b;display:flex;justify-content:space-between}',
    '.dc-abs-ok{background:#f0fdf4;border:1px solid #bbf7d0}',
    '.dc-abs-bad{background:#fef2f2;border:1px solid #fecaca}',
    '@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact}}'
  ].join('');
  var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><style>'+css+'</style></head><body><div class="grid">'+cardHTML+'</div><\/body><\/html>';
  var w=window.open('','_blank','width=900,height=700');
  w.document.write(html);
  w.document.close();
  w.onload=function(){w.focus();w.print();};
}


async function openAttEdit(){
  g('aeDate').value=new Date().toISOString().split('T')[0];
  var srcCl=g('aCl'),srcBt=g('aBt');
  if(srcCl){g('aeCl').innerHTML=srcCl.innerHTML;g('aeBt').innerHTML=srcBt.innerHTML;}
  g('aeModal').style.display='flex';
}
function closeAttEdit(){g('aeModal').style.display='none';}

window.onload=function(){
  loadClassDaysFromDB();
  if(isOnline && getQueue().length) setTimeout(syncOfflineQueue, 2000);
  updateOfflineBar();
  // Close more panel when clicking outside
  document.addEventListener('click', function(e){
    var panel = g('morePanel');
    var btn = g('m-more');
    if(!panel || panel.style.display === 'none') return;
    if(!panel.contains(e.target) && e.target !== btn && !btn.contains(e.target)){
      closeMM();
    }
  });
  // Restore student session on refresh
  var _ub=localStorage.getItem('ub');
  var _sid=localStorage.getItem('ub_sid');
  if(_ub==='s'&&_sid){
    SB.from('students').select('*').eq('id',_sid).single().then(function(r){
      if(r.data){hide('lo');g('sd').style.display='block';renderStuDash(r.data);}
      else{localStorage.removeItem('ub');localStorage.removeItem('ub_sid');}
    });
    return;
  }
  loadPubNotice();loadLoginCls();var auth=localStorage.getItem('ub');if(auth==='a')showAdmin();else if(auth==='t')showTeacher();};
</script>
<script>
var AE_CHANGES={};

async function openAttEdit(){
  g('aeDate').value=new Date().toISOString().split('T')[0];
  var srcCl=g('aCl'),srcBt=g('aBt');
  if(srcCl){g('aeCl').innerHTML=srcCl.innerHTML;g('aeBt').innerHTML=srcBt.innerHTML;}
  AE_CHANGES={};
  g('aeList').innerHTML='<p style="color:#94a3b8;font-size:.8rem;text-align:center;padding:20px">à¦¤à¦¾à¦°à¦¿à¦– à¦“ à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦²à§‹à¦¡ à¦•à¦°à§à¦¨</p>';
  g('aeModal').style.display='flex';
}

function closeAttEdit(){
  g('aeModal').style.display='none';
  AE_CHANGES={};
}

async function loadAttEdit(){
  var date=g('aeDate').value,cls=g('aeCl').value,bch=g('aeBt').value;
  if(!date){alert('à¦¤à¦¾à¦°à¦¿à¦– à¦¦à¦¿à¦¨!');return;}
  var list=g('aeList');
  list.innerHTML='<p style="color:#94a3b8;font-size:.8rem;padding:10px;text-align:center">à¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...</p>';
  var q=SB.from('students').select('*');
  if(cls!=='All')q=q.eq('class',cls);
  if(bch!=='All')q=q.eq('batch',bch);
  var r1=await q.order('roll_no');
  if(!r1.data||!r1.data.length){
    list.innerHTML='<p style="color:#94a3b8;font-size:.8rem;padding:10px;text-align:center">à¦•à§‹à¦¨à§‹ à¦¶à¦¿à¦•à§à¦·à¦¾à¦°à§à¦¥à§€ à¦¨à§‡à¦‡</p>';
    return;
  }
  var ids=r1.data.map(function(s){return s.id;});
  var r2=await SB.from('attendance').select('student_id,status').eq('attendance_date',date).in('student_id',ids);
  var attMap={};
  (r2.data||[]).forEach(function(a){attMap[a.student_id]=a.status;});
  // Load total absence count for each student
  var r3=await SB.from('attendance').select('student_id,status').in('student_id',ids).eq('status','Absent').limit(5000);
  var totalAbsMap={};
  (r3.data||[]).forEach(function(a){totalAbsMap[a.student_id]=(totalAbsMap[a.student_id]||0)+1;});
  list.innerHTML='';
  AE_CHANGES={};
  r1.data.forEach(function(s){
    var st=attMap[s.id]||'';
    var isP=st==='Present',isA=st==='Absent';
    var row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;margin-bottom:4px;background:'+(isP?'#f0fdf4':isA?'#fef2f2':'#f8faff')+';border:1px solid '+(isP?'#bbf7d0':isA?'#fecaca':'#e0e7ff');
    var rollEl=document.createElement('span');
    rollEl.style.cssText='font-weight:700;font-size:.72rem;min-width:26px;color:#64748b';
    rollEl.textContent=s.roll_no;
    var nameEl=document.createElement('span');
    nameEl.style.cssText='flex:1;font-size:.8rem;font-weight:600;display:flex;flex-direction:column;gap:1px';
    var nameTxt=document.createElement('span');
    nameTxt.textContent=s.name;
    nameEl.appendChild(nameTxt);
    var totalAbs=totalAbsMap[s.id]||0;
    if(totalAbs>0){
      var absBadge=document.createElement('span');
      absBadge.style.cssText='font-size:.6rem;font-weight:700;color:'+(totalAbs>5?'#dc2626':'#16a34a');
      absBadge.textContent=(totalAbs>5?'âš ï¸ à¦…à¦¨à¦¿à¦¯à¦¼à¦®à¦¿à¦¤':'âœ… à¦¨à¦¿à¦¯à¦¼à¦®à¦¿à¦¤')+' Â· '+totalAbs+'à¦¦à¦¿à¦¨ à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤';
      nameEl.appendChild(absBadge);
    }
    var btnWrap=document.createElement('div');
    btnWrap.style.cssText='display:flex;gap:4px;align-items:center';
    var pBtn=document.createElement('button');
    pBtn.className='ae-btn '+(isP?'ae-p':'ae-off');
    pBtn.title='à¦‰à¦ªà¦¸à§à¦¥à¦¿à¦¤';
    pBtn.textContent='âœ…';
    var aBtn=document.createElement('button');
    aBtn.className='ae-btn '+(isA?'ae-a':'ae-off');
    aBtn.title='à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤';
    aBtn.textContent='âŒ';
    pBtn.onclick=function(){
      AE_CHANGES[s.id]='Present';
      pBtn.className='ae-btn ae-p';
      aBtn.className='ae-btn ae-off';
      row.style.background='#f0fdf4';
      row.style.borderColor='#bbf7d0';
    };
    aBtn.onclick=function(){
      AE_CHANGES[s.id]='Absent';
      aBtn.className='ae-btn ae-a';
      pBtn.className='ae-btn ae-off';
      row.style.background='#fef2f2';
      row.style.borderColor='#fecaca';
    };
    var delBtn=document.createElement('button');
    delBtn.className='ae-btn';
    delBtn.style.cssText='background:#fee2e2;color:#dc2626;margin-left:4px';
    delBtn.title='à¦à¦¨à§à¦Ÿà§à¦°à¦¿ à¦®à§à¦›à§à¦¨';
    delBtn.textContent='ğŸ—‘ï¸';
    delBtn.onclick=async function(){
      if(!confirm(s.name+' à¦à¦° '+date+' à¦¤à¦¾à¦°à¦¿à¦–à§‡à¦° à¦¹à¦¾à¦œà¦¿à¦°à¦¾ à¦®à§à¦›à¦¬à§‡à¦¨?'))return;
      var r=await SB.from('attendance').delete().eq('student_id',s.id).eq('attendance_date',date);
      if(r.error){alert('âŒ '+r.error.message);return;}
      delete AE_CHANGES[s.id];
      row.remove();
      if(typeof loadS==='function')loadS();
    };
    if(!st){
      var badge=document.createElement('span');
      badge.style.cssText='font-size:.6rem;color:#f59e0b;font-weight:700;background:#fef3c7;padding:1px 5px;border-radius:4px';
      badge.textContent='à¦¨à¦¤à§à¦¨';
      btnWrap.appendChild(badge);
    }
    btnWrap.appendChild(pBtn);
    btnWrap.appendChild(aBtn);
    if(st) btnWrap.appendChild(delBtn);
    row.appendChild(rollEl);
    row.appendChild(nameEl);
    row.appendChild(btnWrap);
    list.appendChild(row);
  });
}

async function saveAttEdit(){
  var date=g('aeDate').value;
  var keys=Object.keys(AE_CHANGES);
  if(!date||!keys.length){alert('à¦•à§‹à¦¨à§‹ à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦¨à§‡à¦‡!');return;}
  var recs=keys.map(function(sid){
    return {student_id:parseInt(sid,10),attendance_date:date,status:AE_CHANGES[sid]};
  });
  var r=await SB.from('attendance').upsert(recs,{onConflict:'student_id,attendance_date'});
  if(r.error){alert('âŒ '+r.error.message);return;}
  AE_CHANGES={};
  alert('âœ… '+recs.length+'à¦Ÿà¦¿ à¦¹à¦¾à¦œà¦¿à¦°à¦¾ à¦¸à¦‚à¦¶à§‹à¦§à¦¨ à¦¹à¦¯à¦¼à§‡à¦›à§‡!');
  loadAttEdit();
  if(typeof loadS==='function')loadS();
}

function toggleEnrollFee(){
  var cb=g('eCollectFee');
  var ex=g('eFeeExtra');
  if(cb&&ex) ex.style.display=cb.checked?'flex':'none';
}

window.addEventListener('load',function(){var ae=g('aeModal');if(ae)ae.addEventListener('click',function(e){if(e.target===this)closeAttEdit();});});
</script>
<script>

async function saveExpense(){
  var date=g('exDate').value,amt=g('exAmt').value,cat=g('exCat').value,desc=g('exDesc').value.trim();
  if(!date||!amt||!cat){alert('à¦¤à¦¾à¦°à¦¿à¦–, à¦ªà¦°à¦¿à¦®à¦¾à¦£ à¦“ à¦•à§à¦¯à¦¾à¦Ÿà¦¾à¦—à¦°à¦¿ à¦¦à¦¿à¦¨!');return;}
  var r=await SB.from('expenses').insert([{
    expense_date:date,
    amount:parseFloat(amt),
    category:cat,
    description:desc||null
  }]);
  if(r.error){alert('âŒ '+r.error.message);return;}
  g('exAmt').value='';g('exDesc').value='';g('exCat').selectedIndex=0;
  alert('âœ… à¦–à¦°à¦š à¦¸à§‡à¦­ à¦¹à¦¯à¦¼à§‡à¦›à§‡!');
  loadExpenses();
}

async function loadExpenses(){
  var mo=g('exFMo').value,yr=g('exFYr').value;
  var from=yr+'-'+mo+'-01';
  var lastDay=new Date(parseInt(yr),parseInt(mo),0).getDate();
  var to=yr+'-'+mo+'-'+lastDay;
  var r=await SB.from('expenses').select('*').gte('expense_date',from).lte('expense_date',to).order('expense_date',{ascending:false});
  var data=r.data||[];
  // Summary by category
  var catMap={};
  var total=0;
  data.forEach(function(ex){
    catMap[ex.category]=(catMap[ex.category]||0)+ex.amount;
    total+=ex.amount;
  });
  // Render summary
  var sumHTML='<div style="grid-column:1/-1;background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center"><span style="font-weight:700;font-size:.82rem">à¦®à§‹à¦Ÿ à¦–à¦°à¦š</span><span style="font-weight:900;font-size:1.1rem;color:#dc2626">à§³'+total.toLocaleString('bn-BD')+'</span></div>';
  Object.keys(catMap).forEach(function(cat){
    sumHTML+='<div style="background:#f8faff;border:1px solid #e0e7ff;border-radius:8px;padding:8px 12px"><p style="font-size:.68rem;color:#64748b;margin:0">'+cat+'</p><p style="font-weight:700;font-size:.9rem;margin:0;color:#1e1b4b">à§³'+catMap[cat].toLocaleString('bn-BD')+'</p></div>';
  });
  g('exSummary').innerHTML=sumHTML;
  // Render list
  if(!data.length){g('exList').innerHTML='<p style="text-align:center;color:#94a3b8;font-size:.8rem;padding:20px">à¦à¦‡ à¦®à¦¾à¦¸à§‡ à¦•à§‹à¦¨à§‹ à¦–à¦°à¦š à¦¨à§‡à¦‡</p>';return;}
  var listEl=g('exList');
  listEl.innerHTML='';
  data.forEach(function(ex){
    var row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:10px;padding:10px 12px;background:#fff;border:1px solid #e0e7ff;border-radius:10px';
    var left=document.createElement('div');
    left.style.cssText='flex:1';
    var top=document.createElement('div');
    top.style.cssText='display:flex;gap:6px;align-items:center';
    var catBadge=document.createElement('span');
    catBadge.style.cssText='font-size:.65rem;font-weight:700;background:#eff6ff;color:#3b82f6;padding:2px 7px;border-radius:99px';
    catBadge.textContent=ex.category;
    var dateEl=document.createElement('span');
    dateEl.style.cssText='font-size:.65rem;color:#94a3b8';
    dateEl.textContent=ex.expense_date;
    top.appendChild(catBadge);top.appendChild(dateEl);
    var desc=document.createElement('p');
    desc.style.cssText='font-size:.78rem;font-weight:600;margin:2px 0 0;color:#1e1b4b';
    desc.textContent=ex.description||ex.category;
    left.appendChild(top);left.appendChild(desc);
    var amt=document.createElement('span');
    amt.style.cssText='font-weight:800;font-size:.9rem;color:#dc2626;white-space:nowrap';
    amt.textContent='à§³'+ex.amount.toLocaleString('bn-BD');
    var delBtn=document.createElement('button');
    delBtn.style.cssText='background:#fef2f2;border:none;color:#dc2626;width:28px;height:28px;border-radius:8px;cursor:pointer;font-size:.8rem';
    delBtn.textContent='ğŸ—‘ï¸';
    delBtn.onclick=async function(){
      if(!confirm('à¦à¦‡ à¦–à¦°à¦š à¦®à§à¦›à¦¬à§‡à¦¨?'))return;
      var dr=await SB.from('expenses').delete().eq('id',ex.id);
      if(dr.error){alert('âŒ '+dr.error.message);return;}
      row.remove();
      loadExpenses();
    };
    row.appendChild(left);row.appendChild(amt);row.appendChild(delBtn);
    listEl.appendChild(row);
  });
}

function initExpenseTab(){
  // Set current month
  var now=new Date();
  var mo=String(now.getMonth()+1).padStart(2,'0');
  g('exFMo').value=mo;
  g('exDate').value=now.toISOString().split('T')[0];
  loadExpenses();
}


/* DAILY TEST */
var selDTId=null,selDTTotal=100;

async function createDailyTest(){
  var name=g('dtName').value.trim(),date=g('dtDate').value,total=parseFloat(g('dtTotal').value)||100;
  var cls=g('dtCl').value,bat=g('dtBt').value;
  if(!name||!date){alert('à¦¨à¦¾à¦® à¦“ à¦¤à¦¾à¦°à¦¿à¦– à¦¦à¦¿à¦¨!');return;}
  var r=await SB.from('daily_tests').insert([{test_name:name,test_date:date,class:cls,batch:bat,total_marks:total}]).select();
  if(r.error){alert('âŒ '+r.error.message);return;}
  g('dtName').value='';
  alert('âœ… à¦Ÿà§‡à¦¸à§à¦Ÿ à¦¤à§ˆà¦°à¦¿ à¦¹à¦¯à¦¼à§‡à¦›à§‡!');
  loadDailyTests();
}

async function loadDailyTests(){
  var cls=g('dtLCl').value,bat=g('dtLBt').value;
  var q=SB.from('daily_tests').select('*');
  if(cls!=='All')q=q.eq('class',cls);
  if(bat!=='All')q=q.eq('batch',bat);
  var r=await q.order('test_date',{ascending:false}).limit(50);
  var el=g('dtList');
  if(!r.data||!r.data.length){el.innerHTML='<p style="text-align:center;color:var(--muted);padding:20px">à¦•à§‹à¦¨à§‹ à¦Ÿà§‡à¦¸à§à¦Ÿ à¦¨à§‡à¦‡</p>';g('dtEntry').classList.add('hidden');return;}
  el.innerHTML='';
  r.data.forEach(function(t){
    var card=document.createElement('div');
    card.className='exam-card';
    card.innerHTML='<p style="font-weight:700;font-size:.85rem">'+e(t.test_name)+'</p><p style="font-size:.65rem;color:var(--muted);margin-top:3px">'+fd(t.test_date)+' | à¦¨à¦®à§à¦¬à¦°: '+t.total_marks+'</p>';
    card.onclick=function(){selectDT(t.id,t.test_name,t.total_marks,t.class,t.batch,t.test_date);};
    el.appendChild(card);
  });
}

async function selectDT(id,name,total,cls,bch,date){
  selDTId=id;selDTTotal=total;
  g('dtSelName').innerText=name;
  g('dtSelInfo').innerText=fd(date)+' | '+cls+' | '+bch+' | à¦¸à¦°à§à¦¬à§‹à¦šà§à¦š: '+total;
  show('dtEntry');
  var q=SB.from('students').select('*');
  if(cls!=='All')q=q.eq('class',cls);
  if(bch!=='All')q=q.eq('batch',bch);
  var r1=await q.order('roll_no').limit(1000);
  var r2=await SB.from('daily_test_results').select('*').eq('test_id',id).limit(1000);
  var el=g('dtMarksList');
  el.innerHTML='';
  (r1.data||[]).forEach(function(s){
    var res=r2.data&&r2.data.find(function(x){return x.student_id===s.id;});
    var row=document.createElement('div');
    row.className='sr fi';
    row.style.cssText='flex-direction:row;align-items:center;gap:10px';
    var info=document.createElement('div');
    info.style.flex='1';
    info.innerHTML='<p style="font-weight:700;font-size:.82rem">'+e(s.name)+'</p><p style="font-size:.6rem;color:var(--muted)">à¦°à§‹à¦²:'+s.roll_no+'</p>';
    var inp=document.createElement('input');
    inp.type='number';inp.id='dtmk-'+s.id;inp.className='marks-inp';
    inp.value=res?res.marks_obtained:'';inp.max=total;
    var gr=document.createElement('div');
    gr.id='dtgr-'+s.id;
    gr.style.cssText='min-width:32px;text-align:center;font-size:.68rem;font-weight:700;color:#94a3b8';
    gr.textContent=res?calcGrade((res.marks_obtained/total)*100).grade:'â€”';
    inp.oninput=function(){
      var v=parseFloat(inp.value);
      gr.textContent=isNaN(v)?'â€”':calcGrade((v/total)*100).grade;
    };
    row.appendChild(info);row.appendChild(inp);row.appendChild(gr);
    el.appendChild(row);
  });
  g('dtEntry').scrollIntoView({behavior:'smooth'});
}

async function saveDTMarks(){
  if(!selDTId)return;
  var recs=[];
  g('dtMarksList').querySelectorAll('.marks-inp').forEach(function(inp){
    var sid=parseInt(inp.id.replace('dtmk-',''));
    var v=inp.value.trim();
    if(v!=='')recs.push({test_id:selDTId,student_id:sid,marks_obtained:parseFloat(v)});
  });
  if(!recs.length){alert('à¦•à§‹à¦¨à§‹ à¦¨à¦®à§à¦¬à¦° à¦¦à§‡à¦“à¦¯à¦¼à¦¾ à¦¹à¦¯à¦¼à¦¨à¦¿!');return;}
  var r=await SB.from('daily_test_results').upsert(recs,{onConflict:'test_id,student_id'});
  if(r.error){alert('âŒ '+r.error.message);return;}
  alert('âœ… '+recs.length+' à¦œà¦¨à§‡à¦° à¦¨à¦®à§à¦¬à¦° à¦¸à§‡à¦­ à¦¹à¦¯à¦¼à§‡à¦›à§‡!');
  selectDT(selDTId,g('dtSelName').innerText,selDTTotal,'All','All',new Date().toISOString().split('T')[0]);
}

async function loadDTSummary(){
  var mo=g('dtMo').value,cls=g('dtSCl').value,bat=g('dtSBt').value;
  if(!mo){alert('à¦®à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  var from=mo+'-01';
  var d=new Date(mo+'-01');d.setMonth(d.getMonth()+1);d.setDate(0);
  var to=mo+'-'+d.getDate();
  var el=g('dtSummary');
  el.innerHTML='<div class="sk" style="height:50px;width:100%"></div>';
  // Load tests for this month+class+batch
  var q=SB.from('daily_tests').select('*').gte('test_date',from).lte('test_date',to);
  if(cls!=='All')q=q.eq('class',cls);
  if(bat!=='All')q=q.eq('batch',bat);
  var r1=await q.order('test_date').limit(200);
  if(!r1.data||!r1.data.length){el.innerHTML='<p style="text-align:center;color:var(--muted);padding:20px">à¦à¦‡ à¦®à¦¾à¦¸à§‡ à¦•à§‹à¦¨à§‹ à¦Ÿà§‡à¦¸à§à¦Ÿ à¦¨à§‡à¦‡</p>';return;}
  var testIds=r1.data.map(function(t){return t.id;});
  // Load all results
  var r2=await SB.from('daily_test_results').select('*').in('test_id',testIds).limit(2000);
  // Load students
  var sq=SB.from('students').select('*');
  if(cls!=='All')sq=sq.eq('class',cls);
  if(bat!=='All')sq=sq.eq('batch',bat);
  var r3=await sq.order('roll_no').limit(1000);
  if(!r3.data||!r3.data.length){el.innerHTML='<p style="text-align:center;color:var(--muted);padding:20px">à¦•à§‹à¦¨à§‹ à¦¶à¦¿à¦•à§à¦·à¦¾à¦°à§à¦¥à§€ à¦¨à§‡à¦‡</p>';return;}
  // Build summary per student
  var stuMap={};
  r3.data.forEach(function(s){stuMap[s.id]={name:s.name,roll:s.roll_no,total:0,count:0,tests:{}};});
  (r2.data||[]).forEach(function(res){
    if(stuMap[res.student_id]&&res.marks_obtained!==null){
      stuMap[res.student_id].total+=res.marks_obtained;
      stuMap[res.student_id].count+=1;
      stuMap[res.student_id].tests[res.test_id]=res.marks_obtained;
    }
  });
  // Sort by total desc
  var rows=Object.values(stuMap).sort(function(a,b){return b.total-a.total;});
  rows.forEach(function(r,i){r.merit=i+1;});
  // Build HTML
  var maxTotal=r1.data.reduce(function(s,t){return s+t.total_marks;},0);
  var html='<p style="font-size:.72rem;color:var(--muted);margin-bottom:10px">à¦®à§‹à¦Ÿ '+r1.data.length+'à¦Ÿà¦¿ à¦Ÿà§‡à¦¸à§à¦Ÿ | à¦¸à¦°à§à¦¬à§‹à¦šà§à¦š à¦®à§‹à¦Ÿ: '+maxTotal+'</p>';
  html+='<div style="overflow-x:auto;border-radius:12px;border:1px solid #e0e7ff"><table class="rt"><thead><tr>';
  html+='<th>à¦®à§‡à¦°à¦¿à¦Ÿ</th><th style="text-align:left">à¦¨à¦¾à¦®</th><th>à¦°à§‹à¦²</th>';
  r1.data.forEach(function(t){html+='<th title="'+e(t.test_name)+'">'+fd(t.test_date).split('/')[0]+'/'+fd(t.test_date).split('/')[1]+'<br><span style="font-size:.6rem">'+t.total_marks+'</span></th>';});
  html+='<th>à¦®à§‹à¦Ÿ</th><th>à¦®à§‡à¦°à¦¿à¦Ÿ</th></tr></thead><tbody>';
  rows.forEach(function(r){
    var mc=r.merit<=3?['#fef9c3','#e0f2fe','#fce7f3'][r.merit-1]:'';
    html+='<tr style="background:'+mc+'">';
    html+='<td>'+r.merit+'</td><td style="text-align:left;font-weight:600">'+e(r.name)+'</td><td>'+r.roll+'</td>';
    r1.data.forEach(function(t){
      var m=r.tests[t.id];
      html+='<td>'+(m!==undefined?m:'â€”')+'</td>';
    });
    html+='<td style="font-weight:800;color:var(--g1)">'+r.total+'</td><td style="font-weight:800">ğŸ…'+r.merit+'</td></tr>';
  });
  html+='</tbody></table></div>';
  el.innerHTML=html;
  show('dtPrint');
}

async function printDTResult(){
  if(!selDTId)return;
  var name=g('dtSelName').innerText,info=g('dtSelInfo').innerText;
  var r1=await SB.from('daily_test_results').select('marks_obtained,student_id').eq('test_id',selDTId).limit(1000);
  var r2=await SB.from('students').select('id,name,roll_no').limit(1000);
  if(!r1.data||!r1.data.length){alert('à¦•à§‹à¦¨à§‹ à¦°à§‡à¦œà¦¾à¦²à§à¦Ÿ à¦¨à§‡à¦‡!');return;}
  var stuMap={};
  (r2.data||[]).forEach(function(s){stuMap[s.id]=s;});
  var rows=[];
  r1.data.forEach(function(d){
    if(d.marks_obtained===null)return;
    var s=stuMap[d.student_id];if(!s)return;
    var pct=Math.round((d.marks_obtained/selDTTotal)*100);
    var gr=calcGrade(pct);
    rows.push({name:s.name,roll:s.roll_no,marks:d.marks_obtained,pct:pct,grade:gr.grade});
  });
  rows.sort(function(a,b){return b.marks-a.marks;});
  rows.forEach(function(r,i){r.merit=i+1;});
  var today=new Date();
  var dateStr=today.getDate()+'/'+(today.getMonth()+1)+'/'+today.getFullYear();
  var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Arial,sans-serif;margin:0;padding:10mm}h1{text-align:center;font-size:18pt;margin:0;letter-spacing:2px}.sub{text-align:center;font-size:9pt;color:#555;margin:4px 0 10px;border-bottom:2px solid #10b981;padding-bottom:6px}table{width:100%;border-collapse:collapse;font-size:9pt}thead th{background:#10b981;color:#fff;padding:6px 8px;text-align:center;border:1px solid #059669}td{padding:5px 7px;border:1px solid #ddd;text-align:center}tr:nth-child(even) td{background:#f0fdf4}.name-cell{text-align:left;font-weight:600}.m1 td{background:#fef9c3!important}.m2 td{background:#e0f2fe!important}.m3 td{background:#fce7f3!important}.footer{margin-top:6mm;display:flex;justify-content:space-between;font-size:8pt;color:#666;border-top:1px solid #ddd;padding-top:3px}@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact}}</style></head><body>';
  html+='<h1>UBIQUE</h1><div class="sub">'+e(name)+' â€” '+e(info)+'</div>';
  html+='<table><thead><tr><th>à¦®à§‡à¦°à¦¿à¦Ÿ</th><th style="text-align:left">à¦¨à¦¾à¦®</th><th>à¦°à§‹à¦²</th><th>à¦¨à¦®à§à¦¬à¦°</th><th>à¦®à§‹à¦Ÿ</th><th>%</th><th>à¦—à§à¦°à§‡à¦¡</th></tr></thead><tbody>';
  html+=rows.map(function(r){
    var mc=r.merit===1?'m1':r.merit===2?'m2':r.merit===3?'m3':'';
    return'<tr class="'+mc+'"><td>'+r.merit+'</td><td class="name-cell">'+e(r.name)+'</td><td>'+r.roll+'</td><td style="font-weight:700">'+r.marks+'</td><td>'+selDTTotal+'</td><td>'+r.pct+'%</td><td><b>'+r.grade+'</b></td></tr>';
  }).join('');
  html+='</tbody></table><div class="footer"><span>à¦¤à¦¾à¦°à¦¿à¦–: '+dateStr+'</span><span>à¦®à§‹à¦Ÿ: '+rows.length+'</span><span>UBIQUE</span></div><\/body><\/html>';
  var w=window.open('','_blank','width=900,height=700');
  w.document.write(html);w.document.close();
  w.onload=function(){w.focus();w.print();};
}

async function printDTSummary(){
  var mo=g('dtMo').value,cls=g('dtSCl').value,bat=g('dtSBt').value;
  var from=mo+'-01';
  var d=new Date(mo+'-01');d.setMonth(d.getMonth()+1);d.setDate(0);
  var to=mo+'-'+d.getDate();
  var q=SB.from('daily_tests').select('*').gte('test_date',from).lte('test_date',to);
  if(cls!=='All')q=q.eq('class',cls);
  if(bat!=='All')q=q.eq('batch',bat);
  var r1=await q.order('test_date').limit(200);
  if(!r1.data||!r1.data.length){alert('à¦•à§‹à¦¨à§‹ à¦Ÿà§‡à¦¸à§à¦Ÿ à¦¨à§‡à¦‡!');return;}
  var testIds=r1.data.map(function(t){return t.id;});
  var r2=await SB.from('daily_test_results').select('*').in('test_id',testIds).limit(2000);
  var sq=SB.from('students').select('*');
  if(cls!=='All')sq=sq.eq('class',cls);
  if(bat!=='All')sq=sq.eq('batch',bat);
  var r3=await sq.order('roll_no').limit(1000);
  var stuMap={};
  r3.data.forEach(function(s){stuMap[s.id]={name:s.name,roll:s.roll_no,total:0,count:0,tests:{}};});
  (r2.data||[]).forEach(function(res){
    if(stuMap[res.student_id]&&res.marks_obtained!==null){
      stuMap[res.student_id].total+=res.marks_obtained;
      stuMap[res.student_id].count+=1;
      stuMap[res.student_id].tests[res.test_id]=res.marks_obtained;
    }
  });
  var rows=Object.values(stuMap).sort(function(a,b){return b.total-a.total;});
  rows.forEach(function(r,i){r.merit=i+1;});
  var maxTotal=r1.data.reduce(function(s,t){return s+t.total_marks;},0);
  var moStr=mo;
  var today=new Date();
  var dateStr=today.getDate()+'/'+(today.getMonth()+1)+'/'+today.getFullYear();
  var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Arial,sans-serif;margin:0;padding:8mm;font-size:8pt}h1{text-align:center;font-size:16pt;margin:0}.sub{text-align:center;font-size:8pt;color:#555;margin:3px 0 8px;border-bottom:2px solid #6366f1;padding-bottom:4px}table{width:100%;border-collapse:collapse;font-size:7.5pt}th{background:#6366f1;color:#fff;padding:5px 4px;border:1px solid #4f46e5;white-space:nowrap}td{padding:4px 4px;border:1px solid #ddd;text-align:center}tr:nth-child(even) td{background:#f8faff}.name-cell{text-align:left;font-weight:600}.m1 td{background:#fef9c3!important}.m2 td{background:#e0f2fe!important}.m3 td{background:#fce7f3!important}.footer{margin-top:5mm;display:flex;justify-content:space-between;font-size:7pt;color:#666;border-top:1px solid #ddd;padding-top:2px}@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact}}</style></head><body>';
  html+='<h1>UBIQUE</h1><div class="sub">à¦¡à§‡à¦‡à¦²à¦¿ à¦Ÿà§‡à¦¸à§à¦Ÿ à¦®à¦¾à¦¸à¦¿à¦• à¦®à§‡à¦°à¦¿à¦Ÿ â€” '+moStr+' | à¦®à§‹à¦Ÿ '+r1.data.length+'à¦Ÿà¦¿ à¦Ÿà§‡à¦¸à§à¦Ÿ | à¦¸à¦°à§à¦¬à§‹à¦šà§à¦š: '+maxTotal+'</div>';
  html+='<table><thead><tr><th>à¦®à§‡à¦°à¦¿à¦Ÿ</th><th style="text-align:left">à¦¨à¦¾à¦®</th><th>à¦°à§‹à¦²</th>';
  r1.data.forEach(function(t){html+='<th>'+fd(t.test_date).split('/')[0]+'/'+fd(t.test_date).split('/')[1]+'<br>'+t.total_marks+'</th>';});
  html+='<th>à¦®à§‹à¦Ÿ</th></tr></thead><tbody>';
  rows.forEach(function(r){
    var mc=r.merit===1?'m1':r.merit===2?'m2':r.merit===3?'m3':'';
    html+='<tr class="'+mc+'"><td>'+r.merit+'</td><td class="name-cell">'+e(r.name)+'</td><td>'+r.roll+'</td>';
    r1.data.forEach(function(t){html+='<td>'+(r.tests[t.id]!==undefined?r.tests[t.id]:'â€”')+'</td>';});
    html+='<td style="font-weight:800">'+r.total+'</td></tr>';
  });
  html+='</tbody></table><div class="footer"><span>'+dateStr+'</span><span>UBIQUE</span></div><\/body><\/html>';
  var w=window.open('','_blank','width=1100,height=700');
  w.document.write(html);w.document.close();
  w.onload=function(){w.focus();w.print();};
}


/* ONLINE CLASSES */
function getVideoEmbed(url){
  if(!url)return null;
  // YouTube
  var yt=url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|shorts\/v\/|shorts\/))([\w-]{11})/);
  if(yt)return {type:'youtube',id:yt[1]};
  // Google Drive
  var gd=url.match(/drive\.google\.com\/(?:file\/d\/|open\?id=)([\w-]+)/);
  if(gd)return {type:'drive',id:gd[1]};
  return null;
}
function getEmbedSrc(v){
  if(!v)return '';
  if(v.type==='youtube')return 'https://www.youtube.com/embed/'+v.id+'?rel=0&modestbranding=1';
  if(v.type==='drive')return 'https://drive.google.com/file/d/'+v.id+'/preview';
  return '';
}

async function saveOnlineClass(){
  var title=g('ocTitle').value.trim(),desc=g('ocDesc').value.trim();
  var url=g('ocUrl').value.trim(),cls=g('ocCl').value,bat=g('ocBt').value;
  if(!title||!url){alert('à¦¶à¦¿à¦°à§‹à¦¨à¦¾à¦® à¦“ à¦²à¦¿à¦‚à¦• à¦¦à¦¿à¦¨!');return;}
  var vid=getVideoEmbed(url);
  if(!vid){alert('âŒ à¦¸à¦ à¦¿à¦• YouTube à¦¬à¦¾ Google Drive à¦²à¦¿à¦‚à¦• à¦¦à¦¿à¦¨!');return;}
  var r=await SB.from('online_classes').insert([{title:title,description:desc||null,youtube_url:vid.type+':'+vid.id,class:cls==='All'?null:cls,batch:bat==='All'?null:bat}]);
  if(r.error){alert('âŒ '+r.error.message);return;}
  g('ocTitle').value='';g('ocDesc').value='';g('ocUrl').value='';
  alert('âœ… à¦­à¦¿à¦¡à¦¿à¦“ à¦¯à§‹à¦— à¦¹à¦¯à¦¼à§‡à¦›à§‡!');
  loadOnlineClasses();
}

async function loadOnlineClasses(){
  var cls=g('ocFCl').value,bat=g('ocFBt').value;
  var q=SB.from('online_classes').select('*');
  if(cls&&cls!=='All')q=q.eq('class',cls);
  if(bat&&bat!=='All')q=q.eq('batch',bat);
  var r=await q.order('created_at',{ascending:false}).limit(100);
  var el=g('ocList');
  if(!r.data||!r.data.length){
    el.innerHTML='<p style="text-align:center;color:var(--muted);padding:20px">à¦•à§‹à¦¨à§‹ à¦­à¦¿à¦¡à¦¿à¦“ à¦¨à§‡à¦‡</p>';
    return;
  }
  el.innerHTML='';
  var isAdmin=localStorage.getItem('ub')==='a';
  r.data.forEach(function(oc){
    var card=document.createElement('div');
    card.style.cssText='background:#fff;border-radius:16px;overflow:hidden;border:1px solid #e0e7ff;box-shadow:0 2px 12px rgba(99,102,241,.07)';
    // Video embed
    var vWrap=document.createElement('div');
    vWrap.style.cssText='position:relative;width:100%;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:0';
    var iframe=document.createElement('iframe');
    var _v=oc.youtube_url;
    var _src='';
    if(_v.indexOf('youtube:')===0){_src='https://www.youtube.com/embed/'+_v.replace('youtube:','')+'?rel=0&modestbranding=1';}
    else if(_v.indexOf('drive:')===0){_src='https://drive.google.com/file/d/'+_v.replace('drive:','')+'/preview?usp=sharing';}
    else{_src='https://www.youtube.com/embed/'+_v+'?rel=0&modestbranding=1';}
    iframe.src=_src;
    iframe.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;border:none';
    iframe.allow='accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture';
    iframe.allowFullscreen=true;
    iframe.setAttribute('scrolling','no');
    iframe.setAttribute('frameborder','0');
    // Info
    var info=document.createElement('div');
    info.style.cssText='padding:12px 14px';
    var title=document.createElement('p');
    title.style.cssText='font-weight:700;font-size:.9rem;color:#1e1b4b;margin-bottom:4px';
    title.textContent=oc.title;
    info.appendChild(title);
    if(oc.description){
      var desc=document.createElement('p');
      desc.style.cssText='font-size:.75rem;color:#64748b;line-height:1.5';
      desc.textContent=oc.description;
      info.appendChild(desc);
    }
    var meta=document.createElement('p');
    meta.style.cssText='font-size:.65rem;color:#94a3b8;margin-top:4px';
    meta.textContent=(oc.class&&oc.class!=='All'?oc.class:'à¦¸à¦¬ à¦•à§à¦²à¦¾à¦¸')+(oc.batch&&oc.batch!=='All'?' | '+oc.batch:'');
    info.appendChild(meta);
    // Delete button (admin only)
    if(isAdmin){
      var delBtn=document.createElement('button');
      delBtn.textContent='ğŸ—‘ï¸ à¦®à§à¦›à§à¦¨';
      delBtn.style.cssText='margin-top:8px;background:#fef2f2;color:#dc2626;border:none;padding:5px 12px;border-radius:8px;font-size:.72rem;font-weight:700;cursor:pointer';
      delBtn.onclick=function(){deleteOnlineClass(oc.id,card);};
      info.appendChild(delBtn);
    }
    vWrap.appendChild(iframe);
    card.appendChild(vWrap);
    card.appendChild(info);
    el.appendChild(card);
  });
}

async function deleteOnlineClass(id,card){
  if(!confirm('à¦à¦‡ à¦­à¦¿à¦¡à¦¿à¦“ à¦®à§à¦›à¦¬à§‡à¦¨?'))return;
  var r=await SB.from('online_classes').delete().eq('id',id);
  if(r.error){alert('âŒ '+r.error.message);return;}
  card.remove();
}


async function loadStuOnline(cls,bat){
  // Fetch videos for this class OR 'All' class
  var r=await SB.from('online_classes').select('*')
    .or('class.eq.'+cls+',class.eq.All')
    .order('created_at',{ascending:false}).limit(50);
  var el=g('sOcList');
  if(!el)return;
  if(!r.data||!r.data.length){
    el.innerHTML='<p style="text-align:center;color:var(--muted);font-size:.8rem;padding:12px">à¦•à§‹à¦¨à§‹ à¦­à¦¿à¦¡à¦¿à¦“ à¦¨à§‡à¦‡</p>';
    return;
  }
  el.innerHTML='';
  r.data.forEach(function(oc){
    var card=document.createElement('div');
    card.style.cssText='background:#f8faff;border-radius:14px;overflow:hidden;border:1px solid #e0e7ff';
    var vWrap=document.createElement('div');
    vWrap.style.cssText='position:relative;width:100%;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:0';
    var iframe=document.createElement('iframe');
    var _v=oc.youtube_url;
    var _src='';
    if(_v.indexOf('youtube:')===0){_src='https://www.youtube.com/embed/'+_v.replace('youtube:','')+'?rel=0&modestbranding=1';}
    else if(_v.indexOf('drive:')===0){_src='https://drive.google.com/file/d/'+_v.replace('drive:','')+'/preview?usp=sharing';}
    else{_src='https://www.youtube.com/embed/'+_v+'?rel=0&modestbranding=1';}
    iframe.src=_src;
    iframe.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;border:none';
    iframe.allow='accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture';
    iframe.allowFullscreen=true;
    iframe.setAttribute('scrolling','no');
    iframe.setAttribute('frameborder','0');
    var info=document.createElement('div');
    info.style.cssText='padding:10px 12px';
    var title=document.createElement('p');
    title.style.cssText='font-weight:700;font-size:.85rem;color:#1e1b4b';
    title.textContent=oc.title;
    info.appendChild(title);
    if(oc.description){
      var desc=document.createElement('p');
      desc.style.cssText='font-size:.72rem;color:#64748b;margin-top:3px;line-height:1.5';
      desc.textContent=oc.description;
      info.appendChild(desc);
    }
    vWrap.appendChild(iframe);
    card.appendChild(vWrap);
    card.appendChild(info);
    el.appendChild(card);
  });
}


/* CALL NOTES */
var _cnStuId=null;

async function openCallNote(sid,name){
  _cnStuId=sid;
  g('cnName').textContent=name;
  g('cnText').value='';
  g('cnModal').style.display='flex';
  await loadCNHistory(sid);
}

function closeCN(){
  g('cnModal').style.display='none';
  _cnStuId=null;
}

async function loadCNHistory(sid){
  var r=await SB.from('call_notes').select('*').eq('student_id',sid).order('created_at',{ascending:false}).limit(20);
  var el=g('cnHistory');
  if(!r.data||!r.data.length){
    el.innerHTML='<p style="text-align:center;color:var(--muted);font-size:.75rem;padding:8px">à¦•à§‹à¦¨à§‹ à¦¨à§‹à¦Ÿ à¦¨à§‡à¦‡</p>';
    return;
  }
  el.innerHTML=r.data.map(function(n){
    var d=new Date(n.created_at);
    var ds=d.toLocaleDateString('bn-BD')+' '+d.toLocaleTimeString('bn-BD',{hour:'2-digit',minute:'2-digit'});
    return '<div style="background:#f8faff;border-radius:10px;padding:10px 12px;border-left:3px solid #6366f1;margin-bottom:6px">'+
      '<p style="font-size:.65rem;color:#94a3b8;margin-bottom:4px">'+ds+'</p>'+
      '<p style="font-size:.78rem;color:#1e1b4b;line-height:1.5">'+e(n.note)+'</p>'+
    '</div>';
  }).join('');
}

async function saveCN(){
  var note=g('cnText').value.trim();
  if(!note){alert('à¦¨à§‹à¦Ÿ à¦²à¦¿à¦–à§à¦¨!');return;}
  var r=await SB.from('call_notes').insert([{student_id:_cnStuId,note:note}]);
  if(r.error){alert('âŒ '+r.error.message);return;}
  g('cnText').value='';
  await loadCNHistory(_cnStuId);
}


// â”€â”€ CLASS DAYS SETTINGS â”€â”€
function loadClassDaysSettings(){
  // Sync dropdown
  var sel=g('cdCls');
  if(!sel)return;
  var src=g('sCl');
  if(src){sel.innerHTML=src.innerHTML;}
  for(var i=sel.options.length-1;i>=0;i--){if(sel.options[i].value==='All')sel.remove(i);}
}

function loadCDays(){
  var cls=gv('cdCls');
  var bt=gv('cdBt');
  if(!cls||cls==='All'){alert('à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  var key=cls+(bt&&bt!=='All'?'_'+bt:'');
  var selected=classDays[key]||[];
  var html='';
  DAYS_BN.forEach(function(d){
    var chk=selected.indexOf(d)!==-1;
    html+='<label style="display:flex;align-items:center;gap:6px;background:'+(chk?'#eff6ff':'#f8faff')+';border:1px solid '+(chk?'#6366f1':'#e0e7ff')+';border-radius:8px;padding:7px 11px;cursor:pointer;font-size:.8rem;font-weight:700">'
      +'<input type="checkbox" value="'+d+'" '+(chk?'checked':'')+' onchange="updateCDayLabel(this)" style="accent-color:#6366f1">'+d+'</label>';
  });
  g('cdDays').innerHTML=html;
}

function updateCDayLabel(cb){
  var lbl=cb.closest('label');
  if(cb.checked){lbl.style.background='#eff6ff';lbl.style.borderColor='#6366f1';}
  else{lbl.style.background='#f8faff';lbl.style.borderColor='#e0e7ff';}
}

async function saveCDays(){
  var cls=gv('cdCls');
  var bt=gv('cdBt');
  if(!cls){alert('à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  var key=cls+(bt&&bt!=='All'?'_'+bt:'');
  var checks=g('cdDays').querySelectorAll('input[type=checkbox]:checked');
  var days=[].map.call(checks,function(cb){return cb.value;});
  if(!days.length){alert('à¦…à¦¨à§à¦¤à¦¤ à¦à¦•à¦Ÿà¦¿ à¦¦à¦¿à¦¨ à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ à¦•à¦°à§à¦¨!');return;}
  classDays[key]=days;
  // Save to academy_settings
  var existing=await SB.from('academy_settings').select('id').eq('key','class_days').single();
  var val=JSON.stringify(classDays);
  var r=existing.data
    ?await SB.from('academy_settings').update({value:val}).eq('type','class_days')
    :await SB.from('academy_settings').insert([{type:'class_days',value:val}]);
  if(r.error)alert('âŒ '+r.error.message);
  else alert('âœ… '+key+' à¦à¦° à¦¦à¦¿à¦¨ à¦¸à§‡à¦­ à¦¹à¦¯à¦¼à§‡à¦›à§‡!');
}

// Load classDays from Supabase on startup
async function loadClassDaysFromDB(){
  var r=await SB.from('academy_settings').select('value').eq('type','class_days').single();
  if(r.data){try{classDays=JSON.parse(r.data.value);}catch(e){classDays={};}}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW ROUTINE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var rtGroups = [];

function addRtGroup(){
  var cls=gv('rtCl'), bt=gv('rtBt');
  if(!cls||cls==='All'){alert('à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  var dayKey=cls+(bt&&bt!=='All'?'_'+bt:'');
  var allowedDays=classDays[dayKey]&&classDays[dayKey].length?classDays[dayKey]:DAYS_BN;
  rtGroups.push({days:[], start:'10:00', end:'12:00', periods:4, grid:{}});
  renderRtGroups(allowedDays);
}

function removeRtGroup(i){
  rtGroups.splice(i,1);
  var cls=gv('rtCl'), bt=gv('rtBt');
  var dayKey=cls+(bt&&bt!=='All'?'_'+bt:'');
  renderRtGroups(classDays[dayKey]&&classDays[dayKey].length?classDays[dayKey]:DAYS_BN);
}

function renderRtGroups(allowedDays){
  var el=g('rtGroups');
  if(!el)return;
  if(!rtGroups.length){
    el.innerHTML='<p style="color:var(--muted);font-size:.75rem;text-align:center;padding:8px">â• à¦¨à¦¤à§à¦¨ Day Group à¦¯à§‹à¦— à¦•à¦°à§à¦¨</p>';
    return;
  }
  el.innerHTML=rtGroups.map(function(grp,gi){
    var dayHtml=allowedDays.map(function(d){
      var chk=grp.days.indexOf(d)!==-1;
      return '<label style="display:flex;align-items:center;gap:4px;font-size:.72rem;font-weight:600;cursor:pointer;padding:4px 8px;border-radius:7px;border:1px solid '+(chk?'#6366f1':'#e0e7ff')+';background:'+(chk?'#eff6ff':'#f8faff')+'">'
        +'<input type="checkbox" value="'+d+'" '+(chk?'checked':'')+' onchange="toggleRtDay('+gi+',this)" style="accent-color:#6366f1">'+d+'</label>';
    }).join('');
    var pOpts=[3,4,5,6,7,8].map(function(n){
      return '<option value="'+n+'"'+(grp.periods===n?' selected':'')+'>'+n+' à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡</option>';
    }).join('');
    return '<div style="border:1.5px solid #e0e7ff;border-radius:12px;padding:12px;background:#f8faff">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
      +'<span style="font-weight:700;font-size:.8rem;color:#4f46e5">Group '+(gi+1)+'</span>'
      +'<button onclick="removeRtGroup('+gi+')" style="background:#fef2f2;border:none;color:#dc2626;font-size:.7rem;padding:3px 9px;border-radius:7px;cursor:pointer;font-weight:700">âœ• à¦®à§à¦›à§à¦¨</button>'
      +'</div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px">'+dayHtml+'</div>'
      +'<div style="display:flex;gap:7px;flex-wrap:wrap">'
      +'<input type="time" value="'+grp.start+'" onchange="rtGroups['+gi+'].start=this.value" class="inp" style="flex:1;min-width:90px">'
      +'<input type="time" value="'+grp.end+'" onchange="rtGroups['+gi+'].end=this.value" class="inp" style="flex:1;min-width:90px">'
      +'<select onchange="rtGroups['+gi+'].periods=parseInt(this.value)" class="inp" style="flex:1;min-width:90px">'+pOpts+'</select>'
      +'</div></div>';
  }).join('');
}

function toggleRtDay(gi,cb){
  var d=cb.value, idx=rtGroups[gi].days.indexOf(d);
  if(cb.checked){if(idx===-1)rtGroups[gi].days.push(d);}
  else{if(idx!==-1)rtGroups[gi].days.splice(idx,1);}
  var lbl=cb.closest('label');
  if(cb.checked){lbl.style.borderColor='#6366f1';lbl.style.background='#eff6ff';}
  else{lbl.style.borderColor='#e0e7ff';lbl.style.background='#f8faff';}
}

function calcPTimes(start,end,count){
  var s=start.split(':'),en=end.split(':');
  var sm=parseInt(s[0])*60+parseInt(s[1]), em=parseInt(en[0])*60+parseInt(en[1]);
  var dur=Math.floor((em-sm)/count);
  var fmt=function(m){return String(Math.floor(m/60)).padStart(2,'0')+':'+String(m%60).padStart(2,'0');};
  var times=[];
  for(var i=0;i<count;i++){var ts=sm+dur*i;times.push(fmt(ts)+'-'+fmt(ts+dur));}
  return times;
}

function buildRtPreview(){
  var cls=gv('rtCl'),bt=gv('rtBt');
  if(!cls||cls==='All'){alert('à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  if(!rtGroups.length){alert('à¦…à¦¨à§à¦¤à¦¤ à¦à¦•à¦Ÿà¦¿ Day Group à¦¯à§‹à¦— à¦•à¦°à§à¦¨!');return;}
  for(var i=0;i<rtGroups.length;i++){
    if(!rtGroups[i].days.length){alert((i+1)+'à¦¨à¦‚ Group à¦ à¦•à§‹à¦¨à§‹ à¦¦à¦¿à¦¨ à¦¨à§‡à¦‡!');return;}
  }
  var html='';
  rtGroups.forEach(function(grp,gi){
    var times=calcPTimes(grp.start,grp.end,grp.periods);
    html+='<div style="margin-bottom:16px">'
      +'<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:.72rem">'
      +'<thead><tr><th style="background:#4f46e5;color:#fff;padding:7px 10px;border:1px solid #6366f1;min-width:80px">à¦¦à¦¿à¦¨</th>';
    for(var p=0;p<grp.periods;p++){
      html+='<th style="background:#4f46e5;color:#fff;padding:6px 4px;border:1px solid #6366f1;min-width:110px;font-size:.68rem">'+(p+1)+' à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡<br><span style="font-weight:400;opacity:.85">'+times[p]+'</span></th>';
    }
    html+='</tr></thead><tbody>';
    grp.days.forEach(function(day){
      html+='<tr><td style="background:#eff6ff;font-weight:700;padding:7px 8px;border:1px solid #e0e7ff;text-align:center;white-space:nowrap">'+day+'</td>';
      for(var p=0;p<grp.periods;p++){
        var cellData=(grp.grid[day]&&grp.grid[day][p])||{};
        var existTch=typeof cellData==='object'?cellData.tch||'':cellData;
        var existSub=typeof cellData==='object'?cellData.sub||'':'';
        var tchOpts='<option value="">-- à¦¶à¦¿à¦•à§à¦·à¦• --</option>'
          +teachersList.map(function(t){return '<option value="'+t.id+'"'+(existTch==t.id?' selected':'')+'>'+e(t.name)+'</option>';}).join('');
        html+='<td style="padding:4px;border:1px solid #e0e7ff;min-width:110px">'
          +'<input placeholder="à¦¬à¦¿à¦·à¦¯à¦¼" data-gi="'+gi+'" data-day="'+encodeURIComponent(day)+'" data-p="'+p+'" data-f="sub" onchange="setRtCellField(this)" value="'+e(existSub)+'" style="width:100%;border:1px solid #e0e7ff;border-radius:5px;padding:2px 4px;font-size:.65rem;margin-bottom:2px;box-sizing:border-box">'
          +'<select data-gi="'+gi+'" data-day="'+encodeURIComponent(day)+'" data-p="'+p+'" data-f="tch" onchange="setRtCellField(this)" style="width:100%;border:1px solid #e0e7ff;border-radius:5px;padding:2px 4px;font-size:.65rem;color:#4f46e5">'+tchOpts+'</select>'
          +'</td>';
      }
      html+='</tr>';
    });
    html+='</tbody></table></div></div>';
  });
  g('rtPreview').innerHTML=html;
  show('rtPrint');
}

function setRtCellEl(sel){
  setRtCellField(sel);
}
function setRtCellField(el){
  var gi=parseInt(el.dataset.gi), day=decodeURIComponent(el.dataset.day), p=parseInt(el.dataset.p), f=el.dataset.f;
  if(!rtGroups[gi].grid[day])rtGroups[gi].grid[day]={};
  if(typeof rtGroups[gi].grid[day][p]!=='object')rtGroups[gi].grid[day][p]={sub:'',tch:''};
  rtGroups[gi].grid[day][p][f]=el.value;
  if(f==='tch')checkConflictNew();
}

async function checkConflictNew(){
  var cls=gv('rtCl'), conflicts=[];
  var tchMap={};
  rtGroups.forEach(function(grp,gi){
    grp.days.forEach(function(day){
      for(var p=0;p<grp.periods;p++){
        var cellD=grp.grid[day]&&grp.grid[day][p];
        var tid=typeof cellD==='object'?cellD.tch:cellD;
        if(!tid)return;
        var k=day+'_'+p;
        if(!tchMap[tid])tchMap[tid]=[];
        tchMap[tid].push({day:day,period:p,key:k});
      }
    });
  });
  Object.keys(tchMap).forEach(function(tid){
    var seen={};
    tchMap[tid].forEach(function(sl){
      if(seen[sl.key]){
        var tn=(teachersList.find(function(t){return t.id==tid;})||{}).name||tid;
        conflicts.push('âš ï¸ '+tn+' â†’ '+sl.day+' à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡ '+(sl.period+1)+' à¦ à¦¦à§à¦‡à¦¬à¦¾à¦°!');
      }
      seen[sl.key]=true;
    });
  });
  var tids=Object.keys(tchMap);
  if(tids.length){
    var crossR=await SB.from('class_routine').select('class,routine_data');
    (crossR.data||[]).forEach(function(row){
      var rd=row.routine_data||{};
      (rd.groups||[]).forEach(function(grp){
        (grp.days||[]).forEach(function(day){
          Object.keys(grp.grid&&grp.grid[day]||{}).forEach(function(pStr){
            var tid=grp.grid[day][pStr];
            if(!tid||!tchMap[tid])return;
            tchMap[tid].forEach(function(sl){
              if(sl.day===day&&sl.period===parseInt(pStr)){
                var tn=(teachersList.find(function(t){return t.id==tid;})||{}).name||tid;
                conflicts.push('ğŸš« '+tn+' â†’ '+day+' à¦ªà¦¿à¦°à¦¿à¦¯à¦¼à¦¡ '+(parseInt(pStr)+1)+' à¦¤à§‡ à¦•à§à¦²à¦¾à¦¸ '+row.class+' à¦ à¦†à¦›à§‡à¦¨!');
              }
            });
          });
        });
      });
    });
  }
  var bar=g('rtConflictBar');
  if(conflicts.length){bar.innerHTML='<strong>Conflict!</strong><br>'+conflicts.join('<br>');show('rtConflictBar');}
  else hide('rtConflictBar');
  return conflicts.length===0;
}

async function saveRoutineNew(){
  var cls=gv('rtCl'),bt=gv('rtBt'),room=g('rtRoom')?g('rtRoom').value.trim():'';
  if(!cls||cls==='All'){alert('à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦¨à¦¿à¦¨!');return;}
  if(!rtGroups.length){alert('à¦…à¦¨à§à¦¤à¦¤ à¦à¦•à¦Ÿà¦¿ Day Group à¦²à¦¾à¦—à¦¬à§‡!');return;}
  var ok=await checkConflictNew();
  if(!ok){alert('âŒ Conflict à¦†à¦›à§‡! à¦†à¦—à§‡ à¦ à¦¿à¦• à¦•à¦°à§à¦¨à¥¤');return;}
  var data={groups:rtGroups,room:room};
  var ex=await SB.from('class_routine').select('id').eq('class',cls+(bt&&bt!=='All'?'_'+bt:'')).maybeSingle();
  var r=ex.data
    ?await SB.from('class_routine').update({routine_data:data}).eq('class',cls+(bt&&bt!=='All'?'_'+bt:''))
    :await SB.from('class_routine').insert([{class:cls+(bt&&bt!=='All'?'_'+bt:''),routine_data:data}]);
  if(r.error)alert('âŒ '+r.error.message);
  else alert('âœ… à¦°à§à¦Ÿà¦¿à¦¨ à¦¸à§‡à¦­ à¦¹à¦¯à¦¼à§‡à¦›à§‡!');
}

async function loadRoutineNew(){
  var cls=gv('rtCl'),bt=gv('rtBt');
  if(!cls||cls==='All')return;
  rtGroups=[];
  var r=await SB.from('class_routine').select('*').eq('class',cls+(bt&&bt!=='All'?'_'+bt:'')).maybeSingle();
  if(!r.data){
    var dayKey=cls+(bt&&bt!=='All'?'_'+bt:'');
    renderRtGroups(classDays[dayKey]&&classDays[dayKey].length?classDays[dayKey]:DAYS_BN);
    g('rtPreview').innerHTML='<p style="text-align:center;color:var(--muted);padding:24px">à¦à¦‡ à¦•à§à¦²à¦¾à¦¸à§‡à¦° à¦°à§à¦Ÿà¦¿à¦¨ à¦¨à§‡à¦‡à¥¤ Day Group à¦¯à§‹à¦— à¦•à¦°à§à¦¨à¥¤</p>';
    hide('rtPrint');
    return;
  }
  var data=r.data.routine_data||{};
  rtGroups=data.groups||[];
  if(g('rtRoom'))g('rtRoom').value=data.room||'';
  var dayKey=cls+(bt&&bt!=='All'?'_'+bt:'');
  renderRtGroups(classDays[dayKey]&&classDays[dayKey].length?classDays[dayKey]:DAYS_BN);
  if(rtGroups.length)buildRtPreview();
}

function printRoutineNew(){
  var cls=gv('rtCl'),bt=gv('rtBt'),room=g('rtRoom')?g('rtRoom').value.trim():'';
  var label='Class '+cls+(bt&&bt!=='All'?' ('+bt+')':'')+(room?' (Room '+room+')':'');
  var html='<!DOCTYPE html><html><head><meta charset="UTF-8">'
    +'<style>'
    +'*{margin:0;padding:0;box-sizing:border-box}'
    +'body{font-family:Arial,sans-serif;padding:10px}'
    +'h2{text-align:center;font-size:13pt;margin-bottom:2px}'
    +'h3{text-align:center;font-size:9pt;font-weight:normal;margin-bottom:2px}'
    +'.cls-label{text-align:center;font-size:10pt;font-weight:bold;margin-bottom:6px}'
    +'table{width:100%;border-collapse:collapse;margin-bottom:12px;font-size:8pt}'
    +'th{background:#2d3a8c;color:#fff;padding:5px 4px;border:1px solid #1e2a6e;text-align:center;font-size:7.5pt}'
    +'td{border:1px solid #bbb;padding:4px 5px;text-align:center;vertical-align:middle}'
    +'.day-lbl{background:#e8eaff;font-weight:bold;white-space:nowrap}'
    +'td strong{display:block;font-size:7.5pt;color:#1a1a6e}'
    +'@media print{@page{size:A4 landscape;margin:8mm}}'
    +'</style></head><body>'
    +'<h2>UBIQUE Cadet &amp; Defense Academy</h2>'
    +'<h3>501, North Shahjahanpur (01881018320)</h3>'
    +'<div class="cls-label">'+label+'</div>';
  rtGroups.forEach(function(grp){
    if(!grp.days.length)return;
    var times=calcPTimes(grp.start,grp.end,grp.periods);
    html+='<table><thead><tr><th>Day</th>';
    for(var p=0;p<grp.periods;p++)html+='<th>'+times[p]+'</th>';
    html+='</tr></thead><tbody>';
    grp.days.forEach(function(day){
      html+='<tr><td class="day-lbl">'+day+'</td>';
      for(var p=0;p<grp.periods;p++){
        var cellD=grp.grid[day]&&grp.grid[day][p];
        var tid=typeof cellD==='object'?cellD.tch:cellD;
        var sub=typeof cellD==='object'?cellD.sub||'':'';
        var tn=tid?(teachersList.find(function(t){return t.id==tid;})||{}).name||'':'';
        html+='<td>'+(sub?'<strong style="font-size:8pt">'+e(sub)+'</strong><br>':'')+e(tn)+'</td>';
      }
      html+='</tr>';
    });
    html+='</tbody></table><br>';
  });
  html+='</body></html>';
  var w=window.open('','_blank','width=900,height=600');
  w.document.write(html);w.document.close();
  setTimeout(function(){w.focus();w.print();},500);
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PUSH NOTIFICATION SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var notifTarget = 'all';
var EDGE_NOTIF_URL = 'https://sfsrtozgfethgdfrmskk.supabase.co/functions/v1/send-notification';

async function savePlayerToken(){
  try {
    if(!window.median || !median.onesignal) return;
    var pid = await new Promise(function(resolve){
      setTimeout(function(){ resolve(null); }, 5000);
      try {
        median.onesignal.info({callback: function(data){
          // subscription.id is the player ID in new OneSignal model
          var id = null;
          if(data && data.subscription && data.subscription.id) id = data.subscription.id;
          else if(data && data.oneSignalId) id = data.oneSignalId;
          else if(data && data.userId) id = data.userId;
          resolve(id||null);
        }});
      } catch(e){ resolve(null); }
    });
    if(!pid) return;
    var sid = localStorage.getItem('ub_sid');
    var rec = {player_id: pid, updated_at: new Date().toISOString()};
    if(sid) rec.student_id = parseInt(sid);
    var r = await SB.from('push_tokens').upsert([rec],{onConflict:'player_id'});
    if(!r.error) showToast('\u{1F514} Notification ready!');
    console.log('Token saved:', pid);
  } catch(err){ console.log('token save err:', err.message); }
}

async function testOneSignal(){
  try {
    median.onesignal.info({
      callback: function(data){
        var pid = null;
        if(data && data.subscription && data.subscription.id) pid = data.subscription.id;
        else if(data && data.oneSignalId) pid = data.oneSignalId;
        var sid = localStorage.getItem('ub_sid');
        var rec = {player_id: pid, updated_at: new Date().toISOString()};
        if(sid) rec.student_id = parseInt(sid);
        SB.from('push_tokens').upsert([rec],{onConflict:'player_id'}).then(function(r){
          alert('player_id: '+pid+'\nSaved: '+(r.error?'âŒ '+r.error.message:'âœ… OK'));
        });
      }
    });
  } catch(e){ alert('err: '+e.message); }
}

function onAClChange(){
  var cls = gv('aCl');
  var abt = g('aBt');
  if(!abt) return;
  loadS();
  abt.innerHTML = '<option value="All">à¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...</option>';
  var q = SB.from('students').select('batch');
  if(cls && cls!=='All') q = q.eq('class', cls);
  q.limit(1000).then(function(r){
    var batches = [];
    (r.data||[]).forEach(function(s){
      if(s.batch && batches.indexOf(s.batch)===-1) batches.push(s.batch);
    });
    batches.sort();
    abt.innerHTML = '<option value="All">à¦¸à¦¬ à¦¬à§à¦¯à¦¾à¦š</option>'
      + batches.map(function(b){ return '<option value="'+e(b)+'">'+e(b)+'</option>'; }).join('');
  });
}
function onNtClChange(){
  var cls = g('ntCl') ? g('ntCl').value : 'All';
  var ntbt = g('ntBt');
  if(!ntbt) return;
  ntbt.innerHTML = '<option value="All">à¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...</option>';
  var q = SB.from('students').select('batch');
  if(cls && cls!=='All') q = q.eq('class', cls);
  q.limit(1000).then(function(r){
    var batches = [];
    (r.data||[]).forEach(function(s){
      if(s.batch && batches.indexOf(s.batch)===-1) batches.push(s.batch);
    });
    batches.sort();
    ntbt.innerHTML = '<option value="All">à¦¸à¦¬ à¦¬à§à¦¯à¦¾à¦š</option>'
      + batches.map(function(b){ return '<option value="'+e(b)+'">'+e(b)+'</option>'; }).join('');
  });
}
function setNotifTarget(t){
  notifTarget = t;
  var ids = ['ntAll','ntDue','ntCls','ntBatch'];
  ids.forEach(function(id){
    var btn = g(id);
    if(btn) btn.className = 'btn btn-ghost btn-sm';
  });
  var map = {all:'ntAll', due:'ntDue', class:'ntCls', batch:'ntBatch'};
  if(map[t] && g(map[t])) g(map[t]).className = 'btn btn-p btn-sm';
  var cf = g('ntClsFilter');
  if(cf){
    if(t==='class'||t==='batch'){ cf.style.display='flex'; show('ntClsFilter'); }
    else hide('ntClsFilter');
  }
}

function setNotifTemplate(type){
  var templates = {
    fee:     { title:'\u{1F4B0} \u09AB\u09BF \u09AC\u0995\u09C7\u09AF\u09BC\u09BE', msg:'\u0986\u09AA\u09A8\u09BE\u09B0 \u09AE\u09BE\u09B8\u09BF\u0995 \u09AC\u09C7\u09A4\u09A8 \u09AC\u0995\u09C7\u09AF\u09BC\u09BE \u0986\u099B\u09C7\u0964 \u0985\u09A8\u09C1\u0997\u09CD\u09B0\u09B9 \u0995\u09B0\u09C7 \u09A6\u09CD\u09B0\u09C1\u09A4 \u09AA\u09B0\u09BF\u09B6\u09CB\u09A7 \u0995\u09B0\u09C1\u09A8\u0964' },
    exam:    { title:'\u{1F4DD} \u09AA\u09B0\u09C0\u0995\u09CD\u09B7\u09BE\u09B0 \u09A8\u09CB\u099F\u09BF\u09B8', msg:'\u0986\u0997\u09BE\u09AE\u09C0\u0995\u09BE\u09B2 \u09AA\u09B0\u09C0\u0995\u09CD\u09B7\u09BE \u0986\u099B\u09C7\u0964 \u09B8\u0995\u09B2\u0995\u09C7 \u09AF\u09A5\u09BE\u09B8\u09AE\u09AF\u09BC\u09C7 \u0989\u09AA\u09B8\u09CD\u09A5\u09BF\u09A4 \u09A5\u09BE\u0995\u09A4\u09C7 \u09B9\u09AC\u09C7\u0964' },
    result:  { title:'\u{1F4CA} \u09B0\u09C7\u099C\u09BE\u09B2\u09CD\u099F \u09AA\u09CD\u09B0\u0995\u09BE\u09B6\u09BF\u09A4', msg:'\u09AA\u09B0\u09C0\u0995\u09CD\u09B7\u09BE\u09B0 \u09AB\u09B2\u09BE\u09AB\u09B2 \u09AA\u09CD\u09B0\u0995\u09BE\u09B6\u09BF\u09A4 \u09B9\u09AF\u09BC\u09C7\u099B\u09C7\u0964 \u0985\u09CD\u09AF\u09BE\u09AA \u09A5\u09C7\u0995\u09C7 \u09A6\u09C7\u0996\u09C1\u09A8\u0964' },
    notice:  { title:'\u{1F4E2} \u0997\u09C1\u09B0\u09C1\u09A4\u09CD\u09AC\u09AA\u09C2\u09B0\u09CD\u09A3 \u09A8\u09CB\u099F\u09BF\u09B8', msg:'\u098F\u0995\u099F\u09BF \u0997\u09C1\u09B0\u09C1\u09A4\u09CD\u09AC\u09AA\u09C2\u09B0\u09CD\u09A3 \u09A8\u09CB\u099F\u09BF\u09B8 \u09AA\u09CD\u09B0\u0995\u09BE\u09B6\u09BF\u09A4 \u09B9\u09AF\u09BC\u09C7\u099B\u09C7\u0964 \u0985\u09CD\u09AF\u09BE\u09AA \u09A5\u09C7\u0995\u09C7 \u09AC\u09BF\u09B8\u09CD\u09A4\u09BE\u09B0\u09BF\u09A4 \u09A6\u09C7\u0996\u09C1\u09A8\u0964' },
    holiday: { title:'\u{1F3D6}\uFE0F \u099B\u09C1\u099F\u09BF\u09B0 \u09A8\u09CB\u099F\u09BF\u09B8', msg:'\u0986\u0997\u09BE\u09AE\u09C0\u0995\u09BE\u09B2 \u099B\u09C1\u099F\u09BF \u09A5\u09BE\u0995\u09AC\u09C7\u0964 \u0995\u09CB\u09A8\u09CB \u0995\u09CD\u09B2\u09BE\u09B8 \u09B9\u09AC\u09C7 \u09A8\u09BE\u0964' },
    absent:  { title:'\u274C \u0985\u09A8\u09C1\u09AA\u09B8\u09CD\u09A5\u09BF\u09A4\u09BF\u09B0 \u09A8\u09CB\u099F\u09BF\u09B8', msg:'\u0986\u099C \u0995\u09CD\u09B2\u09BE\u09B8\u09C7 \u0985\u09A8\u09C1\u09AA\u09B8\u09CD\u09A5\u09BF\u09A4 \u099B\u09BF\u09B2\u09C7\u09A8\u0964 \u09A8\u09BF\u09AF\u09BC\u09AE\u09BF\u09A4 \u0989\u09AA\u09B8\u09CD\u09A5\u09BF\u09A4 \u09A5\u09BE\u0995\u09C1\u09A8\u0964' }
  };
  var t = templates[type];
  if(t && g('ntTitle') && g('ntMsg')){
    g('ntTitle').value = t.title;
    g('ntMsg').value = t.msg;
  }
  // Show dynamic area for fee template
  var dynArea = g('ntDynArea');
  if(dynArea) dynArea.style.display = (type==='fee') ? 'block' : 'none';
}

async function getTargetPlayerIds(){
  var ids = [];
  if(notifTarget === 'all'){
    var r = await SB.from('push_tokens').select('player_id');
    ids = (r.data||[]).map(function(x){return x.player_id;});
  }
  else if(notifTarget === 'due'){
    await loadFeeData();
    var r2 = await SB.from('students').select('id,admission_month');
    if(r2.data) r2.data.forEach(function(s){stuCache[s.id]=stuCache[s.id]||s;});
    var dueSids = (r2.data||[]).filter(function(s){
      return getDueMonths(s.id).length > 0;
    }).map(function(s){return s.id;});
    if(dueSids.length){
      var r3 = await SB.from('push_tokens').select('player_id').in('student_id', dueSids);
      ids = (r3.data||[]).map(function(x){return x.player_id;});
    }
  }
  else if(notifTarget === 'class' || notifTarget === 'batch'){
    var cls = g('ntCl') ? g('ntCl').value : 'All';
    var bt = g('ntBt') ? g('ntBt').value : 'All';
    var q = SB.from('students').select('id');
    if(cls && cls !== 'All') q = q.eq('class', cls);
    if(bt && bt !== 'All') q = q.eq('batch', bt);
    var r4 = await q;
    var sids = (r4.data||[]).map(function(s){return s.id;});
    if(sids.length){
      var r5 = await SB.from('push_tokens').select('player_id').in('student_id', sids);
      ids = (r5.data||[]).map(function(x){return x.player_id;});
    }
  }
  return ids;
}

async function sendNotification(){
  var title = g('ntTitle') ? g('ntTitle').value.trim() : '';
  var msg = g('ntMsg') ? g('ntMsg').value.trim() : '';
  if(!title||!msg){alert('\u09B6\u09BF\u09B0\u09CB\u09A8\u09BE\u09AE \u0993 \u09AC\u09BE\u09B0\u09CD\u09A4\u09BE \u09A6\u09BF\u09A8!');return;}
  var st = g('ntStatus');
  if(st) st.innerHTML='<span style="color:#6366f1">\u23F3 \u09AA\u09BE\u09A0\u09BE\u09A8\u09CB \u09B9\u099A\u09CD\u099B\u09C7...</span>';
  var playerIds = await getTargetPlayerIds();
  if(!playerIds.length){
    if(st) st.innerHTML='<span style="color:#ef4444">\u274C \u0995\u09CB\u09A8\u09CB device \u09AA\u09BE\u0993\u09AF\u09BC\u09BE \u09AF\u09BE\u09AF\u09BC\u09A8\u09BF!</span>';
    return;
  }
  try {
    var res = await fetch(EDGE_NOTIF_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({playerIds:playerIds, title:title, message:msg})
    });
    var data = await res.json();
    if(data.errors && data.errors.length){
      if(st) st.innerHTML='<span style="color:#ef4444">\u274C Error: '+JSON.stringify(data.errors)+'</span>';
    } else {
      if(st) st.innerHTML='<span style="color:#22c55e">\u2705 '+playerIds.length+' \u099C\u09A8\u0995\u09C7 \u09AA\u09BE\u09A0\u09BE\u09A8\u09CB \u09B9\u09AF\u09BC\u09C7\u099B\u09C7!</span>';
      // save history
      var hist = [];
      try { hist = JSON.parse(localStorage.getItem('ntHist')||'[]'); } catch(e){}
      hist.unshift({title:title, msg:msg, count:playerIds.length, time:new Date().toLocaleString()});
      if(hist.length>20) hist=hist.slice(0,20);
      localStorage.setItem('ntHist', JSON.stringify(hist));
      g('ntTitle').value=''; g('ntMsg').value='';
      renderNotifHistory();
    }
  } catch(err){
    if(st) st.innerHTML='<span style="color:#ef4444">\u274C '+err.message+'</span>';
  }
}

function renderNotifHistory(){
  var el = g('ntHistory');
  if(!el) return;
  var hist = [];
  try { hist = JSON.parse(localStorage.getItem('ntHist')||'[]'); } catch(e){}
  if(!hist.length){
    el.innerHTML='<p style="text-align:center;color:var(--muted);font-size:.78rem;padding:16px">\u0995\u09CB\u09A8\u09CB \u0987\u09A4\u09BF\u09B9\u09BE\u09B8 \u09A8\u09C7\u0987</p>';
    return;
  }
  el.innerHTML = hist.map(function(h){
    return '<div style="background:#f8faff;border-radius:10px;padding:10px 12px;border-left:3px solid #6366f1;margin-bottom:6px">'
      +'<div style="display:flex;justify-content:space-between">'
      +'<strong style="font-size:.8rem">'+e(h.title)+'</strong>'
      +'<span style="font-size:.65rem;color:var(--muted)">'+h.count+' \u099C\u09A8</span>'
      +'</div>'
      +'<p style="font-size:.72rem;color:#555;margin-top:3px">'+e(h.msg)+'</p>'
      +'<p style="font-size:.62rem;color:var(--muted);margin-top:3px">'+h.time+'</p>'
      +'</div>';
  }).join('');
}


async function sendAbsentNotifications(recs){
  try {
    var absentIds = recs.filter(function(r){ return r.status==='Absent'; }).map(function(r){ return r.student_id; });
    if(!absentIds.length) return;
    // Get push tokens for absent students
    var tkR = await SB.from('push_tokens').select('player_id,student_id').in('student_id', absentIds);
    if(!tkR.data || !tkR.data.length) return;
    // Send individual notifications
    var today = new Date();
    var dateStr = today.getDate()+'/'+(today.getMonth()+1)+'/'+today.getFullYear();
    for(var i=0; i<tkR.data.length; i++){
      var tk = tkR.data[i];
      var stu = stuCache[tk.student_id];
      var name = stu ? stu.name : 'à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦¨à§à¦¤à¦¾à¦¨';
      await fetch(EDGE_NOTIF_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          playerIds: [tk.player_id],
          title: 'âŒ à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤à¦¿à¦° à¦¨à§‹à¦Ÿà¦¿à¦¸',
          message: name+' à¦†à¦œ ('+dateStr+') à¦•à§à¦²à¦¾à¦¸à§‡ à¦…à¦¨à§à¦ªà¦¸à§à¦¥à¦¿à¦¤ à¦›à¦¿à¦²à§‡à¦¨à¥¤'
        })
      });
    }
    console.log('Absent notifications sent:', tkR.data.length);
  } catch(err){ console.log('absent notif err:', err); }
}


async function buildDueNotifications(){
  var prev = g('ntDynamicPreview');
  if(prev) prev.innerHTML = '<p style="color:#6366f1;font-size:.75rem">â³ à¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...</p>';

  await loadFeeData();
  var cls = g('ntCl') ? g('ntCl').value : 'All';
  var bt  = g('ntBt') ? g('ntBt').value : 'All';
  var q = SB.from('students').select('*');
  if(cls && cls!=='All') q = q.eq('class', cls);
  if(bt  && bt !=='All') q = q.eq('batch', bt);
  var r = await q.order('roll_no');
  if(!r.data){ if(prev) prev.innerHTML='<p style="color:red">âŒ à¦²à§‹à¦¡ à¦¬à¦¿à¦«à¦²</p>'; return []; }
  r.data.forEach(function(s){ stuCache[s.id]=s; });

  var dueStudents = r.data.filter(function(s){ return getDueMonths(s.id).length > 0; });

  if(prev){
    if(!dueStudents.length){
      prev.innerHTML = '<p style="color:#22c55e;font-size:.75rem">âœ… à¦¬à¦•à§‡à¦¯à¦¼à¦¾ à¦•à§‡à¦‰ à¦¨à§‡à¦‡!</p>';
    } else {
      prev.innerHTML = '<p style="font-size:.72rem;font-weight:700;color:#4f46e5;margin-bottom:6px">'+dueStudents.length+' à¦œà¦¨à§‡à¦° à¦¬à¦•à§‡à¦¯à¦¼à¦¾ à¦†à¦›à§‡:</p>'
        + dueStudents.slice(0,5).map(function(s){
            var months = getDueMonths(s.id);
            return '<div style="font-size:.68rem;padding:4px 8px;background:#fef2f2;border-radius:6px;margin-bottom:3px">'
              +'<strong>'+e(s.name)+'</strong> â€” '+months.length+' à¦®à¦¾à¦¸ ('+months.join(', ')+')'
              +'</div>';
          }).join('')
        + (dueStudents.length>5 ? '<p style="font-size:.65rem;color:var(--muted)">à¦†à¦°à¦“ '+(dueStudents.length-5)+' à¦œà¦¨</p>' : '');
    }
  }
  return dueStudents;
}

</script>
<!-- ATTENDANCE EDIT MODAL -->
<div id="aeModal" style="display:none;position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,.55);align-items:flex-start;justify-content:center;padding:12px;overflow-y:auto">
  <div style="background:#fff;border-radius:20px;width:100%;max-width:480px;margin:auto;box-shadow:0 24px 80px rgba(0,0,0,.25)">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #e0e7ff;position:sticky;top:0;background:#fff;border-radius:20px 20px 0 0;z-index:1">
      <h3 style="font-weight:700;font-size:.95rem;margin:0">âœï¸ à¦¹à¦¾à¦œà¦¿à¦°à¦¾ à¦¸à¦‚à¦¶à§‹à¦§à¦¨</h3>
      <button onclick="closeAttEdit()" style="background:#f1f5f9;border:none;width:28px;height:28px;border-radius:99px;cursor:pointer;font-weight:700">âœ•</button>
    </div>
    <div style="padding:14px 18px;border-bottom:1px solid #f1f5f9;display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input type="date" id="aeDate" class="inp" style="flex:1;min-width:130px">
        <select id="aeCl" class="inp dynC" style="flex:1;min-width:110px"></select>
        <select id="aeBt" class="inp dynB" style="flex:1;min-width:110px"></select>
      </div>
      <button onclick="loadAttEdit()" class="btn btn-p" style="font-size:.8rem">ğŸ” à¦²à§‹à¦¡ à¦•à¦°à§à¦¨</button>
    </div>
    <div id="aeList" style="padding:12px 14px;max-height:55vh;overflow-y:auto;display:flex;flex-direction:column;gap:6px">
      <p style="color:var(--muted);font-size:.8rem;text-align:center;padding:20px">à¦¤à¦¾à¦°à¦¿à¦– à¦“ à¦•à§à¦²à¦¾à¦¸ à¦¬à§‡à¦›à§‡ à¦²à§‹à¦¡ à¦•à¦°à§à¦¨</p>
    </div>
    <div style="padding:12px 18px;border-top:1px solid #f1f5f9;display:flex;gap:8px">
      <button onclick="saveAttEdit()" class="btn btn-p" style="flex:1">ğŸ’¾ à¦¸à¦‚à¦¶à§‹à¦§à¦¨ à¦¸à§‡à¦­ à¦•à¦°à§à¦¨</button>
      <button onclick="closeAttEdit()" class="btn btn-ghost">à¦¬à¦¾à¦¤à¦¿à¦²</button>
    </div>
  </div>
</div>
<style>
.ae-btn{border:none;width:30px;height:30px;border-radius:8px;cursor:pointer;font-size:.85rem;transition:all .15s}
.ae-p{background:#dcfce7;color:#15803d}
.ae-a{background:#fee2e2;color:#dc2626}
.ae-off{background:#f1f5f9;color:#94a3b8}
</style>
<!-- DUE CARD PREVIEW MODAL -->
<div id="dcModal" style="display:none;position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,.6);align-items:flex-start;justify-content:center;padding:12px;overflow-y:auto">
  <div style="background:#fff;border-radius:20px;width:100%;max-width:860px;margin:auto;box-shadow:0 24px 80px rgba(0,0,0,.3)">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #e0e7ff;position:sticky;top:0;background:#fff;border-radius:20px 20px 0 0;z-index:1">
      <div>
        <h3 style="font-weight:700;font-size:.95rem;margin:0">ğŸ–¨ï¸ à¦¬à¦•à§‡à¦¯à¦¼à¦¾ à¦•à¦¾à¦°à§à¦¡ à¦ªà§à¦°à¦¿à¦­à¦¿à¦‰</h3>
        <p id="dcCount" style="font-size:.7rem;color:#64748b;margin:2px 0 0"></p>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="printDueCardsNow()" class="btn btn-p" style="font-size:.75rem">ğŸ–¨ï¸ à¦ªà§à¦°à¦¿à¦¨à§à¦Ÿ à¦•à¦°à§à¦¨</button>
        <button onclick="closeDcModal()" class="btn btn-ghost" style="font-size:.75rem">âœ• à¦¬à¦¨à§à¦§</button>
      </div>
    </div>
    <div style="padding:16px;background:#f1f5f9;border-radius:0 0 20px 20px">
      <div id="dcPreviewBody" style="display:grid;grid-template-columns:1fr 1fr;gap:12px"></div>
    </div>
  </div>
</div>
<style>
.due-card{border:1.5px solid #4f46e5;border-radius:8px;overflow:hidden;background:#fff;font-size:8.5pt;font-family:inherit}
.dc-header{background:#4f46e5;color:#fff;padding:6px 11px;display:flex;justify-content:space-between;align-items:center}
.dc-logo{font-weight:900;font-size:11pt;letter-spacing:2px}
.dc-tag{background:rgba(255,255,255,.2);padding:1px 7px;border-radius:99px;font-size:7pt;font-weight:700}
.dc-body{padding:8px 11px;display:flex;flex-direction:column;gap:4px}
.dc-row{display:flex;align-items:center;gap:6px}
.dc-lbl{font-size:7pt;color:#64748b;min-width:42px;font-weight:700}
.dc-val{font-weight:700;font-size:9pt;color:#1e1b4b}
.dc-due-sec{margin-top:3px}
.dc-months{display:flex;flex-wrap:wrap;gap:3px;margin-top:3px}
.dc-mo{background:#fef3c7;color:#92400e;padding:1px 6px;border-radius:4px;font-size:7pt;font-weight:700;border:1px solid #fde68a}
.dc-total{background:#fef2f2;border-radius:5px;padding:4px 7px;margin-top:4px;display:flex;justify-content:space-between;border:1px solid #fecaca;font-size:8pt}
.dc-num{font-weight:900;color:#dc2626}
.dc-msg{margin-top:5px;font-size:7.5pt;color:#374151;line-height:1.55;background:#f8faff;border-radius:5px;padding:6px 8px;border-left:3px solid #4f46e5}
.dc-footer{background:#f1f5f9;border-top:1px solid #e0e7ff;padding:5px 11px;font-size:7pt;color:#64748b;display:flex;justify-content:space-between}
</style>

<!-- CALL NOTES MODAL -->
<div id="cnModal" style="display:none;position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,.55);align-items:flex-start;justify-content:center;padding:12px;overflow-y:auto">
  <div style="background:#fff;border-radius:20px;width:100%;max-width:500px;margin:auto;box-shadow:0 24px 80px rgba(0,0,0,.25)">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #e0e7ff;position:sticky;top:0;background:#fff;border-radius:20px 20px 0 0;z-index:1">
      <div>
        <h3 style="font-weight:700;font-size:.95rem;margin:0">ğŸ“ à¦•à¦² à¦¨à§‹à¦Ÿ</h3>
        <p id="cnName" style="font-size:.72rem;color:#64748b;margin:2px 0 0"></p>
      </div>
      <button onclick="closeCN()" style="background:#f1f5f9;border:none;width:28px;height:28px;border-radius:99px;cursor:pointer;font-weight:700">âœ•</button>
    </div>
    <div style="padding:14px 18px">
      <textarea id="cnText" class="inp" rows="3" style="resize:none;width:100%;box-sizing:border-box" placeholder="à¦•à¦¥à§‹à¦ªà¦•à¦¥à¦¨à§‡à¦° à¦¸à¦¾à¦°à¦¸à¦‚à¦•à§à¦·à§‡à¦ª à¦²à¦¿à¦–à§à¦¨..."></textarea>
      <button onclick="saveCN()" class="btn btn-p" style="width:100%;margin-top:8px">ğŸ’¾ à¦¨à§‹à¦Ÿ à¦¸à§‡à¦­ à¦•à¦°à§à¦¨</button>
    </div>
    <div id="cnHistory" style="padding:0 18px 16px;display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow-y:auto"></div>
  </div>
</div>


</body>
</html>