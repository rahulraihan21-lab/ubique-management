<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBIQUE Management | Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <header class="bg-indigo-900 text-white shadow-xl p-6">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">UBIQUE Cadet & Defence Academy</h1>
                <p class="text-indigo-200 text-sm italic">‡ß´‡ß¶‡ßß ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶∂‡¶æ‡¶π‡¶ú‡¶æ‡¶π‡¶æ‡¶®‡¶™‡ßÅ‡¶∞, ‡¶¢‡¶æ‡¶ï‡¶æ-‡ßß‡ß®‡ßß‡ß≠</p>
            </div>
            <div class="mt-4 md:mt-0 flex gap-4">
                <select id="batchFilter" onchange="loadStudents()" class="bg-indigo-800 text-white border border-indigo-600 p-2 rounded-xl outline-none text-sm">
                    <option value="All">‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</option>
                    <option value="Cadet 2026">Cadet 2026</option>
                    <option value="Cadet 2027">Cadet 2027</option>
                    <option value="Defence Batch">Defence Batch</option>
                </select>
                <button onclick="loadStudents()" class="bg-indigo-600 hover:bg-indigo-500 p-2 rounded-xl text-sm transition">üîÑ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 mt-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-lg mb-4 text-slate-800 flex items-center">
                        <span class="mr-2">üìÇ</span> ‡¶¨‡¶æ‡¶≤‡ßç‡¶ï ‡¶≠‡¶∞‡ßç‡¶§‡¶ø (CSV ‡¶Ü‡¶™‡¶≤‡ßã‡¶°)
                    </h3>
                    <input type="file" id="csvFileInput" accept=".csv" class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 mb-4">
                    <button onclick="processBulk()" class="w-full bg-slate-900 text-white py-3 rounded-2xl font-bold hover:bg-black shadow-md transition transform active:scale-95">‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <p class="text-[10px] text-gray-400 mt-3 italic text-center leading-tight">‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶ï‡ßç‡¶∞‡¶Æ: name, roll_no, class, batch, phone</p>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-lg mb-4 text-slate-800">üë§ ‡¶è‡¶ï‡¶ï ‡¶≠‡¶∞‡ßç‡¶§‡¶ø</h3>
                    <div class="space-y-3">
                        <input type="text" id="stuName" placeholder="‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition">
                        <input type="number" id="stuRoll" placeholder="‡¶∞‡ßã‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" class="w-full border p-3 rounded-xl">
                        <input type="text" id="stuClass" placeholder="‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ (‡¶â‡¶¶‡¶æ: Class 7)" class="w-full border p-3 rounded-xl">
                        <input type="text" id="stuBatch" placeholder="‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö (‡¶â‡¶¶‡¶æ: Cadet 2026)" class="w-full border p-3 rounded-xl">
                        <input type="text" id="stuPhone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" class="w-full border p-3 rounded-xl">
                        <button onclick="saveSingle()" class="w-full bg-indigo-600 text-white py-3 rounded-2xl font-bold hover:bg-indigo-700 shadow-lg">‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                    <p id="saveMsg" class="mt-3 text-center text-sm font-bold"></p>
                </div>
            </div>

            <div class="lg:col-span-8 bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-xl text-slate-800 mb-6 border-b pb-4">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶ì ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ</h3>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-slate-400 text-xs uppercase tracking-wider border-b">
                                <th class="pb-3 pl-2">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                <th class="pb-3 text-center">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</th>
                                <th class="pb-3 text-right">‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ</th>
                            </tr>
                        </thead>
                        <tbody id="stuListBody" class="divide-y divide-slate-100">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://sfsrtozgfethgdfrmskk.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ds6DYMap76uRiquvQ9a0fQ_rctZqM61';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ‡ßß. ‡¶¨‡¶æ‡¶≤‡ßç‡¶ï ‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç
        async function processBulk() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            if (!file) return alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø CSV ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®");

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split('\n').slice(1);
                const students = rows.filter(r => r.trim()).map(r => {
                    const c = r.split(',');
                    return { name: c[0], roll_no: parseInt(c[1]), class: c[2], batch: c[3], phone: c[4] };
                });

                const { error } = await _supabase.from('students').insert(students);
                if (error) alert("Error: " + error.message);
                else { alert(students.length + " ‡¶ú‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); loadStudents(); }
            };
            reader.readAsText(file, "UTF-8");
        }

        // ‡ß®. ‡¶è‡¶ï‡¶ï ‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
        async function saveSingle() {
            const name = document.getElementById('stuName').value;
            const roll = document.getElementById('stuRoll').value;
            const cls = document.getElementById('stuClass').value;
            const btc = document.getElementById('stuBatch').value;
            const phn = document.getElementById('stuPhone').value;
            const msg = document.getElementById('saveMsg');

            const { error } = await _supabase.from('students').insert([{ name, roll_no: parseInt(roll), class: cls, batch: btc, phone: phn }]);

            if (error) { msg.innerText = "‡¶≠‡ßÅ‡¶≤: " + error.message; msg.className = "text-red-600 font-bold"; }
            else { 
                msg.innerText = "‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ"; 
                msg.className = "text-green-600 font-bold";
                document.querySelectorAll('input').forEach(i => i.value = '');
                loadStudents();
            }
        }

        // ‡ß©. ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ì ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞
        async function loadStudents() {
            const filter = document.getElementById('batchFilter').value;
            const body = document.getElementById('stuListBody');
            body.innerHTML = '<tr><td colspan="3" class="text-center py-20 text-slate-300 italic animate-pulse">‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td></tr>';

            let query = _supabase.from('students').select('*');
            if (filter !== "All") query = query.eq('batch', filter);

            const { data, error } = await query.order('roll_no', { ascending: true });

            if (data) {
                body.innerHTML = data.map(s => `
                    <tr class="hover:bg-indigo-50/50 transition-all">
                        <td class="py-4 pl-2">
                            <div class="font-bold text-slate-800 text-lg">${s.name}</div>
                            <div class="text-[10px] text-slate-400 font-mono">Roll: ${s.roll_no} | Class: ${s.class} | üìû ${s.phone || 'N/A'}</div>
                        </td>
                        <td class="py-4 text-center">
                            <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-bold uppercase">${s.batch}</span>
                        </td>
                        <td class="py-4 text-right">
                            <div class="flex justify-end gap-1">
                                <button onclick="markAttend('${s.name}', 'Present')" class="bg-green-500 text-white w-9 h-9 rounded-xl text-xs font-bold shadow-sm hover:bg-green-600">P</button>
                                <button onclick="markAttend('${s.name}', 'Absent')" class="bg-red-500 text-white w-9 h-9 rounded-xl text-xs font-bold shadow-sm hover:bg-red-600">A</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function markAttend(n, s) { alert(`${n} ‡¶ï‡ßá ${s === 'Present' ? '‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§' : '‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§'} ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§`); }

        window.onload = loadStudents;
    </script>
</body>
</html>
