<script>
    // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Supabase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® (‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá)
    const SUPABASE_URL = 'https://sfsrtozgfethgdfrmskk.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_ds6DYMap76uRiquvQ9a0fQ_rctZqM61';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ‡ßß. ‡¶è‡¶á ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶ü‡¶ø ‡¶∏‡¶¨ ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡¶æ‡¶Æ‡ßü‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶ß‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá
    let attendanceData = {}; 

    // ‡ß®. ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶°)
    async function loadStudents() {
        const batch = document.getElementById('batchFilter').value;
        const listBody = document.getElementById('stuListBody');
        listBody.innerHTML = '<tr><td colspan="3" class="text-center py-10">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td></tr>';

        let query = _supabase.from('students').select('*');
        if (batch !== "All") query = query.eq('batch', batch);

        const { data, error } = await query.order('roll_no', { ascending: true });

        if (data) {
            listBody.innerHTML = data.map(s => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="py-4 pl-2">
                        <div class="font-bold text-slate-800">${s.name}</div>
                        <div class="text-[10px] text-slate-400">‡¶∞‡ßã‡¶≤: ${s.roll_no} | üìû ${s.phone || 'N/A'}</div>
                    </td>
                    <td class="text-center font-semibold text-indigo-600">${s.batch}</td>
                    <td class="py-4 text-right">
                        <div class="flex justify-end gap-2 pr-2">
                            <button id="p-${s.id}" onclick="setAttendance('${s.id}', 'Present')" 
                                class="w-10 h-10 rounded-xl font-bold border-2 border-green-500 text-green-500 transition-all">P</button>
                            <button id="a-${s.id}" onclick="setAttendance('${s.id}', 'Absent')" 
                                class="w-10 h-10 rounded-xl font-bold border-2 border-red-500 text-red-500 transition-all">A</button>
                            <a href="sms:${s.phone}?body=‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶®‡ßç‡¶§‡¶æ‡¶® ‡¶Ü‡¶ú ‡¶á‡¶â‡¶¨‡¶ø‡¶ï ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶§‡ßá ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡•§" 
                               class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center">‚úâÔ∏è</a>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    }

    // ‡ß©. ‡¶™‡¶™-‡¶Ü‡¶™ ‡¶õ‡¶æ‡ßú‡¶æ ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
    function setAttendance(id, status) {
        const pBtn = document.getElementById(`p-${id}`);
        const aBtn = document.getElementById(`a-${id}`);

        if (status === 'Present') {
            // P ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡¶¨‡ßÅ‡¶ú ‡¶π‡¶¨‡ßá, A ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡¶æ‡¶¶‡¶æ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
            pBtn.className = "w-10 h-10 rounded-xl font-bold bg-green-500 text-white shadow-lg scale-110";
            aBtn.className = "w-10 h-10 rounded-xl font-bold border-2 border-red-500 text-red-500";
            attendanceData[id] = 'Present';
        } else {
            // A ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡¶æ‡¶≤ ‡¶π‡¶¨‡ßá, P ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡¶æ‡¶¶‡¶æ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
            aBtn.className = "w-10 h-10 rounded-xl font-bold bg-red-500 text-white shadow-lg scale-110";
            pBtn.className = "w-10 h-10 rounded-xl font-bold border-2 border-green-500 text-green-500";
            attendanceData[id] = 'Absent';
        }
    }

    // ‡ß™. ‡¶è‡¶ï ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï‡ßá ‡¶™‡ßÅ‡¶∞‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡ßá‡¶∞ ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
    async function submitFinalAttendance() {
        const records = Object.keys(attendanceData).map(studentId => ({
            student_id: parseInt(studentId),
            status: attendanceData[studentId],
            attendance_date: new Date().toISOString().split('T')[0]
        }));

        if (records.length === 0) return alert("‡¶Ü‡¶ó‡ßá ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ú‡¶®‡ßá‡¶∞ ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®!");

        const { error } = await _supabase
            .from('attendance')
            .upsert(records, { onConflict: 'student_id, attendance_date' });

        if (error) {
            alert("‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡¶®‡¶ø: " + error.message);
        } else {
            alert("‡¶∏‡¶¨ ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ");
            attendanceData = {}; // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
            loadStudents(); // ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
        }
    }
</script>

<div class="mt-8 text-center pb-10">
    <button onclick="submitFinalAttendance()" class="bg-indigo-700 text-white px-12 py-4 rounded-2xl font-bold shadow-2xl hover:bg-black transition-all">
        ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶π‡¶æ‡¶ú‡¶ø‡¶∞‡¶æ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    </button>
</div>
